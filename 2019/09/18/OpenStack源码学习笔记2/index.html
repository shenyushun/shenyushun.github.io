<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Hi!Roy!"><title>OpenStack源码学习笔记2 - Hi!Roy!</title><meta name="author" content="Roy"><link rel="icon" href="http://www.hi-roy.com/assets/images/favicon.ico"><link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml"><meta name="description" content="上次学习了Nova创建虚拟机的过程，这次来看一下Glance是如何上传镜像的。相比于Nova，Glance源码使用了大量的代理模式和装饰器模式，阅读代码时候一个不仔细就会一脸懵X。根据上次说的Openstack套路，我们通过setup.cfg直奔主题——glance/cmd/api.py:1234567891011121314151617181920212223def main():    try"><meta name="keywords" content="Glance"><meta property="og:type" content="blog"><meta property="og:title" content="OpenStack源码学习笔记2"><meta property="og:url" content="http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/index.html"><meta property="og:site_name" content="Hi!Roy!"><meta property="og:description" content="上次学习了Nova创建虚拟机的过程，这次来看一下Glance是如何上传镜像的。相比于Nova，Glance源码使用了大量的代理模式和装饰器模式，阅读代码时候一个不仔细就会一脸懵X。根据上次说的Openstack套路，我们通过setup.cfg直奔主题——glance/cmd/api.py:1234567891011121314151617181920212223def main():    try"><meta property="og:locale" content="zh-cn"><meta property="og:updated_time" content="2019-09-18T11:04:59.410Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="OpenStack源码学习笔记2"><meta name="twitter:description" content="上次学习了Nova创建虚拟机的过程，这次来看一下Glance是如何上传镜像的。相比于Nova，Glance源码使用了大量的代理模式和装饰器模式，阅读代码时候一个不仔细就会一脸懵X。根据上次说的Openstack套路，我们通过setup.cfg直奔主题——glance/cmd/api.py:1234567891011121314151617181920212223def main():    try"><meta property="og:image" content="http://www.hi-roy.com/assets/images/my.jpg"><link rel="stylesheet" href="/assets/css/style-sxklfps8ywgfyyjcowvnb4gxdgt0zjts3hsguljmv9uqanxjbnitrovtbrek.min.css"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?21513ec2bcd577b3297a1b16da82fa40";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body><div id="blog"><header id="header" data-behavior="4"><i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i><div class="header-title"><a class="header-title-link" href="/">Hi!Roy!</a></div><a class="header-right-icon" href="#about"><i class="fa fa-lg fa-question"></i></a></header><nav id="sidebar" data-behavior="4"><div class="sidebar-container"><div class="sidebar-profile"><a href="/#about"><img class="sidebar-profile-picture" src="/assets/images/my.jpg" alt="作者的图片"></a><h4 class="sidebar-profile-name">Roy</h4><h5 class="sidebar-profile-bio"><p>君以国士待我，我必以国士报君。</p></h5></div><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/"><i class="sidebar-button-icon fa fa-lg fa-home"></i> <span class="sidebar-button-desc">首页</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-categories"><i class="sidebar-button-icon fa fa-lg fa-bookmark"></i> <span class="sidebar-button-desc">分类</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-tags"><i class="sidebar-button-icon fa fa-lg fa-tags"></i> <span class="sidebar-button-desc">标签</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-archives"><i class="sidebar-button-icon fa fa-lg fa-archive"></i> <span class="sidebar-button-desc">归档</span></a></li><li class="sidebar-button"><a class="sidebar-button-link open-algolia-search" href="#search"><i class="sidebar-button-icon fa fa-lg fa-search"></i> <span class="sidebar-button-desc">搜索</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="#about"><i class="sidebar-button-icon fa fa-lg fa-question"></i> <span class="sidebar-button-desc">关于</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="https://github.com/shenyushun" target="_blank" rel="noopener"><i class="sidebar-button-icon fa fa-lg fa-github"></i> <span class="sidebar-button-desc">GitHub</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="mailto:darkcooking@gmail.com" target="_blank" rel="noopener"><i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i> <span class="sidebar-button-desc">邮箱</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/atom.xml"><i class="sidebar-button-icon fa fa-lg fa-rss"></i> <span class="sidebar-button-desc">RSS</span></a></li></ul></div></nav><div id="main" data-behavior="4" class="hasCoverMetaIn"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><div class="post-header main-content-wrap text-left"><h1 class="post-title" itemprop="headline">OpenStack源码学习笔记2</h1><div class="post-meta"><time itemprop="datePublished" datetime="2019-09-18T12:46:29+08:00">9月 18, 2019 </time><span>发布在 </span><a class="category-link" href="/source/all-categories/Python/">Python</a>, <a class="category-link" href="/source/all-categories/Python/OpenStack/">OpenStack</a></div></div><div class="post-content markdown" itemprop="articleBody"><div class="main-content-wrap"><p>上次学习了Nova创建虚拟机的过程，这次来看一下Glance是如何上传镜像的。相比于Nova，Glance源码使用了大量的代理模式和装饰器模式，阅读代码时候一个不仔细就会一脸懵X。根据上次说的Openstack套路，我们通过<code>setup.cfg</code>直奔主题——<code>glance/cmd/api.py</code>:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        config.parse_args()</span><br><span class="line">        config.set_config_defaults()</span><br><span class="line">        wsgi.set_eventlet_hub()</span><br><span class="line">        logging.setup(CONF, <span class="string">'glance'</span>)</span><br><span class="line">        notifier.set_defaults()</span><br><span class="line">        <span class="keyword">if</span> cfg.CONF.profiler.enabled:</span><br><span class="line">            _notifier = osprofiler.notifier.create(<span class="string">"Messaging"</span>,</span><br><span class="line">                                                   oslo_messaging, &#123;&#125;,</span><br><span class="line">                                                   notifier.get_transport(),</span><br><span class="line">                                                   <span class="string">"glance"</span>, <span class="string">"api"</span>,</span><br><span class="line">                                                   cfg.CONF.bind_host)</span><br><span class="line">            osprofiler.notifier.set(_notifier)</span><br><span class="line">            osprofiler.web.enable(cfg.CONF.profiler.hmac_keys)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            osprofiler.web.disable()</span><br><span class="line">        server = wsgi.Server(initialize_glance_store=<span class="literal">True</span>)</span><br><span class="line">        server.start(config.load_paste_app(<span class="string">'glance-api'</span>), default_port=<span class="number">9292</span>)</span><br><span class="line">        server.wait()</span><br><span class="line">    <span class="keyword">except</span> KNOWN_EXCEPTIONS <span class="keyword">as</span> e:</span><br><span class="line">        print(e)</span><br><span class="line">        fail(e)</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="配置加载与路由绑定"><a href="#配置加载与路由绑定" class="headerlink" title="配置加载与路由绑定"></a>配置加载与路由绑定</h2><p>和Nova一样，这个文件主要作用就是加载配置、创建WSGI Server并运行，这里我们注意一下<code>initialize_glance_store=True</code>这里，新版中关于存储的部分已经独立出项目叫做<a href="https://github.com/openstack/glance_store" target="_blank" rel="noopener">glance_store</a>，这里还对这部分进行了初始化，我们跟进<code>glance/common/wsgi.py</code>中：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize_glance_store</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""Initialize glance store."""</span></span><br><span class="line">    glance_store.register_opts(CONF)</span><br><span class="line">    glance_store.create_stores(CONF)</span><br><span class="line">    glance_store.verify_default_store()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span><span class="params">(object)</span>:</span></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, threads=<span class="number">1000</span>, initialize_glance_store=False)</span>:</span></span><br><span class="line">        ......    </span><br><span class="line">        self.initialize_glance_store = initialize_glance_store</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self, application, default_port)</span>:</span></span><br><span class="line">        self.application = application</span><br><span class="line">        self.default_port = default_port</span><br><span class="line">        self.configure()</span><br><span class="line">        self.start_wsgi()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">configure</span><span class="params">(self, old_conf=None, has_changed=None)</span>:</span></span><br><span class="line">        eventlet.wsgi.MAX_HEADER_LINE = CONF.max_header_line</span><br><span class="line">        self.client_socket_timeout = CONF.client_socket_timeout <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">        self.configure_socket(old_conf, has_changed)</span><br><span class="line">        <span class="keyword">if</span> self.initialize_glance_store:</span><br><span class="line">            initialize_glance_store()</span><br></pre></td></tr></table></figure><p>这里我们跟进<code>glance_store/backend.py</code>中：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_stores</span><span class="params">(conf=CONF)</span>:</span></span><br><span class="line">    store_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (store_entry, store_instance) <span class="keyword">in</span> _load_stores(conf):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            schemes = store_instance.get_schemes()</span><br><span class="line">            store_instance.configure(re_raise_bsc=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">except</span> NotImplementedError:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> schemes:</span><br><span class="line">            <span class="keyword">raise</span> exceptions.BackendException(<span class="string">'Unable to register store %s. '</span></span><br><span class="line">                                              <span class="string">'No schemes associated with it.'</span></span><br><span class="line">                                              % store_entry)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            LOG.debug(<span class="string">"Registering store %s with schemes %s"</span>,</span><br><span class="line">                      store_entry, schemes)</span><br><span class="line">            scheme_map = &#123;&#125;</span><br><span class="line">            loc_cls = store_instance.get_store_location_class()</span><br><span class="line">            <span class="keyword">for</span> scheme <span class="keyword">in</span> schemes:</span><br><span class="line">                scheme_map[scheme] = &#123;</span><br><span class="line">                    <span class="string">'store'</span>: store_instance,</span><br><span class="line">                    <span class="string">'location_class'</span>: loc_cls,</span><br><span class="line">                    <span class="string">'store_entry'</span>: store_entry</span><br><span class="line">                &#125;</span><br><span class="line">            location.register_scheme_map(scheme_map)</span><br><span class="line">            store_count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> store_count</span><br></pre></td></tr></table></figure><p>在这里会根据<code>/etc/glance/glance_api.conf</code>中的配置信息找到对应的driver(位于<code>glance_store/_drivers</code>目录)并配置，然后调用<code>register_scheme_map()</code>进行绑定：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SCHEME_TO_CLS_MAP = &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_scheme_map</span><span class="params">(scheme_map)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> (k, v) <span class="keyword">in</span> scheme_map.items():</span><br><span class="line">        LOG.debug(<span class="string">"Registering scheme %s with %s"</span>, k, v)</span><br><span class="line">        SCHEME_TO_CLS_MAP[k] = v</span><br></pre></td></tr></table></figure><p>这样就完成了所需的准备工作。</p><h2 id="镜像上传"><a href="#镜像上传" class="headerlink" title="镜像上传"></a>镜像上传</h2><p>glance镜像上传分为2个步骤，首先在数据库中创建一条记录，并返回相关信息，此时使用<code>glance image-list</code>命令可以查看到一个空镜像，状态为<code>queued</code>。然后再上传镜像数据，上传完成后进入<code>active</code>状态，代码均来源于rocky版。</p><h3 id="create"><a href="#create" class="headerlink" title="create"></a>create</h3><p>根据<a href="https://docs.openstack.org/api-ref/image/v2/index.html?expanded=create-image-detail#create-image" target="_blank" rel="noopener">文档</a>创建镜像是向<code>/v2/images</code>发送POST请求，然后再结合<code>glance-api-paste.ini</code>中的定义：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[pipeline:glance-api]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors healthcheck http_proxy_to_wsgi versionnegotiation osprofiler unauthenticated-context rootapp</span><br><span class="line"></span><br><span class="line"><span class="section">[composite:rootapp]</span></span><br><span class="line"><span class="attr">paste.composite_factory</span> = glance.api:root_app_factory</span><br><span class="line">/: apiversions</span><br><span class="line">/v1: apiv1app</span><br><span class="line">/v2: apiv2app</span><br><span class="line"></span><br><span class="line"><span class="section">[app:apiversions]</span></span><br><span class="line"><span class="attr">paste.app_factory</span> = glance.api.versions:create_resource</span><br><span class="line"></span><br><span class="line"><span class="section">[app:apiv1app]</span></span><br><span class="line"><span class="attr">paste.app_factory</span> = glance.api.v1.router:API.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[app:apiv2app]</span></span><br><span class="line"><span class="attr">paste.app_factory</span> = glance.api.v2.router:API.factory</span><br></pre></td></tr></table></figure><p>根据<code>glance/api/v2/router.py</code>中的<code>API()</code>定义，找到实际处理post请求的函数为<code>glance/api/v2/images.py</code>中的<code>ImagesController</code>类的<code>create</code>方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, req, image, extra_properties, tags)</span>:</span></span><br><span class="line">        image_factory = self.gateway.get_image_factory(req.context)</span><br><span class="line">        image_repo = self.gateway.get_repo(req.context)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            image = image_factory.new_image(extra_properties=extra_properties,</span><br><span class="line">                                            tags=tags, **image)</span><br><span class="line">            image_repo.add(image)</span><br><span class="line">        <span class="keyword">except</span> (exception.DuplicateLocation,</span><br><span class="line">                exception.Invalid) <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> webob.exc.HTTPBadRequest(explanation=e.msg)</span><br><span class="line">        <span class="keyword">except</span> (exception.ReservedProperty,</span><br><span class="line">                exception.ReadonlyProperty) <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> webob.exc.HTTPForbidden(explanation=e.msg)</span><br><span class="line">        <span class="keyword">except</span> exception.Forbidden <span class="keyword">as</span> e:</span><br><span class="line">            LOG.debug(<span class="string">"User not permitted to create image"</span>)</span><br><span class="line">            <span class="keyword">raise</span> webob.exc.HTTPForbidden(explanation=e.msg)</span><br><span class="line">        <span class="keyword">except</span> exception.LimitExceeded <span class="keyword">as</span> e:</span><br><span class="line">            LOG.warn(encodeutils.exception_to_unicode(e))</span><br><span class="line">            <span class="keyword">raise</span> webob.exc.HTTPRequestEntityTooLarge(</span><br><span class="line">                explanation=e.msg, request=req, content_type=<span class="string">'text/plain'</span>)</span><br><span class="line">        <span class="keyword">except</span> exception.Duplicate <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> webob.exc.HTTPConflict(explanation=e.msg)</span><br><span class="line">        <span class="keyword">except</span> exception.NotAuthenticated <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> webob.exc.HTTPUnauthorized(explanation=e.msg)</span><br><span class="line">        <span class="keyword">except</span> TypeError <span class="keyword">as</span> e:</span><br><span class="line">            LOG.debug(encodeutils.exception_to_unicode(e))</span><br><span class="line">            <span class="keyword">raise</span> webob.exc.HTTPBadRequest(explanation=e)</span><br><span class="line">        <span class="keyword">return</span> image</span><br></pre></td></tr></table></figure><p>这段代码看上简单，实际内含玄机，如果跟进<code>gateway.get_image_factory</code>和<code>gateway.get_repo</code>函数，会发现作者用了大量的装饰器模式和代理模式：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># glance/gateway.py</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_image_factory</span><span class="params">(self, context)</span>:</span></span><br><span class="line">    image_factory = glance.domain.ImageFactory()</span><br><span class="line">    store_image_factory = glance.location.ImageFactoryProxy(</span><br><span class="line">        image_factory, context, self.store_api, self.store_utils)</span><br><span class="line">    quota_image_factory = glance.quota.ImageFactoryProxy(</span><br><span class="line">        store_image_factory, context, self.db_api, self.store_utils)</span><br><span class="line">    policy_image_factory = policy.ImageFactoryProxy(</span><br><span class="line">        quota_image_factory, context, self.policy)</span><br><span class="line">    notifier_image_factory = glance.notifier.ImageFactoryProxy(</span><br><span class="line">        policy_image_factory, context, self.notifier)</span><br><span class="line">    <span class="keyword">if</span> property_utils.is_property_protection_enabled():</span><br><span class="line">        property_rules = property_utils.PropertyRules(self.policy)</span><br><span class="line">        pif = property_protections.ProtectedImageFactoryProxy(</span><br><span class="line">            notifier_image_factory, context, property_rules)</span><br><span class="line">        authorized_image_factory = authorization.ImageFactoryProxy(</span><br><span class="line">            pif, context)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        authorized_image_factory = authorization.ImageFactoryProxy(</span><br><span class="line">            notifier_image_factory, context)</span><br><span class="line">    <span class="keyword">return</span> authorized_image_factory</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_repo</span><span class="params">(self, context)</span>:</span></span><br><span class="line">    image_repo = glance.db.ImageRepo(context, self.db_api)</span><br><span class="line">    store_image_repo = glance.location.ImageRepoProxy(</span><br><span class="line">        image_repo, context, self.store_api, self.store_utils)</span><br><span class="line">    quota_image_repo = glance.quota.ImageRepoProxy(</span><br><span class="line">        store_image_repo, context, self.db_api, self.store_utils)</span><br><span class="line">    policy_image_repo = policy.ImageRepoProxy(</span><br><span class="line">        quota_image_repo, context, self.policy)</span><br><span class="line">    notifier_image_repo = glance.notifier.ImageRepoProxy(</span><br><span class="line">        policy_image_repo, context, self.notifier)</span><br><span class="line">    <span class="keyword">if</span> property_utils.is_property_protection_enabled():</span><br><span class="line">        property_rules = property_utils.PropertyRules(self.policy)</span><br><span class="line">        pir = property_protections.ProtectedImageRepoProxy(</span><br><span class="line">            notifier_image_repo, context, property_rules)</span><br><span class="line">        authorized_image_repo = authorization.ImageRepoProxy(</span><br><span class="line">            pir, context)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        authorized_image_repo = authorization.ImageRepoProxy(</span><br><span class="line">            notifier_image_repo, context)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> authorized_image_repo</span><br></pre></td></tr></table></figure><p>阅读这里的时候一个不仔细逻辑就断了，要像剥洋葱一样，一层一层剥开它的心。这里我就不记录追踪细节了，经过一层层判断后，<code>image_factory.new_image</code>函数最终进入<code>glance/domain/__init__.py</code>中并返回了一个<code>Image</code>类型实例。</p><p>然后将这个实例传递给<code>image_repo.add</code>函数，这个函数再经过一层层判断，进入<code>glance/db/__init__.py</code>中调用<code>ImageRepo</code>的<code>add()</code>方法，在这个方法中最终调用了<code>glance/db/sqlalchemy/api.py</code>中的<code>image_create()</code>函数来在数据库中创建新记录。</p><p>如果没有发生错误，则返回创建的空镜像信息给客户端。</p><h3 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h3><p><a href="https://docs.openstack.org/api-ref/image/v2/?expanded=upload-binary-image-data-detail#upload-binary-image-data" target="_blank" rel="noopener">文档</a>中定义，上传数据行为是向<code>/v2/images/{image_id}/file</code>发送PUT请求，实际处理函数为<code>glance/api/v2/image_data.py</code>中的<code>ImageDataController</code>类的<code>upload</code>方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="meta">@utils.mutating</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">(self, req, image_id, data, size)</span>:</span></span><br><span class="line">    backend = <span class="literal">None</span></span><br><span class="line">    image_repo = self.gateway.get_repo(req.context)</span><br><span class="line">    image = <span class="literal">None</span></span><br><span class="line">    refresher = <span class="literal">None</span></span><br><span class="line">    cxt = req.context</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        self.policy.enforce(cxt, <span class="string">'upload_image'</span>, &#123;&#125;)</span><br><span class="line">        image = image_repo.get(image_id)</span><br><span class="line">        image.status = <span class="string">'saving'</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            image_repo.save(image, from_state=<span class="string">'queued'</span>)</span><br><span class="line">            image.set_data(data, size, backend=backend)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                image_repo.save(image, from_state=<span class="string">'saving'</span>)</span><br><span class="line">            <span class="keyword">except</span> exception.NotAuthenticated:</span><br><span class="line">                <span class="keyword">if</span> refresher <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    <span class="comment"># request a new token to update an image in database</span></span><br><span class="line">                    cxt.auth_token = refresher.refresh_token()</span><br><span class="line">                    image_repo = self.gateway.get_repo(req.context)</span><br><span class="line">                    image_repo.save(image, from_state=<span class="string">'saving'</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">raise</span></span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p>新版本中glance已经可以支持多后端的配置，但还不是稳定版。这里以单后端为例，首先将状态改为saving，然后调用<code>set_data</code>函数。由于某些不可描述的原因，我没法启动程序进行单步调试，只能使用IDE的跳转功能，结果这里兜兜转转饶了很久。这里我就直接给出答案吧，最终调用的是<code>glance/location.py</code>的<code>ImageProxy</code>类中的方法。这里面的关键点在于image其实是由<code>ImageProxy</code>实例代理的，转换发生在初始化对象时候创建的<code>Helper</code>类，这个类有一个<code>proxy</code>方法用来将原始<code>Image</code>类型转换成<code>ImageProxy</code>类型。这里具体就不再详细说明了，回到<code>set_data</code>函数定义：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_data</span><span class="params">(self, data, size=None, backend=None)</span>:</span></span><br><span class="line">    ......</span><br><span class="line">    hashing_algo = CONF[<span class="string">'hashing_algorithm'</span>]</span><br><span class="line">    <span class="keyword">if</span> CONF.enabled_backends:</span><br><span class="line">        (location, size, checksum,</span><br><span class="line">            multihash, loc_meta) = self.store_api.add_with_multihash(</span><br><span class="line">            CONF,</span><br><span class="line">            self.image.image_id,</span><br><span class="line">            utils.LimitingReader(utils.CooperativeReader(data),</span><br><span class="line">                                    CONF.image_size_cap),</span><br><span class="line">            size,</span><br><span class="line">            backend,</span><br><span class="line">            hashing_algo,</span><br><span class="line">            context=self.context,</span><br><span class="line">            verifier=verifier)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        (location, size, checksum,</span><br><span class="line">            multihash, loc_meta) = self.store_api.add_to_backend_with_multihash(</span><br><span class="line">            CONF,</span><br><span class="line">            self.image.image_id,</span><br><span class="line">            utils.LimitingReader(utils.CooperativeReader(data),</span><br><span class="line">                                    CONF.image_size_cap),</span><br><span class="line">            size,</span><br><span class="line">            hashing_algo,</span><br><span class="line">            context=self.context,</span><br><span class="line">            verifier=verifier)</span><br><span class="line"></span><br><span class="line">    self.image.locations = [&#123;<span class="string">'url'</span>: location, <span class="string">'metadata'</span>: loc_meta, <span class="string">'status'</span>: <span class="string">'active'</span>&#125;]</span><br><span class="line">    self.image.size = size</span><br><span class="line">    self.image.checksum = checksum</span><br><span class="line">    self.image.os_hash_value = multihash</span><br><span class="line">    self.image.os_hash_algo = hashing_algo</span><br><span class="line">    self.image.status = <span class="string">'active'</span></span><br></pre></td></tr></table></figure><p>这里的<code>store_api</code>默认就是<code>glance_store</code>了，其中<code>add_with_multihash</code>是启用多后端时候调用，<code>add_to_backend_with_multihash</code>启用单后端时候调用。这里以单后端为例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_to_backend_with_multihash</span><span class="params">(conf, image_id, data, size, hashing_algo,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  scheme=None, context=None, verifier=None)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> scheme <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        scheme = conf[<span class="string">'glance_store'</span>][<span class="string">'default_store'</span>]</span><br><span class="line">    store = get_store_from_scheme(scheme)</span><br><span class="line">    <span class="keyword">return</span> store_add_to_backend_with_multihash(</span><br><span class="line">        image_id, data, size, hashing_algo, store, context, verifier)</span><br></pre></td></tr></table></figure><p>其中<code>get_store_from_scheme</code>函数作用是获取到文章开头所说的绑定到<code>SCHEME_TO_CLS_MAP</code>中的对应的<code>driver</code>，然后经过<code>store_add_to_backend_with_multihash</code>函数进入相应的<code>driver</code>的<code>add</code>方法，这里以Ceph的块存储RBD(RADOS Block Device)为例，函数位于<code>glance_store/_drivers/rbd.py</code>:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@driver.back_compat_add</span></span><br><span class="line"><span class="meta">@capabilities.check</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(self, image_id, image_file, image_size, hashing_algo, context=None,</span></span></span><br><span class="line"><span class="function"><span class="params">        verifier=None)</span>:</span></span><br><span class="line">    checksum = hashlib.md5()</span><br><span class="line">    os_hash_value = hashlib.new(str(hashing_algo))</span><br><span class="line">    image_name = str(image_id)</span><br><span class="line">    <span class="keyword">with</span> self.get_connection(conffile=self.conf_file,</span><br><span class="line">                             rados_id=self.user) <span class="keyword">as</span> conn:</span><br><span class="line">        fsid = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> hasattr(conn, <span class="string">'get_fsid'</span>):</span><br><span class="line">            fsid = encodeutils.safe_decode(conn.get_fsid())</span><br><span class="line">        <span class="keyword">with</span> conn.open_ioctx(self.pool) <span class="keyword">as</span> ioctx:</span><br><span class="line">            order = int(math.log(self.WRITE_CHUNKSIZE, <span class="number">2</span>))</span><br><span class="line">            LOG.debug(<span class="string">'creating image %s with order %d and size %d'</span>,</span><br><span class="line">                      image_name, order, image_size)</span><br><span class="line">            <span class="keyword">if</span> image_size == <span class="number">0</span>:</span><br><span class="line">                LOG.warning(_(<span class="string">"since image size is zero we will be doing "</span></span><br><span class="line">                              <span class="string">"resize-before-write for each chunk which "</span></span><br><span class="line">                              <span class="string">"will be considerably slower than normal"</span>))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                loc = self._create_image(fsid, conn, ioctx, image_name,</span><br><span class="line">                                         image_size, order)</span><br><span class="line">            <span class="keyword">except</span> rbd.ImageExists:</span><br><span class="line">                msg = _(<span class="string">'RBD image %s already exists'</span>) % image_id</span><br><span class="line">                <span class="keyword">raise</span> exceptions.Duplicate(message=msg)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> rbd.Image(ioctx, image_name) <span class="keyword">as</span> image:</span><br><span class="line">                    bytes_written = <span class="number">0</span></span><br><span class="line">                    offset = <span class="number">0</span></span><br><span class="line">                    chunks = utils.chunkreadable(image_file,</span><br><span class="line">                                                 self.WRITE_CHUNKSIZE)</span><br><span class="line">                    <span class="keyword">for</span> chunk <span class="keyword">in</span> chunks:</span><br><span class="line">                        <span class="comment"># If the image size provided is zero we need to do</span></span><br><span class="line">                        <span class="comment"># a resize for the amount we are writing. This will</span></span><br><span class="line">                        <span class="comment"># be slower so setting a higher chunk size may</span></span><br><span class="line">                        <span class="comment"># speed things up a bit.</span></span><br><span class="line">                        <span class="keyword">if</span> image_size == <span class="number">0</span>:</span><br><span class="line">                            chunk_length = len(chunk)</span><br><span class="line">                            length = offset + chunk_length</span><br><span class="line">                            bytes_written += chunk_length</span><br><span class="line">                            LOG.debug(_(<span class="string">"resizing image to %s KiB"</span>) %</span><br><span class="line">                                      (length / units.Ki))</span><br><span class="line">                            image.resize(length)</span><br><span class="line">                        LOG.debug(_(<span class="string">"writing chunk at offset %s"</span>) %</span><br><span class="line">                                  (offset))</span><br><span class="line">                        offset += image.write(chunk, offset)</span><br><span class="line">                        os_hash_value.update(chunk)</span><br><span class="line">                        checksum.update(chunk)</span><br><span class="line">                        <span class="keyword">if</span> verifier:</span><br><span class="line">                            verifier.update(chunk)</span><br><span class="line">                    <span class="keyword">if</span> loc.snapshot:</span><br><span class="line">                        image.create_snap(loc.snapshot)</span><br><span class="line">                        image.protect_snap(loc.snapshot)</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> image_size == <span class="number">0</span>:</span><br><span class="line">        image_size = bytes_written</span><br><span class="line">    metadata = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> self.backend_group:</span><br><span class="line">        metadata[<span class="string">'store'</span>] = <span class="string">u"%s"</span> % self.backend_group</span><br><span class="line">    <span class="keyword">return</span> (loc.get_uri(),</span><br><span class="line">            image_size,</span><br><span class="line">            checksum.hexdigest(),</span><br><span class="line">            os_hash_value.hexdigest(),</span><br><span class="line">            metadata)</span><br></pre></td></tr></table></figure><p>这个函数首先计算hash值，然后创建连接，再判断镜像是否存在，不存在则上传，然后将数据返回给调用者。最后glance中修改状态为active，整个镜像上传过程就结束了。</p></div></div><div id="post-footer" class="post-footer main-content-wrap"><div class="post-footer-tags"><span class="text-color-light text-small">标签</span><br><a class="tag tag--primary tag--small t-link" href="/source/all-tags/Glance/">Glance</a></div><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2019/10/08/设计模式-总览/" data-tooltip="设计模式-总览"><i class="fa fa-angle-left"></i> <span class="hide-xs hide-sm text-small icon-ml">上一篇</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2019/09/16/OpenStack源码学习笔记1/" data-tooltip="OpenStack源码学习笔记1"><span class="hide-xs hide-sm text-small icon-mr">下一篇</span> <i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions"><i class="fa fa-share-alt"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-facebook-official"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-twitter"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-google-plus"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-weibo"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/&amp;title=OpenStack源码学习笔记2"><i class="fa fa-qq"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-star"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://widget.renren.com/dialog/share?resourceUrl=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-renren"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#"><i class="fa fa-list"></i></a></li></ul></div></div></article><footer id="footer" class="main-content-wrap"><span class="copyrights">Copyrights &copy; 2019 Roy. All Rights Reserved.</span></footer></div><div id="bottom-bar" class="post-bottom-bar" data-behavior="4"><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2019/10/08/设计模式-总览/" data-tooltip="设计模式-总览"><i class="fa fa-angle-left"></i> <span class="hide-xs hide-sm text-small icon-ml">上一篇</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2019/09/16/OpenStack源码学习笔记1/" data-tooltip="OpenStack源码学习笔记1"><span class="hide-xs hide-sm text-small icon-mr">下一篇</span> <i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions"><i class="fa fa-share-alt"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-facebook-official"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-twitter"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-google-plus"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-weibo"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/&amp;title=OpenStack源码学习笔记2"><i class="fa fa-qq"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-star"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://widget.renren.com/dialog/share?resourceUrl=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-renren"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#"><i class="fa fa-list"></i></a></li></ul></div></div><div id="share-options-bar" class="share-options-bar" data-behavior="4"><i id="btn-close-shareoptions" class="fa fa-close"></i><ul class="share-options"><li class="share-option"><a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-facebook-official"></i><span>分享到 Facebook</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-twitter"></i><span>分享到 Twitter</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-google-plus"></i><span>分享到 Google+</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://service.weibo.com/share/share.php?&amp;title=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-weibo"></i><span>分享到 Weibo</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/&amp;title=OpenStack源码学习笔记2"><i class="fa fa-qq"></i><span>分享到 QQ</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-star"></i><span>分享到 Qzone</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://widget.renren.com/dialog/share?resourceUrl=http://www.hi-roy.com/2019/09/18/OpenStack源码学习笔记2/"><i class="fa fa-renren"></i><span>分享到 Renren</span></a></li></ul></div></div><div id="about"><div id="about-card"><div id="about-btn-close"><i class="fa fa-remove"></i></div><img id="about-card-picture" src="/assets/images/my.jpg" alt="作者的图片"><h4 id="about-card-name">Roy</h4><div id="about-card-bio"><p>君以国士待我，我必以国士报君。</p></div><div id="about-card-job"><i class="fa fa-briefcase"></i><br><p>野生程序猿</p></div><div id="about-card-location"><i class="fa fa-map-marker"></i><br>China</div></div></div><div id="algolia-search-modal" class="modal-container"><div class="modal"><div class="modal-header"><span class="close-button"><i class="fa fa-close"></i></span> <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled"><span class="searchby-algolia-text text-color-light text-small">by</span> <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg"> </a><i class="search-icon fa fa-search"></i><form id="algolia-search-form"><input type="text" id="algolia-search-input" name="search" class="form-control input--large search-input" placeholder="Search "></form></div><div class="modal-body"><div class="no-result text-color-light text-center">没有找到文章</div><div class="results"><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/02/12/Ubuntu下Gogant的简易破墙术/"><h3 class="media-heading">Ubuntu下Gogant的简易破墙术</h3></a><span class="media-meta"><span class="media-date text-small">2013年2月12日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/10/31/python常用第三方库-转载/"><h3 class="media-heading">Python常用第三方库(转载)</h3></a><span class="media-meta"><span class="media-date text-small">2013年10月31日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/fedora19安装ar8161网卡驱动/"><h3 class="media-heading">fedora19安装ar8161网卡驱动</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/fedora19源，rpmforge，fastestmirror/"><h3 class="media-heading">fedora19源，rpmforge，fastestmirror</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/python中如何自定义解析域名/"><h3 class="media-heading">python中如何自定义解析域名</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/django版本更换/"><h3 class="media-heading">django版本更换</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/django-groundwork个人1-5-3修改版/"><h3 class="media-heading">django-groundwork个人1.5.3修改版</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/fedora19美化/"><h3 class="media-heading">fedora19美化</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/装饰器/"><h3 class="media-heading">装饰器</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/SVN常用操作/"><h3 class="media-heading">SVN常用操作</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div></div></div><div class="modal-footer"><p class="results-count text-medium" data-message-zero="没有找到文章" data-message-one="找到 1 篇文章" data-message-other="找到 {n} 篇文章">找到 224 篇文章</p></div></div></div><div id="cover" style="background-image:url(/assets/images/cover.jpg)"></div><script src="/assets/js/script-ivwiy10zeb8fifc4swnhkwneuk64y53w2scmdmtp8thi9cqfxh31aowtroaz.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment-with-locales.min.js"></script><script src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script><script>var algoliaClient=algoliasearch("51U8PIBLP6","16909d9ce1780cda71113841864e7aa8"),algoliaIndex=algoliaClient.initIndex("my-blog")</script></body></html>