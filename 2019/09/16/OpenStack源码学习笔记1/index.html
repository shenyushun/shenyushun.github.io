<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Hi!Roy!"><title>OpenStack源码学习笔记1 - Hi!Roy!</title><meta name="author" content="Roy"><link rel="icon" href="http://www.hi-roy.com/assets/images/favicon.ico"><link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml"><meta name="description" content="预备知识虚拟化WSGIPaste Deployment通用套路配置加载与路由绑定创建虚拟机Nova-ApiNova-Conductor-1Nova-SchedulerNova-Conductor-2Nova-Compute作为已经比较成熟的IAAS开源解决方案，OpenStack已经发布了19个版本，目前稳定版是Stein，并且下一个版本Train也预计在10月发布。可以说，从代码架构角度来说对于"><meta name="keywords" content="Nova"><meta property="og:type" content="blog"><meta property="og:title" content="OpenStack源码学习笔记1"><meta property="og:url" content="http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/index.html"><meta property="og:site_name" content="Hi!Roy!"><meta property="og:description" content="预备知识虚拟化WSGIPaste Deployment通用套路配置加载与路由绑定创建虚拟机Nova-ApiNova-Conductor-1Nova-SchedulerNova-Conductor-2Nova-Compute作为已经比较成熟的IAAS开源解决方案，OpenStack已经发布了19个版本，目前稳定版是Stein，并且下一个版本Train也预计在10月发布。可以说，从代码架构角度来说对于"><meta property="og:locale" content="zh-cn"><meta property="og:image" content="https://mypic-1252424367.cos.ap-hongkong.myqcloud.com/opstack/openstack-arch-kilo-logical-v1.png"><meta property="og:image" content="https://mypic-1252424367.cos.ap-hongkong.myqcloud.com/opstack/qemu-kvm.png"><meta property="og:updated_time" content="2019-09-17T09:52:54.381Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="OpenStack源码学习笔记1"><meta name="twitter:description" content="预备知识虚拟化WSGIPaste Deployment通用套路配置加载与路由绑定创建虚拟机Nova-ApiNova-Conductor-1Nova-SchedulerNova-Conductor-2Nova-Compute作为已经比较成熟的IAAS开源解决方案，OpenStack已经发布了19个版本，目前稳定版是Stein，并且下一个版本Train也预计在10月发布。可以说，从代码架构角度来说对于"><meta name="twitter:image" content="https://mypic-1252424367.cos.ap-hongkong.myqcloud.com/opstack/openstack-arch-kilo-logical-v1.png"><meta property="og:image" content="http://www.hi-roy.com/assets/images/my.jpg"><link rel="stylesheet" href="/assets/css/style-sxklfps8ywgfyyjcowvnb4gxdgt0zjts3hsguljmv9uqanxjbnitrovtbrek.min.css"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?21513ec2bcd577b3297a1b16da82fa40";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body><div id="blog"><header id="header" data-behavior="4"><i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i><div class="header-title"><a class="header-title-link" href="/">Hi!Roy!</a></div><a class="header-right-icon" href="#about"><i class="fa fa-lg fa-question"></i></a></header><nav id="sidebar" data-behavior="4"><div class="sidebar-container"><div class="sidebar-profile"><a href="/#about"><img class="sidebar-profile-picture" src="/assets/images/my.jpg" alt="作者的图片"></a><h4 class="sidebar-profile-name">Roy</h4><h5 class="sidebar-profile-bio"><p>君以国士待我，我必以国士报君。</p></h5></div><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/"><i class="sidebar-button-icon fa fa-lg fa-home"></i> <span class="sidebar-button-desc">首页</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-categories"><i class="sidebar-button-icon fa fa-lg fa-bookmark"></i> <span class="sidebar-button-desc">分类</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-tags"><i class="sidebar-button-icon fa fa-lg fa-tags"></i> <span class="sidebar-button-desc">标签</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-archives"><i class="sidebar-button-icon fa fa-lg fa-archive"></i> <span class="sidebar-button-desc">归档</span></a></li><li class="sidebar-button"><a class="sidebar-button-link open-algolia-search" href="#search"><i class="sidebar-button-icon fa fa-lg fa-search"></i> <span class="sidebar-button-desc">搜索</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="#about"><i class="sidebar-button-icon fa fa-lg fa-question"></i> <span class="sidebar-button-desc">关于</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="https://github.com/shenyushun" target="_blank" rel="noopener"><i class="sidebar-button-icon fa fa-lg fa-github"></i> <span class="sidebar-button-desc">GitHub</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="mailto:darkcooking@gmail.com" target="_blank" rel="noopener"><i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i> <span class="sidebar-button-desc">邮箱</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/atom.xml"><i class="sidebar-button-icon fa fa-lg fa-rss"></i> <span class="sidebar-button-desc">RSS</span></a></li></ul></div></nav><div id="main" data-behavior="4" class="hasCoverMetaIn"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><div class="post-header main-content-wrap text-left"><h1 class="post-title" itemprop="headline">OpenStack源码学习笔记1</h1><div class="post-meta"><time itemprop="datePublished" datetime="2019-09-16T17:46:29+08:00">9月 16, 2019 </time><span>发布在 </span><a class="category-link" href="/source/all-categories/Python/">Python</a>, <a class="category-link" href="/source/all-categories/Python/OpenStack/">OpenStack</a></div></div><div class="post-content markdown" itemprop="articleBody"><div class="main-content-wrap"><ul><li><a href="#%e9%a2%84%e5%a4%87%e7%9f%a5%e8%af%86">预备知识</a><ul><li><a href="#%e8%99%9a%e6%8b%9f%e5%8c%96">虚拟化</a></li><li><a href="#wsgi">WSGI</a></li><li><a href="#paste-deployment">Paste Deployment</a></li></ul></li><li><a href="#%e9%80%9a%e7%94%a8%e5%a5%97%e8%b7%af">通用套路</a></li><li><a href="#%e9%85%8d%e7%bd%ae%e5%8a%a0%e8%bd%bd%e4%b8%8e%e8%b7%af%e7%94%b1%e7%bb%91%e5%ae%9a">配置加载与路由绑定</a></li><li><a href="#%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba">创建虚拟机</a><ul><li><a href="#nova-api">Nova-Api</a></li><li><a href="#nova-conductor-1">Nova-Conductor-1</a></li><li><a href="#nova-scheduler">Nova-Scheduler</a></li><li><a href="#nova-conductor-2">Nova-Conductor-2</a></li><li><a href="#nova-compute">Nova-Compute</a></li></ul></li></ul><p>作为已经比较成熟的IAAS开源解决方案，OpenStack已经发布了19个版本，目前稳定版是Stein，并且下一个版本Train也预计在10月发布。可以说，从代码架构角度来说对于初学者来说已经略微复杂，但最核心的组件有以下几个：</p><ol><li>Nova：负责虚拟机相关。</li><li>Glance：负责镜像相关。</li><li>Cinder：负责存储相关。</li><li>Neutron：负责网络相关。</li><li>Keystone：负责鉴权以及服务注册。</li></ol><p>大体架构如下图：</p><p><img src="https://mypic-1252424367.cos.ap-hongkong.myqcloud.com/opstack/openstack-arch-kilo-logical-v1.png" alt="all.png"></p><a id="more"></a><h2 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h2><p>正式开始学习Openstack源码前，需要一些预备知识，不用特别深入但要知道是做什么的。</p><h3 id="虚拟化"><a href="#虚拟化" class="headerlink" title="虚拟化"></a>虚拟化</h3><p>虚拟化本身就是一门比较复杂的学问，涉及硬件、操作系统、软件等多个层面知识。这里至少要知道4个名词：</p><ol><li>KVM</li><li>Qemu</li><li>Qemu-KVM</li><li>Libvert</li></ol><p>其中KVM在负责对CPU和内存进行虚拟化，Qemu负责对IO进行虚拟化，而Qemu-KVM则是整合了这2者。而Libvert则是提供了一个更加方便的封装，通过Libvertd服务以及virt-*、virsh命令来方便的管理虚拟机。而OpenStack则在此基础上更进一步的封装，通过各种driver插件来管理不同类型的虚拟机。</p><p><img src="https://mypic-1252424367.cos.ap-hongkong.myqcloud.com/opstack/qemu-kvm.png" alt="qemu-kvm-libvert"></p><h3 id="WSGI"><a href="#WSGI" class="headerlink" title="WSGI"></a>WSGI</h3><p>OpenStack的哲学是各个组件通过API以及消息队列建立联系，既然要对外暴露端口，那么其中自然少不了WSGI的存在。<br>简单来说，WSGI解耦了Web Server和Web Application，可以让开发人员专注于功能实现而不是网络协议的处理上。</p><h3 id="Paste-Deployment"><a href="#Paste-Deployment" class="headerlink" title="Paste Deployment"></a>Paste Deployment</h3><p><a href="https://pastedeploy.readthedocs.io/en/latest/" target="_blank" rel="noopener">pastedeploy</a>，这个我也是开始阅读Openstack才学到的新知识，用来建立Server和Application之间的联系。<br>简单来说就是提供服务发现功能，并且隐藏Application的实现细节的，等开始查看Nova代码时候再详细说明。</p><h2 id="通用套路"><a href="#通用套路" class="headerlink" title="通用套路"></a>通用套路</h2><p><a href="https://github.com/openstack" target="_blank" rel="noopener">Openstack</a>的Github主页已经将各个组件拆分，但基本全部遵循着一个相似的结构，比较需要重点关注的文件有3个：</p><ol><li><code>api.py</code>提供对外访问的接口，可以从这开始入手跟踪各个功能实现。</li><li><code>rpcapi.py</code>封装RPC请求调用，大多数是异步调用。</li><li><code>manager.py</code>各种RPC调用的实现，基本和<code>rpcapi.py</code>中调用的名称一一对应。</li></ol><p>另外需要关注的就是根目录中的<code>setup.cfg</code>文件，特别是其中的<code>console_scripts</code>，可以说安装完Openstack后提供的各种命令对应的函数都在这里了，可以说是学习Openstack源码的路标。</p><p>此外还有一点，Openstack的目录结构是根据功能划分的，比如Nova中compute目录不一定都是在<code>nova-compute</code>节点上运行，而是所有和虚拟机创建相关的功能都在这里。</p><h2 id="配置加载与路由绑定"><a href="#配置加载与路由绑定" class="headerlink" title="配置加载与路由绑定"></a>配置加载与路由绑定</h2><p>这里以stein版的Nova为例，根据架构图，Nova-api是所有虚拟机相关请求的入口，首先看Nova中<code>setup.cfg</code>文件定义如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">……省略……</span><br><span class="line"></span><br><span class="line">nova.compute.monitors.cpu =</span><br><span class="line">    virt_driver = nova.compute.monitors.cpu.virt_driver:Monitor</span><br><span class="line"></span><br><span class="line">console_scripts =</span><br><span class="line">    nova-api = nova.cmd.api:main</span><br><span class="line">    nova-api-metadata = nova.cmd.api_metadata:main</span><br><span class="line">    nova-compute = nova.cmd.compute:main</span><br><span class="line">    nova-conductor = nova.cmd.conductor:main</span><br><span class="line">    nova-console = nova.cmd.console:main</span><br><span class="line">    nova-manage = nova.cmd.manage:main</span><br><span class="line">    nova-network = nova.cmd.network:main</span><br><span class="line">    nova-scheduler = nova.cmd.scheduler:main</span><br><span class="line"></span><br><span class="line">nova.scheduler.driver =</span><br><span class="line">    filter_scheduler = nova.scheduler.filter_scheduler:FilterScheduler</span><br><span class="line">    fake_scheduler = nova.tests.unit.scheduler.fakes:FakeScheduler</span><br><span class="line">……省略……</span><br></pre></td></tr></table></figure><p>从配置文件可以明显的看出，nova-api对应的文件是<code>nova/cmd/api.py</code>的<code>main()</code>函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    config.parse_args(sys.argv)</span><br><span class="line">    logging.setup(CONF, <span class="string">"nova"</span>)</span><br><span class="line">    objects.register_all()</span><br><span class="line">    gmr_opts.set_defaults(CONF)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'osapi_compute'</span> <span class="keyword">in</span> CONF.enabled_apis:</span><br><span class="line">        <span class="comment"># NOTE(mriedem): This is needed for caching the nova-compute service</span></span><br><span class="line">        <span class="comment"># version.</span></span><br><span class="line">        objects.Service.enable_min_version_cache()</span><br><span class="line">    log = logging.getLogger(__name__)</span><br><span class="line">    gmr.TextGuruMeditation.setup_autorun(version, conf=CONF)</span><br><span class="line">    launcher = service.process_launcher()</span><br><span class="line">    started = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> api <span class="keyword">in</span> CONF.enabled_apis:</span><br><span class="line">        should_use_ssl = api <span class="keyword">in</span> CONF.enabled_ssl_apis</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            server = service.WSGIService(api, use_ssl=should_use_ssl)</span><br><span class="line">            launcher.launch_service(server, workers=server.workers <span class="keyword">or</span> <span class="number">1</span>)</span><br><span class="line">            started += <span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> exception.PasteAppNotFound <span class="keyword">as</span> ex:</span><br><span class="line">            log.warning(<span class="string">"%s. ``enabled_apis`` includes bad values. "</span></span><br><span class="line">                        <span class="string">"Fix to remove this warning."</span>, ex)</span><br><span class="line">    <span class="keyword">if</span> started == <span class="number">0</span>:</span><br><span class="line">        log.error(<span class="string">'No APIs were started. '</span></span><br><span class="line">                  <span class="string">'Check the enabled_apis config option.'</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    launcher.wait()</span><br></pre></td></tr></table></figure><p><code>main</code>函数其实就做了一件事，启动配置文件中设定的WSGI服务，默认情况下配置文件位于<code>/etc/nova/nova.conf</code>，配置文件中定义了启用哪些服务、Glance、Cinder、Keystone、Libvert、数据库等信息。说到这里简单提一下 <a href="https://github.com/openstack/oslo.config" target="_blank" rel="noopener">oslo_config</a>这个项目，是从Openstack独立出来的专门处理配置文件的基础功能库。</p><p>查看<code>WSGIService</code>的定义，位于<code>nova/service.py</code>:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WSGIService</span><span class="params">(service.Service)</span>:</span></span><br><span class="line">    <span class="string">"""Provides ability to launch API from a 'paste' configuration."""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, loader=None, use_ssl=False, max_url_len=None)</span>:</span></span><br><span class="line">        <span class="string">"""Initialize, but do not start the WSGI server.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param name: The name of the WSGI server given to the loader.</span></span><br><span class="line"><span class="string">        :param loader: Loads the WSGI application using the given name.</span></span><br><span class="line"><span class="string">        :returns: None</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.name = name</span><br><span class="line">        <span class="comment"># NOTE(danms): Name can be metadata, osapi_compute, per</span></span><br><span class="line">        <span class="comment"># nova.service's enabled_apis</span></span><br><span class="line">        self.binary = <span class="string">'nova-%s'</span> % name</span><br><span class="line"></span><br><span class="line">        LOG.warning(<span class="string">'Running %s using eventlet is deprecated. Deploy with '</span></span><br><span class="line">                    <span class="string">'a WSGI server such as uwsgi or mod_wsgi.'</span>, self.binary)</span><br><span class="line"></span><br><span class="line">        self.topic = <span class="literal">None</span></span><br><span class="line">        self.manager = self._get_manager()</span><br><span class="line">        self.loader = loader <span class="keyword">or</span> api_wsgi.Loader()</span><br><span class="line">        self.app = self.loader.load_app(name)</span><br><span class="line">        <span class="comment"># inherit all compute_api worker counts from osapi_compute</span></span><br><span class="line">        <span class="keyword">if</span> name.startswith(<span class="string">'openstack_compute_api'</span>):</span><br><span class="line">            wname = <span class="string">'osapi_compute'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            wname = name</span><br><span class="line">        self.host = getattr(CONF, <span class="string">'%s_listen'</span> % name, <span class="string">"0.0.0.0"</span>)</span><br><span class="line">        self.port = getattr(CONF, <span class="string">'%s_listen_port'</span> % name, <span class="number">0</span>)</span><br><span class="line">        self.workers = (getattr(CONF, <span class="string">'%s_workers'</span> % wname, <span class="literal">None</span>) <span class="keyword">or</span></span><br><span class="line">                        processutils.get_worker_count())</span><br><span class="line">        <span class="keyword">if</span> self.workers <span class="keyword">and</span> self.workers &lt; <span class="number">1</span>:</span><br><span class="line">            worker_name = <span class="string">'%s_workers'</span> % name</span><br><span class="line">            msg = (_(<span class="string">"%(worker_name)s value of %(workers)s is invalid, "</span></span><br><span class="line">                     <span class="string">"must be greater than 0"</span>) %</span><br><span class="line">                   &#123;<span class="string">'worker_name'</span>: worker_name,</span><br><span class="line">                    <span class="string">'workers'</span>: str(self.workers)&#125;)</span><br><span class="line">            <span class="keyword">raise</span> exception.InvalidInput(msg)</span><br><span class="line">        self.use_ssl = use_ssl</span><br><span class="line">        self.server = wsgi.Server(name,</span><br><span class="line">                                  self.app,</span><br><span class="line">                                  host=self.host,</span><br><span class="line">                                  port=self.port,</span><br><span class="line">                                  use_ssl=self.use_ssl,</span><br><span class="line">                                  max_url_len=max_url_len)</span><br><span class="line">        <span class="comment"># Pull back actual port used</span></span><br><span class="line">        self.port = self.server.port</span><br><span class="line">        self.backdoor_port = <span class="literal">None</span></span><br><span class="line">        setup_profiler(name, self.host)</span><br></pre></td></tr></table></figure><p>其中，<code>self.app = self.loader.load_app(name)</code>就是上面所说的使用Paste Deployment来建立连接的部分，相关代码位于<code>nova/api/wsgi.py</code>中：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Loader</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""Used to load WSGI applications from paste configurations."""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, config_path=None)</span>:</span></span><br><span class="line">        <span class="string">"""Initialize the loader, and attempt to find the config.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param config_path: Full or relative path to the paste config.</span></span><br><span class="line"><span class="string">        :returns: None</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.config_path = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        config_path = config_path <span class="keyword">or</span> CONF.wsgi.api_paste_config</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isabs(config_path):</span><br><span class="line">            self.config_path = CONF.find_file(config_path)</span><br><span class="line">        <span class="keyword">elif</span> os.path.exists(config_path):</span><br><span class="line">            self.config_path = config_path</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.config_path:</span><br><span class="line">            <span class="keyword">raise</span> exception.ConfigNotFound(path=config_path)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">load_app</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="string">"""Return the paste URLMap wrapped WSGI application.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param name: Name of the application to load.</span></span><br><span class="line"><span class="string">        :returns: Paste URLMap object wrapping the requested application.</span></span><br><span class="line"><span class="string">        :raises: `nova.exception.PasteAppNotFound`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            LOG.debug(<span class="string">"Loading app %(name)s from %(path)s"</span>,</span><br><span class="line">                      &#123;<span class="string">'name'</span>: name, <span class="string">'path'</span>: self.config_path&#125;)</span><br><span class="line">            <span class="keyword">return</span> deploy.loadapp(<span class="string">"config:%s"</span> % self.config_path, name=name)</span><br><span class="line">        <span class="keyword">except</span> LookupError:</span><br><span class="line">            LOG.exception(_LE(<span class="string">"Couldn't lookup app: %s"</span>), name)</span><br><span class="line">            <span class="keyword">raise</span> exception.PasteAppNotFound(name=name, path=self.config_path)</span><br></pre></td></tr></table></figure><p>默认情况下，配置文件位于<code>/etc/nova/api-paste.ini</code>，内容如下：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############</span></span><br><span class="line"><span class="comment"># Metadata #</span></span><br><span class="line"><span class="comment">############</span></span><br><span class="line"><span class="section">[composite:metadata]</span></span><br><span class="line"><span class="attr">use</span> = egg:Paste<span class="comment">#urlmap</span></span><br><span class="line">/: meta</span><br><span class="line"></span><br><span class="line"><span class="section">[pipeline:meta]</span></span><br><span class="line"><span class="attr">pipeline</span> = cors metaapp</span><br><span class="line"></span><br><span class="line"><span class="section">[app:metaapp]</span></span><br><span class="line"><span class="attr">paste.app_factory</span> = nova.api.metadata.handler:MetadataRequestHandler.factory</span><br><span class="line"></span><br><span class="line"><span class="comment">#############</span></span><br><span class="line"><span class="comment"># OpenStack #</span></span><br><span class="line"><span class="comment">#############</span></span><br><span class="line"></span><br><span class="line"><span class="section">[composite:osapi_compute]</span></span><br><span class="line"><span class="attr">use</span> = call:nova.api.openstack.urlmap:urlmap_factory</span><br><span class="line">/: oscomputeversions</span><br><span class="line"><span class="comment"># v21 is an exactly feature match for v2, except it has more stringent</span></span><br><span class="line"><span class="comment"># input validation on the wsgi surface (prevents fuzzing early on the</span></span><br><span class="line"><span class="comment"># API). It also provides new features via API microversions which are</span></span><br><span class="line"><span class="comment"># opt into for clients. Unaware clients will receive the same frozen</span></span><br><span class="line"><span class="comment"># v2 API feature set, but with some relaxed validation</span></span><br><span class="line">/v2: openstack_compute_api_v21_legacy_v2_compatible</span><br><span class="line">/v2.1: openstack_compute_api_v21</span><br><span class="line"></span><br><span class="line"><span class="section">[composite:openstack_compute_api_v21]</span></span><br><span class="line"><span class="attr">use</span> = call:nova.api.auth:pipeline_factory_v21</span><br><span class="line"><span class="attr">noauth2</span> = cors http_proxy_to_wsgi compute_req_id faultwrap request_log sizelimit osprofiler noauth2 osapi_compute_app_v21</span><br><span class="line"><span class="attr">keystone</span> = cors http_proxy_to_wsgi compute_req_id faultwrap request_log sizelimit osprofiler authtoken keystonecontext osapi_compute_app_v21</span><br><span class="line"></span><br><span class="line"><span class="section">[composite:openstack_compute_api_v21_legacy_v2_compatible]</span></span><br><span class="line"><span class="attr">use</span> = call:nova.api.auth:pipeline_factory_v21</span><br><span class="line"><span class="attr">noauth2</span> = cors http_proxy_to_wsgi compute_req_id faultwrap request_log sizelimit osprofiler noauth2 legacy_v2_compatible osapi_compute_app_v21</span><br><span class="line"><span class="attr">keystone</span> = cors http_proxy_to_wsgi compute_req_id faultwrap request_log sizelimit osprofiler authtoken keystonecontext legacy_v2_compatible osapi_compute_app_v21</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:request_log]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = nova.api.openstack.requestlog:RequestLog.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:compute_req_id]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = nova.api.compute_req_id:ComputeReqIdMiddleware.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:faultwrap]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = nova.api.openstack:FaultWrapper.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:noauth2]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = nova.api.openstack.auth:NoAuthMiddleware.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:osprofiler]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = nova.profiler:WsgiMiddleware.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:sizelimit]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = oslo_middleware:RequestBodySizeLimiter.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:http_proxy_to_wsgi]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = oslo_middleware.http_proxy_to_wsgi:HTTPProxyToWSGI.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[filter:legacy_v2_compatible]</span></span><br><span class="line"><span class="attr">paste.filter_factory</span> = nova.api.openstack:LegacyV2CompatibleWrapper.factory</span><br><span class="line"></span><br><span class="line"><span class="section">[app:osapi_compute_app_v21]</span></span><br><span class="line"><span class="attr">paste.app_factory</span> = nova.api.openstack.compute:APIRouterV21.factory</span><br></pre></td></tr></table></figure><p>PasteDeploy的配置文件可以包括多个段。每个段包含一个名称和多个键值对。名称由type和name组成，使用冒号分隔。每个键值对占一行，键名和值使用等号分隔。比较常用的type有：</p><ul><li>composite:用来分发请求到其它应用去。其下的键值对use = egg:Paste#urlmap表示使用Paste中的urlmap应用。urlmap是使用路径的前缀来将请求映射到不同的应用去。</li><li>app:基本的WSGI应用,通常的用法是paste.app_factory = &lt;模块名&gt;:&lt;类名&gt;.&lt;类方法&gt;。</li><li>filter-app:过滤器，通过next可以指定下一步交给谁处理，next指定的可以是一个普通的WSGI应用，也可以是另一个过滤器。</li><li>filter:过滤器，与filter-app用法上不同，其他应用中使用filter-with来指定使用此filter。</li><li>pipeline:管道，可以将多个filter和最后一个WSGI应用串联起来。</li></ul><p>比如对于<code>metadata</code>，就直接使用了Paste中的路由，而对于<code>osapi_compute</code>，则使用nova自己的<code>urlmap_factory</code>处理。这里以V2版本接口为例，当程序收到请求后转交给了<code>openstack_compute_api_v21_legacy_v2_compatible</code>，然后经过pipeline定义的各种filter处理后由<code>osapi_compute_app_v21</code>接手，而这个程序对应的代码就是<code>nova/api/openstack/compute/routes.py</code>中的<code>APIRouterV21</code>类的<code>factory</code>方法，而这个方法本质上就是创建了一个类实例并建立路由和函数之间的映射关系。</p><p>这些操作完成后通过使用eventlet创建<code>wsgi.Server</code>、绑定监听IP和端口，位于<code>nova/wsgi.py</code>的<code>Server</code>类中，这里就不贴出代码了。</p><h2 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h2><h3 id="Nova-Api"><a href="#Nova-Api" class="headerlink" title="Nova-Api"></a>Nova-Api</h3><p>根据<a href="https://docs.openstack.org/api-ref/compute/?expanded=create-server-detail#create-server" target="_blank" rel="noopener">文档</a>，创建虚拟机的行为其实就是向<code>/servers</code>发送POST请求而已。而上面已经知道在<code>nova/api/openstack/compute/routes.py</code>中定义了对应的函数是：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">'/servers'</span>, &#123;</span><br><span class="line">        <span class="string">'GET'</span>: [server_controller, <span class="string">'index'</span>],</span><br><span class="line">        <span class="string">'POST'</span>: [server_controller, <span class="string">'create'</span>]</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><p></p><p>而这个<code>server_controller</code>是位于<code>nova/api/openstack/compute/servers.py</code>的<code>ServersController</code>类，其<code>create</code>方法定义如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, req, body)</span>:</span></span><br><span class="line">    <span class="string">"""Creates a new server for a given user."""</span></span><br><span class="line">    context = req.environ[<span class="string">'nova.context'</span>]</span><br><span class="line">    server_dict = body[<span class="string">'server'</span>]</span><br><span class="line">    password = self._get_server_admin_password(server_dict)</span><br><span class="line">    name = common.normalize_name(server_dict[<span class="string">'name'</span>])</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    availability_zone = server_dict.pop(<span class="string">"availability_zone"</span>, <span class="literal">None</span>)</span><br><span class="line">    image_uuid = self._image_from_req_data(server_dict, create_kwargs)</span><br><span class="line">    self._process_networks_for_create(</span><br><span class="line">        context, target, server_dict, create_kwargs)</span><br><span class="line">    flavor_id = self._flavor_id_from_req_data(body)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        inst_type = flavors.get_flavor_by_flavor_id(</span><br><span class="line">                flavor_id, ctxt=context, read_deleted=<span class="string">"no"</span>)</span><br><span class="line">        supports_multiattach = common.supports_multiattach_volume(req)</span><br><span class="line">        supports_port_resource_request = \</span><br><span class="line">            common.supports_port_resource_request(req)</span><br><span class="line">        (instances, resv_id) = self.compute_api.create(context,</span><br><span class="line">            inst_type,</span><br><span class="line">            image_uuid,</span><br><span class="line">            display_name=name,</span><br><span class="line">            display_description=description,</span><br><span class="line">            availability_zone=availability_zone,</span><br><span class="line">            forced_host=host, forced_node=node,</span><br><span class="line">            metadata=server_dict.get(<span class="string">'metadata'</span>, &#123;&#125;),</span><br><span class="line">            admin_password=password,</span><br><span class="line">            check_server_group_quota=<span class="literal">True</span>,</span><br><span class="line">            supports_multiattach=supports_multiattach,</span><br><span class="line">            supports_port_resource_request=supports_port_resource_request,</span><br><span class="line">            **create_kwargs)</span><br><span class="line">    <span class="keyword">except</span> (exception.QuotaError,</span><br><span class="line">            exception.PortLimitExceeded) <span class="keyword">as</span> error:</span><br><span class="line">        <span class="keyword">raise</span> exc.HTTPForbidden(</span><br><span class="line">            explanation=error.format_message())</span><br><span class="line">    </span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p>经过一些获取、验证操作后，调用了<code>self.compute_api.create()</code>方法，这个<code>compute_api</code>就是<code>nova/compute/api.py</code>中定义的<code>API</code>类，<code>create</code>函数定义如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@hooks.add_hook("create_instance")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, context, instance_type,</span></span></span><br><span class="line"><span class="function"><span class="params">            image_href, kernel_id=None, ramdisk_id=None,</span></span></span><br><span class="line"><span class="function"><span class="params">            min_count=None, max_count=None,</span></span></span><br><span class="line"><span class="function"><span class="params">            display_name=None, display_description=None,</span></span></span><br><span class="line"><span class="function"><span class="params">            key_name=None, key_data=None, security_groups=None,</span></span></span><br><span class="line"><span class="function"><span class="params">            availability_zone=None, forced_host=None, forced_node=None,</span></span></span><br><span class="line"><span class="function"><span class="params">            user_data=None, metadata=None, injected_files=None,</span></span></span><br><span class="line"><span class="function"><span class="params">            admin_password=None, block_device_mapping=None,</span></span></span><br><span class="line"><span class="function"><span class="params">            access_ip_v4=None, access_ip_v6=None, requested_networks=None,</span></span></span><br><span class="line"><span class="function"><span class="params">            config_drive=None, auto_disk_config=None, scheduler_hints=None,</span></span></span><br><span class="line"><span class="function"><span class="params">            legacy_bdm=True, shutdown_terminate=False,</span></span></span><br><span class="line"><span class="function"><span class="params">            check_server_group_quota=False, tags=None,</span></span></span><br><span class="line"><span class="function"><span class="params">            supports_multiattach=False, trusted_certs=None,</span></span></span><br><span class="line"><span class="function"><span class="params">            supports_port_resource_request=False,</span></span></span><br><span class="line"><span class="function"><span class="params">            requested_host=None, requested_hypervisor_hostname=None)</span>:</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> self._create_instance(</span><br><span class="line">        context, instance_type,</span><br><span class="line">        image_href, kernel_id, ramdisk_id,</span><br><span class="line">        min_count, max_count,</span><br><span class="line">        display_name, display_description,</span><br><span class="line">        key_name, key_data, security_groups,</span><br><span class="line">        availability_zone, user_data, metadata,</span><br><span class="line">        injected_files, admin_password,</span><br><span class="line">        access_ip_v4, access_ip_v6,</span><br><span class="line">        requested_networks, config_drive,</span><br><span class="line">        block_device_mapping, auto_disk_config,</span><br><span class="line">        filter_properties=filter_properties,</span><br><span class="line">        legacy_bdm=legacy_bdm,</span><br><span class="line">        shutdown_terminate=shutdown_terminate,</span><br><span class="line">        check_server_group_quota=check_server_group_quota,</span><br><span class="line">        tags=tags, supports_multiattach=supports_multiattach,</span><br><span class="line">        trusted_certs=trusted_certs,</span><br><span class="line">        supports_port_resource_request=supports_port_resource_request,</span><br><span class="line">        requested_host=requested_host,</span><br><span class="line">        requested_hypervisor_hostname=requested_hypervisor_hostname)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_create_instance</span><span class="params">(self, context, instance_type,</span></span></span><br><span class="line"><span class="function"><span class="params">               image_href, kernel_id, ramdisk_id,</span></span></span><br><span class="line"><span class="function"><span class="params">               min_count, max_count,</span></span></span><br><span class="line"><span class="function"><span class="params">               display_name, display_description,</span></span></span><br><span class="line"><span class="function"><span class="params">               key_name, key_data, security_groups,</span></span></span><br><span class="line"><span class="function"><span class="params">               availability_zone, user_data, metadata, injected_files,</span></span></span><br><span class="line"><span class="function"><span class="params">               admin_password, access_ip_v4, access_ip_v6,</span></span></span><br><span class="line"><span class="function"><span class="params">               requested_networks, config_drive,</span></span></span><br><span class="line"><span class="function"><span class="params">               block_device_mapping, auto_disk_config, filter_properties,</span></span></span><br><span class="line"><span class="function"><span class="params">               reservation_id=None, legacy_bdm=True, shutdown_terminate=False,</span></span></span><br><span class="line"><span class="function"><span class="params">               check_server_group_quota=False, tags=None,</span></span></span><br><span class="line"><span class="function"><span class="params">               supports_multiattach=False, trusted_certs=None,</span></span></span><br><span class="line"><span class="function"><span class="params">               supports_port_resource_request=False,</span></span></span><br><span class="line"><span class="function"><span class="params">               requested_host=None, requested_hypervisor_hostname=None)</span>:</span></span><br><span class="line">    <span class="comment"># Normalize and setup some parameters</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> image_href:</span><br><span class="line">        image_id, boot_meta = self._get_image(context, image_href)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># This is similar to the logic in _retrieve_trusted_certs_object.</span></span><br><span class="line">        <span class="keyword">if</span> (trusted_certs <span class="keyword">or</span></span><br><span class="line">            (CONF.glance.verify_glance_signatures <span class="keyword">and</span></span><br><span class="line">                CONF.glance.enable_certificate_validation <span class="keyword">and</span></span><br><span class="line">                CONF.glance.default_trusted_certificate_ids)):</span><br><span class="line">            msg = _(<span class="string">"Image certificate validation is not supported "</span></span><br><span class="line">                    <span class="string">"when booting from volume"</span>)</span><br><span class="line">            <span class="keyword">raise</span> exception.CertificateValidationFailed(message=msg)</span><br><span class="line">        image_id = <span class="literal">None</span></span><br><span class="line">        boot_meta = self._get_bdm_image_metadata(</span><br><span class="line">            context, block_device_mapping, legacy_bdm)</span><br><span class="line"></span><br><span class="line">    self._check_auto_disk_config(image=boot_meta,</span><br><span class="line">                                    auto_disk_config=auto_disk_config)</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    self.compute_task_api.schedule_and_build_instances(</span><br><span class="line">        context,</span><br><span class="line">        build_requests=build_requests,</span><br><span class="line">        request_spec=request_specs,</span><br><span class="line">        image=boot_meta,</span><br><span class="line">        admin_password=admin_password,</span><br><span class="line">        injected_files=injected_files,</span><br><span class="line">        requested_networks=requested_networks,</span><br><span class="line">        block_device_mapping=block_device_mapping,</span><br><span class="line">        tags=tags)</span><br><span class="line">    <span class="keyword">return</span> instances, reservation_id</span><br></pre></td></tr></table></figure><p>最终，这个函数又调用了<code>self.compute_task_api.schedule_and_build_instances</code>方法，而这个<code>compute_task_api</code>就是<code>nova/conductor/api.py</code>中定义的<code>ComputeTaskAPI</code>类，方法定义如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">schedule_and_build_instances</span><span class="params">(self, context, build_requests,</span></span></span><br><span class="line"><span class="function"><span class="params">                                request_spec, image,</span></span></span><br><span class="line"><span class="function"><span class="params">                                admin_password, injected_files,</span></span></span><br><span class="line"><span class="function"><span class="params">                                requested_networks, block_device_mapping,</span></span></span><br><span class="line"><span class="function"><span class="params">                                tags=None)</span>:</span></span><br><span class="line">    self.conductor_compute_rpcapi.schedule_and_build_instances(</span><br><span class="line">        context, build_requests, request_spec, image,</span><br><span class="line">        admin_password, injected_files, requested_networks,</span><br><span class="line">        block_device_mapping, tags)</span><br></pre></td></tr></table></figure><p>这个函数很简单，就是调用了<code>nova/conductor/rpcapi.py</code>中<code>ComputeTaskAPI</code>类的<code>schedule_and_build_instances</code>方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">schedule_and_build_instances</span><span class="params">(self, context, build_requests,</span></span></span><br><span class="line"><span class="function"><span class="params">                                request_specs,</span></span></span><br><span class="line"><span class="function"><span class="params">                                image, admin_password, injected_files,</span></span></span><br><span class="line"><span class="function"><span class="params">                                requested_networks,</span></span></span><br><span class="line"><span class="function"><span class="params">                                block_device_mapping,</span></span></span><br><span class="line"><span class="function"><span class="params">                                tags=None)</span>:</span></span><br><span class="line">    version = <span class="string">'1.17'</span></span><br><span class="line">    kw = &#123;<span class="string">'build_requests'</span>: build_requests,</span><br><span class="line">            <span class="string">'request_specs'</span>: request_specs,</span><br><span class="line">            <span class="string">'image'</span>: jsonutils.to_primitive(image),</span><br><span class="line">            <span class="string">'admin_password'</span>: admin_password,</span><br><span class="line">            <span class="string">'injected_files'</span>: injected_files,</span><br><span class="line">            <span class="string">'requested_networks'</span>: requested_networks,</span><br><span class="line">            <span class="string">'block_device_mapping'</span>: block_device_mapping,</span><br><span class="line">            <span class="string">'tags'</span>: tags&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.client.can_send_version(version):</span><br><span class="line">        version = <span class="string">'1.16'</span></span><br><span class="line">        <span class="keyword">del</span> kw[<span class="string">'tags'</span>]</span><br><span class="line"></span><br><span class="line">    cctxt = self.client.prepare(version=version)</span><br><span class="line">    cctxt.cast(context, <span class="string">'schedule_and_build_instances'</span>, **kw)</span><br></pre></td></tr></table></figure><p><code>cast</code>代表这个是一个异步调用，<code>schedule_and_build_instances</code>是调用的方法名。虽然目录从api到compute到conductor`，但上面的所有过程都是在nova-api管控下的。一直到发出这个异步请求为止，nova-api阶段结束，返回响应，虚拟机状态为building。</p><h3 id="Nova-Conductor-1"><a href="#Nova-Conductor-1" class="headerlink" title="Nova-Conductor-1"></a>Nova-Conductor-1</h3><p>上面说过，<code>manager.py</code>是对应rpc调用方法的实现，所以在<code>nova/conductor/manager.py</code>中找到函数定义如下：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">schedule_and_build_instances</span><span class="params">(self, context, build_requests,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     request_specs, image,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     admin_password, injected_files,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     requested_networks, block_device_mapping,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     tags=None)</span>:</span></span><br><span class="line">    <span class="comment"># Add all the UUIDs for the instances</span></span><br><span class="line">    instance_uuids = [spec.instance_uuid <span class="keyword">for</span> spec <span class="keyword">in</span> request_specs]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        host_lists = self._schedule_instances(context, request_specs[<span class="number">0</span>],</span><br><span class="line">                instance_uuids, return_alternates=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">        LOG.exception(<span class="string">'Failed to schedule instances'</span>)</span><br><span class="line">        self._bury_in_cell0(context, request_specs[<span class="number">0</span>], exc,</span><br><span class="line">                            build_requests=build_requests,</span><br><span class="line">                            block_device_mapping=block_device_mapping,</span><br><span class="line">                            tags=tags)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_schedule_instances</span><span class="params">(self, context, request_spec,</span></span></span><br><span class="line"><span class="function"><span class="params">                        instance_uuids=None, return_alternates=False)</span>:</span></span><br><span class="line">    scheduler_utils.setup_instance_group(context, request_spec)</span><br><span class="line">    <span class="keyword">with</span> timeutils.StopWatch() <span class="keyword">as</span> timer:</span><br><span class="line">        host_lists = self.query_client.select_destinations(</span><br><span class="line">            context, request_spec, instance_uuids, return_objects=<span class="literal">True</span>,</span><br><span class="line">            return_alternates=return_alternates)</span><br><span class="line">    LOG.debug(<span class="string">'Took %0.2f seconds to select destinations for %s '</span></span><br><span class="line">                <span class="string">'instance(s).'</span>, timer.elapsed(), len(instance_uuids))</span><br><span class="line">    <span class="keyword">return</span> host_lists</span><br></pre></td></tr></table></figure><p></p><p>首先这函数调用<code>_schedule_instances</code>方法，这个方法中又调用了<code>select_destinations</code>，而<code>self.query_client</code>其实是一个<code>SchedulerQueryClient</code>类实例，位于<code>nova/scheduler/query.py</code>中，代码很耿直:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">select_destinations</span><span class="params">(self, context, spec_obj, instance_uuids,</span></span></span><br><span class="line"><span class="function"><span class="params">        return_objects=False, return_alternates=False)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> self.scheduler_rpcapi.select_destinations(context, spec_obj,</span><br><span class="line">            instance_uuids, return_objects, return_alternates)</span><br></pre></td></tr></table></figure><p>一看到rpcapi，果不其然在<code>nova/scheduler/rpcapi.py</code>中找到对应的函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">select_destinations</span><span class="params">(self, ctxt, spec_obj, instance_uuids,</span></span></span><br><span class="line"><span class="function"><span class="params">            return_objects=False, return_alternates=False)</span>:</span></span><br><span class="line">    ......</span><br><span class="line">    cctxt = self.client.prepare(</span><br><span class="line">        version=version, call_monitor_timeout=CONF.rpc_response_timeout,</span><br><span class="line">        timeout=CONF.long_rpc_timeout)</span><br><span class="line">    <span class="keyword">return</span> cctxt.call(ctxt, <span class="string">'select_destinations'</span>, **msg_args)</span><br></pre></td></tr></table></figure><p>注意这里使用的<code>call</code>而不是<code>cast</code>，所以是一个同步调用，此时nova-conductor会堵塞等待直到nova-scheduler返回。</p><h3 id="Nova-Scheduler"><a href="#Nova-Scheduler" class="headerlink" title="Nova-Scheduler"></a>Nova-Scheduler</h3><p>根据套路，在<code>nova/scheduler/manager.py</code>中找到函数定义如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@messaging.expected_exceptions(exception.NoValidHost)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">select_destinations</span><span class="params">(self, ctxt, request_spec=None,</span></span></span><br><span class="line"><span class="function"><span class="params">        filter_properties=None, spec_obj=_sentinel, instance_uuids=None,</span></span></span><br><span class="line"><span class="function"><span class="params">        return_objects=False, return_alternates=False)</span>:</span></span><br><span class="line">    ......</span><br><span class="line">    selections = self.driver.select_destinations(ctxt, spec_obj,</span><br><span class="line">            instance_uuids, alloc_reqs_by_rp_uuid, provider_summaries,</span><br><span class="line">            allocation_request_version, return_alternates)</span><br><span class="line">    <span class="comment"># If `return_objects` is False, we need to convert the selections to</span></span><br><span class="line">    <span class="comment"># the older format, which is a list of host state dicts.</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> return_objects:</span><br><span class="line">        selection_dicts = [sel[<span class="number">0</span>].to_dict() <span class="keyword">for</span> sel <span class="keyword">in</span> selections]</span><br><span class="line">        <span class="keyword">return</span> jsonutils.to_primitive(selection_dicts)</span><br><span class="line">    <span class="keyword">return</span> selections</span><br></pre></td></tr></table></figure><p>这个函数本质上又是一层封装，最终调用的是<code>nova-api.conf</code>文件中定义的<code>scheduler.driver</code>，这里以自带的<code>FilterScheduler</code>为例，位于<code>nova/scheduler/filter_scheduler.py</code>，入口函数是<code>_schedule</code>，在这里首先获取全部的host，然后经过<code>_get_sorted_hosts</code>函数的筛选和权重计算，返回满足条件的主机给nova-conductor。</p><h3 id="Nova-Conductor-2"><a href="#Nova-Conductor-2" class="headerlink" title="Nova-Conductor-2"></a>Nova-Conductor-2</h3><p>回到<code>nova/conductor/manager.py</code>的<code>schedule_and_build_instances</code>方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">schedule_and_build_instances</span><span class="params">(self, context, build_requests,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     request_specs, image,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     admin_password, injected_files,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     requested_networks, block_device_mapping,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     tags=None)</span>:</span></span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    zipped = six.moves.zip(build_requests, request_specs, host_lists,</span><br><span class="line">                            instances)</span><br><span class="line">    <span class="keyword">for</span> (build_request, request_spec, host_list, instance) <span class="keyword">in</span> zipped:</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> obj_target_cell(instance, cell) <span class="keyword">as</span> cctxt:</span><br><span class="line">            <span class="comment"># send a state update notification for the initial create to</span></span><br><span class="line">            <span class="comment"># show it going from non-existent to BUILDING</span></span><br><span class="line">            <span class="comment"># This can lazy-load attributes on instance.</span></span><br><span class="line">            notifications.send_update_with_states(cctxt, instance, <span class="literal">None</span>,</span><br><span class="line">                    vm_states.BUILDING, <span class="literal">None</span>, <span class="literal">None</span>, service=<span class="string">"conductor"</span>)</span><br><span class="line">            objects.InstanceAction.action_start(</span><br><span class="line">                cctxt, instance.uuid, instance_actions.CREATE,</span><br><span class="line">                want_result=<span class="literal">False</span>)</span><br><span class="line">            instance_bdms = self._create_block_device_mapping(</span><br><span class="line">                cell, instance.flavor, instance.uuid, block_device_mapping)</span><br><span class="line">            instance_tags = self._create_tags(cctxt, instance.uuid, tags)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Update mapping for instance. Normally this check is guarded by</span></span><br><span class="line">        <span class="comment"># a try/except but if we're here we know that a newer nova-api</span></span><br><span class="line">        <span class="comment"># handled the build process and would have created the mapping</span></span><br><span class="line">        inst_mapping = objects.InstanceMapping.get_by_instance_uuid(</span><br><span class="line">            context, instance.uuid)</span><br><span class="line">        inst_mapping.cell_mapping = cell</span><br><span class="line">        inst_mapping.save()</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line">        </span><br><span class="line">        legacy_secgroups = [s.identifier</span><br><span class="line">                            <span class="keyword">for</span> s <span class="keyword">in</span> request_spec.security_groups]</span><br><span class="line">        <span class="keyword">with</span> obj_target_cell(instance, cell) <span class="keyword">as</span> cctxt:</span><br><span class="line">            self.compute_rpcapi.build_and_run_instance(</span><br><span class="line">                cctxt, instance=instance, image=image,</span><br><span class="line">                request_spec=request_spec,</span><br><span class="line">                filter_properties=filter_props,</span><br><span class="line">                admin_password=admin_password,</span><br><span class="line">                injected_files=injected_files,</span><br><span class="line">                requested_networks=requested_networks,</span><br><span class="line">                security_groups=legacy_secgroups,</span><br><span class="line">                block_device_mapping=instance_bdms,</span><br><span class="line">                host=host.service_host, node=host.nodename,</span><br><span class="line">                limits=host.limits, host_list=host_list)</span><br></pre></td></tr></table></figure><p>拿到主机列表后，由于可能同时创建多台主机，所以使用for循环，进行了一些数据库操作后，进行rpc调用，位于<code>nova/compute/rpcapi.py</code>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_and_run_instance</span><span class="params">(self, ctxt, instance, host, image, request_spec,</span></span></span><br><span class="line"><span class="function"><span class="params">        filter_properties, admin_password=None, injected_files=None,</span></span></span><br><span class="line"><span class="function"><span class="params">        requested_networks=None, security_groups=None,</span></span></span><br><span class="line"><span class="function"><span class="params">        block_device_mapping=None, node=None, limits=None,</span></span></span><br><span class="line"><span class="function"><span class="params">        host_list=None)</span>:</span></span><br><span class="line">    ......    </span><br><span class="line">    cctxt.cast(ctxt, <span class="string">'build_and_run_instance'</span>, **kwargs)</span><br></pre></td></tr></table></figure><h3 id="Nova-Compute"><a href="#Nova-Compute" class="headerlink" title="Nova-Compute"></a>Nova-Compute</h3><p>套路都熟悉了，直接看<code>nova/compute/manager.py</code>吧，其实最核心函数是<code>_build_and_run_instance</code>，这里进行镜像、网络资源的准备以及各种验证、状态修改、发送通知等。最后调用对应driver的spawn方法，这里以libvert为例，对应文件是<code>nova/virt/libvirt/driver.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spawn</span><span class="params">(self, context, instance, image_meta, injected_files,</span></span></span><br><span class="line"><span class="function"><span class="params">            admin_password, allocations, network_info=None,</span></span></span><br><span class="line"><span class="function"><span class="params">            block_device_info=None, power_on=True)</span>:</span></span><br><span class="line">    disk_info = blockinfo.get_disk_info(CONF.libvirt.virt_type,</span><br><span class="line">                                        instance,</span><br><span class="line">                                        image_meta,</span><br><span class="line">                                        block_device_info)</span><br><span class="line">    injection_info = InjectionInfo(network_info=network_info,</span><br><span class="line">                                    files=injected_files,</span><br><span class="line">                                    admin_pass=admin_password)</span><br><span class="line">    gen_confdrive = functools.partial(self._create_configdrive,</span><br><span class="line">                                        context, instance,</span><br><span class="line">                                        injection_info)</span><br><span class="line">    self._create_image(context, instance, disk_info[<span class="string">'mapping'</span>],</span><br><span class="line">                        injection_info=injection_info,</span><br><span class="line">                        block_device_info=block_device_info)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Required by Quobyte CI</span></span><br><span class="line">    self._ensure_console_log_for_instance(instance)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Does the guest need to be assigned some vGPU mediated devices ?</span></span><br><span class="line">    mdevs = self._allocate_mdevs(allocations)</span><br><span class="line"></span><br><span class="line">    xml = self._get_guest_xml(context, instance, network_info,</span><br><span class="line">                                disk_info, image_meta,</span><br><span class="line">                                block_device_info=block_device_info,</span><br><span class="line">                                mdevs=mdevs)</span><br><span class="line">    self._create_domain_and_network(</span><br><span class="line">        context, xml, instance, network_info,</span><br><span class="line">        block_device_info=block_device_info,</span><br><span class="line">        post_xml_callback=gen_confdrive,</span><br><span class="line">        destroy_disks_on_failure=<span class="literal">True</span>,</span><br><span class="line">        power_on=power_on)</span><br><span class="line">    LOG.debug(<span class="string">"Guest created on hypervisor"</span>, instance=instance)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_wait_for_boot</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="string">"""Called at an interval until the VM is running."""</span></span><br><span class="line">        state = self.get_info(instance).state</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> state == power_state.RUNNING:</span><br><span class="line">            LOG.info(<span class="string">"Instance spawned successfully."</span>, instance=instance)</span><br><span class="line">            <span class="keyword">raise</span> loopingcall.LoopingCallDone()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> power_on:</span><br><span class="line">        timer = loopingcall.FixedIntervalLoopingCall(_wait_for_boot)</span><br><span class="line">        timer.start(interval=<span class="number">0.5</span>).wait()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        LOG.info(<span class="string">"Instance spawned successfully."</span>, instance=instance)</span><br></pre></td></tr></table></figure><p>在这里拉取镜像创建根目录，生成XML(默认在/etc/libvert/qemu目录)，定义网络和domain并启动，然后虚拟机状态为running。到此为止，创建虚拟机完成。</p></div></div><div id="post-footer" class="post-footer main-content-wrap"><div class="post-footer-tags"><span class="text-color-light text-small">标签</span><br><a class="tag tag--primary tag--small t-link" href="/source/all-tags/Nova/">Nova</a></div><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2019/09/18/OpenStack源码学习笔记2/" data-tooltip="OpenStack源码学习笔记2"><i class="fa fa-angle-left"></i> <span class="hide-xs hide-sm text-small icon-ml">上一篇</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2019/05/06/Scrapy-Redis结合POST请求获取数据/" data-tooltip="Scrapy-Redis结合POST请求获取数据"><span class="hide-xs hide-sm text-small icon-mr">下一篇</span> <i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions"><i class="fa fa-share-alt"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-facebook-official"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-twitter"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-google-plus"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-weibo"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/&amp;title=OpenStack源码学习笔记1"><i class="fa fa-qq"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-star"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://widget.renren.com/dialog/share?resourceUrl=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-renren"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#"><i class="fa fa-list"></i></a></li></ul></div></div></article><footer id="footer" class="main-content-wrap"><span class="copyrights">Copyrights &copy; 2019 Roy. All Rights Reserved.</span></footer></div><div id="bottom-bar" class="post-bottom-bar" data-behavior="4"><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2019/09/18/OpenStack源码学习笔记2/" data-tooltip="OpenStack源码学习笔记2"><i class="fa fa-angle-left"></i> <span class="hide-xs hide-sm text-small icon-ml">上一篇</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2019/05/06/Scrapy-Redis结合POST请求获取数据/" data-tooltip="Scrapy-Redis结合POST请求获取数据"><span class="hide-xs hide-sm text-small icon-mr">下一篇</span> <i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions"><i class="fa fa-share-alt"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-facebook-official"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-twitter"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-google-plus"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-weibo"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/&amp;title=OpenStack源码学习笔记1"><i class="fa fa-qq"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-star"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://widget.renren.com/dialog/share?resourceUrl=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-renren"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#"><i class="fa fa-list"></i></a></li></ul></div></div><div id="share-options-bar" class="share-options-bar" data-behavior="4"><i id="btn-close-shareoptions" class="fa fa-close"></i><ul class="share-options"><li class="share-option"><a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-facebook-official"></i><span>分享到 Facebook</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-twitter"></i><span>分享到 Twitter</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-google-plus"></i><span>分享到 Google+</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://service.weibo.com/share/share.php?&amp;title=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-weibo"></i><span>分享到 Weibo</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/&amp;title=OpenStack源码学习笔记1"><i class="fa fa-qq"></i><span>分享到 QQ</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-star"></i><span>分享到 Qzone</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://widget.renren.com/dialog/share?resourceUrl=http://www.hi-roy.com/2019/09/16/OpenStack源码学习笔记1/"><i class="fa fa-renren"></i><span>分享到 Renren</span></a></li></ul></div></div><div id="about"><div id="about-card"><div id="about-btn-close"><i class="fa fa-remove"></i></div><img id="about-card-picture" src="/assets/images/my.jpg" alt="作者的图片"><h4 id="about-card-name">Roy</h4><div id="about-card-bio"><p>君以国士待我，我必以国士报君。</p></div><div id="about-card-job"><i class="fa fa-briefcase"></i><br><p>野生程序猿</p></div><div id="about-card-location"><i class="fa fa-map-marker"></i><br>China</div></div></div><div id="algolia-search-modal" class="modal-container"><div class="modal"><div class="modal-header"><span class="close-button"><i class="fa fa-close"></i></span> <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled"><span class="searchby-algolia-text text-color-light text-small">by</span> <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg"> </a><i class="search-icon fa fa-search"></i><form id="algolia-search-form"><input type="text" id="algolia-search-input" name="search" class="form-control input--large search-input" placeholder="Search "></form></div><div class="modal-body"><div class="no-result text-color-light text-center">没有找到文章</div><div class="results"><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/02/12/Ubuntu下Gogant的简易破墙术/"><h3 class="media-heading">Ubuntu下Gogant的简易破墙术</h3></a><span class="media-meta"><span class="media-date text-small">2013年2月12日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/10/31/python常用第三方库-转载/"><h3 class="media-heading">Python常用第三方库(转载)</h3></a><span class="media-meta"><span class="media-date text-small">2013年10月31日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/fedora19安装ar8161网卡驱动/"><h3 class="media-heading">fedora19安装ar8161网卡驱动</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/fedora19源，rpmforge，fastestmirror/"><h3 class="media-heading">fedora19源，rpmforge，fastestmirror</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/python中如何自定义解析域名/"><h3 class="media-heading">python中如何自定义解析域名</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/django版本更换/"><h3 class="media-heading">django版本更换</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/django-groundwork个人1-5-3修改版/"><h3 class="media-heading">django-groundwork个人1.5.3修改版</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/fedora19美化/"><h3 class="media-heading">fedora19美化</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/装饰器/"><h3 class="media-heading">装饰器</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/SVN常用操作/"><h3 class="media-heading">SVN常用操作</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div></div></div><div class="modal-footer"><p class="results-count text-medium" data-message-zero="没有找到文章" data-message-one="找到 1 篇文章" data-message-other="找到 {n} 篇文章">找到 224 篇文章</p></div></div></div><div id="cover" style="background-image:url(/assets/images/cover.jpg)"></div><script src="/assets/js/script-ivwiy10zeb8fifc4swnhkwneuk64y53w2scmdmtp8thi9cqfxh31aowtroaz.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment-with-locales.min.js"></script><script src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script><script>var algoliaClient=algoliasearch("51U8PIBLP6","16909d9ce1780cda71113841864e7aa8"),algoliaIndex=algoliaClient.initIndex("my-blog")</script></body></html>