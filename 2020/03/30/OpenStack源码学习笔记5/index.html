<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Hi!Roy!"><title>OpenStack源码学习笔记5 - Hi!Roy!</title><meta name="author" content="Roy"><link rel="icon" href="http://www.hi-roy.com/assets/images/favicon.ico"><link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml"><meta name="description" content="今天遇到一个诡异的问题，对某个有问题的计算节点进行疏散，结果有些虚拟机的根磁盘居然消！失！了？首先能够确定的是ceph不会自动删除，那么一定是某个地方触发了删除根磁盘的操作。这如果发生在生产环境可是一个极其严重的问题，正好借此排查的机会梳理一下nova关于主机疏散的流程。以下代码为N版，但大体流程相差应该不大。"><meta name="keywords" content="Nova"><meta property="og:type" content="blog"><meta property="og:title" content="OpenStack源码学习笔记5"><meta property="og:url" content="http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/index.html"><meta property="og:site_name" content="Hi!Roy!"><meta property="og:description" content="今天遇到一个诡异的问题，对某个有问题的计算节点进行疏散，结果有些虚拟机的根磁盘居然消！失！了？首先能够确定的是ceph不会自动删除，那么一定是某个地方触发了删除根磁盘的操作。这如果发生在生产环境可是一个极其严重的问题，正好借此排查的机会梳理一下nova关于主机疏散的流程。以下代码为N版，但大体流程相差应该不大。"><meta property="og:locale" content="zh-cn"><meta property="og:updated_time" content="2020-04-02T02:13:13.361Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="OpenStack源码学习笔记5"><meta name="twitter:description" content="今天遇到一个诡异的问题，对某个有问题的计算节点进行疏散，结果有些虚拟机的根磁盘居然消！失！了？首先能够确定的是ceph不会自动删除，那么一定是某个地方触发了删除根磁盘的操作。这如果发生在生产环境可是一个极其严重的问题，正好借此排查的机会梳理一下nova关于主机疏散的流程。以下代码为N版，但大体流程相差应该不大。"><meta property="og:image" content="http://www.hi-roy.com/assets/images/my.jpg"><link rel="stylesheet" href="/assets/css/style-sxklfps8ywgfyyjcowvnb4gxdgt0zjts3hsguljmv9uqanxjbnitrovtbrek.min.css"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?21513ec2bcd577b3297a1b16da82fa40";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body><div id="blog"><header id="header" data-behavior="4"><i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i><div class="header-title"><a class="header-title-link" href="/">Hi!Roy!</a></div><a class="header-right-icon" href="#about"><i class="fa fa-lg fa-question"></i></a></header><nav id="sidebar" data-behavior="4"><div class="sidebar-container"><div class="sidebar-profile"><a href="/#about"><img class="sidebar-profile-picture" src="/assets/images/my.jpg" alt="作者的图片"></a><h4 class="sidebar-profile-name">Roy</h4><h5 class="sidebar-profile-bio"><p>君以国士待我，我必以国士报君。</p></h5></div><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/"><i class="sidebar-button-icon fa fa-lg fa-home"></i> <span class="sidebar-button-desc">首页</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-categories"><i class="sidebar-button-icon fa fa-lg fa-bookmark"></i> <span class="sidebar-button-desc">分类</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-tags"><i class="sidebar-button-icon fa fa-lg fa-tags"></i> <span class="sidebar-button-desc">标签</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-archives"><i class="sidebar-button-icon fa fa-lg fa-archive"></i> <span class="sidebar-button-desc">归档</span></a></li><li class="sidebar-button"><a class="sidebar-button-link open-algolia-search" href="#search"><i class="sidebar-button-icon fa fa-lg fa-search"></i> <span class="sidebar-button-desc">搜索</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="#about"><i class="sidebar-button-icon fa fa-lg fa-question"></i> <span class="sidebar-button-desc">关于</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="https://github.com/shenyushun" target="_blank" rel="noopener"><i class="sidebar-button-icon fa fa-lg fa-github"></i> <span class="sidebar-button-desc">GitHub</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="mailto:darkcooking@gmail.com" target="_blank" rel="noopener"><i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i> <span class="sidebar-button-desc">邮箱</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/atom.xml"><i class="sidebar-button-icon fa fa-lg fa-rss"></i> <span class="sidebar-button-desc">RSS</span></a></li></ul></div></nav><div id="main" data-behavior="4" class="hasCoverMetaIn"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><div class="post-header main-content-wrap text-left"><h1 class="post-title" itemprop="headline">OpenStack源码学习笔记5</h1><div class="post-meta"><time itemprop="datePublished" datetime="2020-03-30T17:46:29+08:00">3月 30, 2020 </time><span>发布在 </span><a class="category-link" href="/source/all-categories/Python/">Python</a>, <a class="category-link" href="/source/all-categories/Python/OpenStack/">OpenStack</a></div></div><div class="post-content markdown" itemprop="articleBody"><div class="main-content-wrap"><p>今天遇到一个诡异的问题，对某个有问题的计算节点进行疏散，结果有些虚拟机的根磁盘居然消！失！了？首先能够确定的是ceph不会自动删除，那么一定是某个地方触发了删除根磁盘的操作。</p><p>这如果发生在生产环境可是一个极其严重的问题，正好借此排查的机会梳理一下nova关于主机疏散的流程。</p><p>以下代码为N版，但大体流程相差应该不大。</p><a id="more"></a><p>根据套路(不知道套路的看以前的系列文章)，定位疏散入口为<code>api/openstack/compute/evacuate.py</code>的<code>_evacuate</code>函数，这里有个比较重要的就是判断是否使用了共享存储，然后调用<code>compute/api.py</code>中的<code>evacuate</code>函数：<br></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">evacuate</span><span class="params">(self, context, instance, host, on_shared_storage,</span></span></span><br><span class="line"><span class="function"><span class="params">                admin_password=None, force=None)</span>:</span></span><br><span class="line">    ......</span><br><span class="line">    migration = objects.Migration(context,</span><br><span class="line">                                    source_compute=instance.host,</span><br><span class="line">                                    source_node=instance.node,</span><br><span class="line">                                    instance_uuid=instance.uuid,</span><br><span class="line">                                    status=<span class="string">'accepted'</span>,</span><br><span class="line">                                    migration_type=<span class="string">'evacuation'</span>)</span><br><span class="line">    <span class="keyword">if</span> host:</span><br><span class="line">        migration.dest_compute = host</span><br><span class="line">    migration.create()</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> self.compute_task_api.rebuild_instance(context,</span><br><span class="line">                    instance=instance,</span><br><span class="line">                    new_pass=admin_password,</span><br><span class="line">                    injected_files=<span class="literal">None</span>,</span><br><span class="line">                    image_ref=<span class="literal">None</span>,</span><br><span class="line">                    orig_image_ref=<span class="literal">None</span>,</span><br><span class="line">                    orig_sys_metadata=<span class="literal">None</span>,</span><br><span class="line">                    bdms=<span class="literal">None</span>,</span><br><span class="line">                    recreate=<span class="literal">True</span>,</span><br><span class="line">                    on_shared_storage=on_shared_storage,</span><br><span class="line">                    host=host,</span><br><span class="line">                    request_spec=request_spec,</span><br><span class="line">                    )</span><br></pre></td></tr></table></figure><p></p><p>这个函数首先建立一个status为<code>accepted</code>、type为<code>evacuation</code>的数据，然后看是否指定目标主机，在我们的使用场景下这个值都为<code>None</code>，这里需要注意一个<code>recreate</code>参数，在疏散调用时值为<code>True</code>。</p><p>然后跟进<code>conductor/manager.py</code>中<code>ComputeTaskManager</code>类的<code>rebuild_instance</code>方法，这里会进行主机筛选：</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rebuild_instance</span><span class="params">(self, context, instance, orig_image_ref, image_ref,</span></span></span><br><span class="line"><span class="function"><span class="params">                        injected_files, new_pass, orig_sys_metadata,</span></span></span><br><span class="line"><span class="function"><span class="params">                        bdms, recreate, on_shared_storage,</span></span></span><br><span class="line"><span class="function"><span class="params">                        preserve_ephemeral=False, host=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                        request_spec=None, force_dest=None, filter_properties=None)</span>:</span></span><br><span class="line">    dest_filter_properties = filter_properties</span><br><span class="line">    <span class="keyword">with</span> compute_utils.EventReporter(context, <span class="string">'rebuild_server'</span>,</span><br><span class="line">                                        instance.uuid):</span><br><span class="line">        node = limits = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> host:</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                hosts = self._schedule_instances(context, request_spec, filter_properties)</span><br><span class="line">                host_dict = hosts.pop(<span class="number">0</span>)</span><br><span class="line">                host, node, limits = (host_dict[<span class="string">'host'</span>],</span><br><span class="line">                                        host_dict[<span class="string">'nodename'</span>],</span><br><span class="line">                                        host_dict[<span class="string">'limits'</span>])</span><br><span class="line">            <span class="keyword">except</span> exception.NoValidHost <span class="keyword">as</span> ex:</span><br><span class="line">                <span class="keyword">with</span> excutils.save_and_reraise_exception():</span><br><span class="line">                    self._set_vm_state_and_notify(context, instance.uuid,</span><br><span class="line">                            <span class="string">'rebuild_server'</span>,</span><br><span class="line">                            &#123;<span class="string">'vm_state'</span>: instance.vm_state,</span><br><span class="line">                                <span class="string">'task_state'</span>: <span class="literal">None</span>&#125;, ex, request_spec)</span><br><span class="line">                    LOG.warning(_LW(<span class="string">"No valid host found for rebuild"</span>),</span><br><span class="line">                                instance=instance)</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            migration = objects.Migration.get_by_instance_and_status(</span><br><span class="line">                context, instance.uuid, <span class="string">'accepted'</span>)</span><br><span class="line">        <span class="keyword">except</span> exception.MigrationNotFoundByStatus:</span><br><span class="line">            LOG.debug(<span class="string">"No migration record for the rebuild/evacuate "</span></span><br><span class="line">                        <span class="string">"request."</span>, instance=instance)</span><br><span class="line">            migration = <span class="literal">None</span></span><br><span class="line">        self.compute_rpcapi.rebuild_instance(context,</span><br><span class="line">                instance=instance,</span><br><span class="line">                new_pass=new_pass,</span><br><span class="line">                injected_files=injected_files,</span><br><span class="line">                image_ref=image_ref,</span><br><span class="line">                orig_image_ref=orig_image_ref,</span><br><span class="line">                orig_sys_metadata=orig_sys_metadata,</span><br><span class="line">                bdms=bdms,</span><br><span class="line">                recreate=recreate,</span><br><span class="line">                on_shared_storage=on_shared_storage,</span><br><span class="line">                preserve_ephemeral=preserve_ephemeral,</span><br><span class="line">                migration=migration,</span><br><span class="line">                host=host, node=node, limits=limits)</span><br></pre></td></tr></table></figure><p>然后再经过<code>compute/rpcapi.py</code>中<code>ComputeAPI</code>的<code>rebuild_instance</code>方法，最终进入<code>compute/manager.py</code>的<code>_do_rebuild_instance</code>函数，这个函数中进行主机状态、网络、磁盘相关的修改，构造好参数后进入<code>_rebuild_default_impl</code>函数:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_rebuild_default_impl</span><span class="params">(self, context, instance, image_meta,</span></span></span><br><span class="line"><span class="function"><span class="params">                            injected_files, admin_password, bdms,</span></span></span><br><span class="line"><span class="function"><span class="params">                            detach_block_devices, attach_block_devices,</span></span></span><br><span class="line"><span class="function"><span class="params">                            network_info=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                            recreate=False, block_device_info=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                            preserve_ephemeral=False)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> preserve_ephemeral:</span><br><span class="line">        <span class="comment"># The default code path does not support preserving ephemeral</span></span><br><span class="line">        <span class="comment"># partitions.</span></span><br><span class="line">        <span class="keyword">raise</span> exception.PreserveEphemeralNotSupported()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> recreate:</span><br><span class="line">        detach_block_devices(context, bdms)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self._power_off_instance(context, instance, clean_shutdown=<span class="literal">True</span>)</span><br><span class="line">        detach_block_devices(context, bdms)</span><br><span class="line">        self.driver.destroy(context, instance,</span><br><span class="line">                            network_info=network_info,</span><br><span class="line">                            block_device_info=block_device_info)</span><br><span class="line"></span><br><span class="line">    instance.task_state = task_states.REBUILD_BLOCK_DEVICE_MAPPING</span><br><span class="line">    instance.save(expected_task_state=[task_states.REBUILDING])</span><br><span class="line"></span><br><span class="line">    new_block_device_info = attach_block_devices(context, instance, bdms)</span><br><span class="line"></span><br><span class="line">    instance.task_state = task_states.REBUILD_SPAWNING</span><br><span class="line">    instance.save(</span><br><span class="line">        expected_task_state=[task_states.REBUILD_BLOCK_DEVICE_MAPPING])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> instance.mutated_migration_context():</span><br><span class="line">        self.driver.spawn(context, instance, image_meta, injected_files,</span><br><span class="line">                            admin_password, network_info=network_info,</span><br><span class="line">                            block_device_info=new_block_device_info)</span><br></pre></td></tr></table></figure><p>由于传入的<code>recreate</code>值为<code>True</code>，怎么看也不会有触发删除磁盘的行为啊？else分支的<code>driver.destroy</code>函数看起来很可疑，跟进去看看，代码位于<code>virt/libvirt/driver.py</code>中:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">destroy</span><span class="params">(self, context, instance, network_info, block_device_info=None,</span></span></span><br><span class="line"><span class="function"><span class="params">            destroy_disks=True, migrate_data=None)</span>:</span></span><br><span class="line">    self._destroy(instance)</span><br><span class="line">    self.cleanup(context, instance, network_info, block_device_info,</span><br><span class="line">                 destroy_disks, migrate_data)</span><br></pre></td></tr></table></figure><p>其中<code>_destory</code>函数主要是删除主机，代码有兴趣的可以看看。而真正执行删磁盘的代码位于<code>cleanup</code>函数中:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cleanup</span><span class="params">(self, context, instance, network_info, block_device_info=None,</span></span></span><br><span class="line"><span class="function"><span class="params">            destroy_disks=True, migrate_data=None, destroy_vifs=True)</span>:</span></span><br><span class="line">    ......      </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self._disconnect_volume(connection_info, disk_dev)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">            <span class="keyword">with</span> excutils.save_and_reraise_exception() <span class="keyword">as</span> ctxt:</span><br><span class="line">                <span class="keyword">if</span> destroy_disks:</span><br><span class="line">                    <span class="comment"># Don't block on Volume errors if we're trying to</span></span><br><span class="line">                    <span class="comment"># delete the instance as we may be partially created</span></span><br><span class="line">                    <span class="comment"># or deleted</span></span><br><span class="line">                    ctxt.reraise = <span class="literal">False</span></span><br><span class="line">                    LOG.warning(</span><br><span class="line">                        _LW(<span class="string">"Ignoring Volume Error on vol %(vol_id)s "</span></span><br><span class="line">                            <span class="string">"during delete %(exc)s"</span>),</span><br><span class="line">                        &#123;<span class="string">'vol_id'</span>: vol.get(<span class="string">'volume_id'</span>), <span class="string">'exc'</span>: exc&#125;,</span><br><span class="line">                        instance=instance)</span><br><span class="line">    <span class="keyword">if</span> destroy_disks:</span><br><span class="line">        <span class="comment"># NOTE(haomai): destroy volumes if needed</span></span><br><span class="line">        <span class="keyword">if</span> CONF.libvirt.images_type == <span class="string">'lvm'</span>:</span><br><span class="line">            self._cleanup_lvm(instance, block_device_info)</span><br><span class="line">        <span class="keyword">if</span> CONF.libvirt.images_type == <span class="string">'rbd'</span>:</span><br><span class="line">            self._cleanup_rbd(instance)</span><br><span class="line">    ......</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_cleanup_rbd</span><span class="params">(self, instance)</span>:</span></span><br><span class="line">    <span class="comment"># NOTE(nic): On revert_resize, the cleanup steps for the root</span></span><br><span class="line">    <span class="comment"># volume are handled with an "rbd snap rollback" command,</span></span><br><span class="line">    <span class="comment"># and none of this is needed (and is, in fact, harmful) so</span></span><br><span class="line">    <span class="comment"># filter out non-ephemerals from the list</span></span><br><span class="line">    <span class="keyword">if</span> instance.task_state == task_states.RESIZE_REVERTING:</span><br><span class="line">        filter_fn = <span class="keyword">lambda</span> disk: (disk.startswith(instance.uuid) <span class="keyword">and</span></span><br><span class="line">                                    disk.endswith(<span class="string">'disk.local'</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        filter_fn = <span class="keyword">lambda</span> disk: disk.startswith(instance.uuid)</span><br><span class="line">    LibvirtDriver._get_rbd_driver().cleanup_volumes(filter_fn)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Roy注：下面这函数在virt/libvirt/storage/rbd_utils.py中</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cleanup_volumes</span><span class="params">(self, filter_fn)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> RADOSClient(self, self.pool) <span class="keyword">as</span> client:</span><br><span class="line">        volumes = RbdProxy().list(client.ioctx)</span><br><span class="line">        <span class="keyword">for</span> volume <span class="keyword">in</span> filter(filter_fn, volumes):</span><br><span class="line">            self._destroy_volume(client, volume)</span><br></pre></td></tr></table></figure><p>至此，能够触发删除根磁盘的代码可以确定了。这里我们倒过来想，如果疏散行为不会导致磁盘被删除，那么一定是其他地方调用了这个函数呢？经过排查，所有会调用这个<code>destroy</code>函数的地方有4个:</p><ol><li>evacuate</li><li>revert_resize</li><li>shelve_offloading</li><li>host_init</li></ol><p>其中1、2、3都被排除，那么就看host_init时做了什么吧：</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_host</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""Initialization for a standalone compute service."""</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># checking that instance was not already evacuated to other host</span></span><br><span class="line">        self._destroy_evacuated_instances(context)</span><br><span class="line">        <span class="keyword">for</span> instance <span class="keyword">in</span> instances:</span><br><span class="line">            self._init_instance(context, instance)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        <span class="keyword">if</span> CONF.defer_iptables_apply:</span><br><span class="line">            self.driver.filter_defer_apply_off()</span><br><span class="line">        self._update_scheduler_instance_info(context, instances)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_destroy_evacuated_instances</span><span class="params">(self, context)</span>:</span></span><br><span class="line">    <span class="string">"""Destroys evacuated instances.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    While nova-compute was down, the instances running on it could be</span></span><br><span class="line"><span class="string">    evacuated to another host. Check that the instances reported</span></span><br><span class="line"><span class="string">    by the driver are still associated with this host.  If they are</span></span><br><span class="line"><span class="string">    not, destroy them, with the exception of instances which are in</span></span><br><span class="line"><span class="string">    the MIGRATING, RESIZE_MIGRATING, RESIZE_MIGRATED, RESIZE_FINISH</span></span><br><span class="line"><span class="string">    task state or RESIZED vm state.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    filters = &#123;</span><br><span class="line">        <span class="string">'source_compute'</span>: self.host,</span><br><span class="line">        <span class="string">'status'</span>: [<span class="string">'accepted'</span>, <span class="string">'done'</span>],</span><br><span class="line">        <span class="string">'migration_type'</span>: <span class="string">'evacuation'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    evacuations = objects.MigrationList.get_by_filters(context, filters)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> evacuations:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    evacuations = &#123;mig.instance_uuid: mig <span class="keyword">for</span> mig <span class="keyword">in</span> evacuations&#125;</span><br><span class="line"></span><br><span class="line">    filters = &#123;<span class="string">'deleted'</span>: <span class="literal">False</span>&#125;</span><br><span class="line">    local_instances = self._get_instances_on_driver(context, filters)</span><br><span class="line">    evacuated = [inst <span class="keyword">for</span> inst <span class="keyword">in</span> local_instances</span><br><span class="line">                    <span class="keyword">if</span> inst.uuid <span class="keyword">in</span> evacuations]</span><br><span class="line">    <span class="keyword">for</span> instance <span class="keyword">in</span> evacuated:</span><br><span class="line">        migration = evacuations[instance.uuid]</span><br><span class="line">        LOG.info(_LI(<span class="string">'Deleting instance as it has been evacuated from '</span></span><br><span class="line">                        <span class="string">'this host'</span>), instance=instance)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            network_info = self.network_api.get_instance_nw_info(</span><br><span class="line">                context, instance)</span><br><span class="line">            bdi = self._get_instance_block_device_info(context,</span><br><span class="line">                                                        instance)</span><br><span class="line">            destroy_disks = <span class="keyword">not</span> (self._is_instance_storage_shared(</span><br><span class="line">                context, instance))</span><br><span class="line">        <span class="keyword">except</span> exception.InstanceNotFound:</span><br><span class="line">            network_info = network_model.NetworkInfo()</span><br><span class="line">            bdi = &#123;&#125;</span><br><span class="line">            LOG.info(_LI(<span class="string">'Instance has been marked deleted already, '</span></span><br><span class="line">                            <span class="string">'removing it from the hypervisor.'</span>),</span><br><span class="line">                        instance=instance)</span><br><span class="line">            <span class="comment"># always destroy disks if the instance was deleted</span></span><br><span class="line">            destroy_disks = <span class="literal">True</span></span><br><span class="line">        self.driver.destroy(context, instance,</span><br><span class="line">                            network_info,</span><br><span class="line">                            bdi, destroy_disks)</span><br><span class="line">        migration.status = <span class="string">'completed'</span></span><br><span class="line">        migration.save()</span><br></pre></td></tr></table></figure><p>会不会是疏散过程中触发了异常然后又重启了计算节点才导致的根磁盘被删除呢？</p><p>后来和同事商讨后发现我的思路错了，被上面<code>driver.destroy</code>这个名称误导，其实还有一个地方会进行删除磁盘行为，就是<code>spwan</code>函数:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spawn</span><span class="params">(self, context, instance, image_meta, injected_files,</span></span></span><br><span class="line"><span class="function"><span class="params">          admin_password, network_info=None, block_device_info=None)</span>:</span></span><br><span class="line">    disk_info = blockinfo.get_disk_info(CONF.libvirt.virt_type,</span><br><span class="line">                                        instance,</span><br><span class="line">                                        image_meta,</span><br><span class="line">                                        block_device_info)</span><br><span class="line">    ...</span><br><span class="line">    xml = self._get_guest_xml(context, instance, network_info,</span><br><span class="line">                                disk_info, image_meta,</span><br><span class="line">                                block_device_info=block_device_info)</span><br><span class="line">    self._create_domain_and_network(</span><br><span class="line">        context, xml, instance, network_info, disk_info,</span><br><span class="line">        block_device_info=block_device_info,</span><br><span class="line">        post_xml_callback=gen_confdrive,</span><br><span class="line">        destroy_disks_on_failure=<span class="literal">True</span>)</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_create_domain_and_network</span><span class="params">(self, context, xml, instance, network_info,</span></span></span><br><span class="line"><span class="function"><span class="params">                                disk_info, block_device_info=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                                power_on=True, reboot=False,</span></span></span><br><span class="line"><span class="function"><span class="params">                                vifs_already_plugged=False,</span></span></span><br><span class="line"><span class="function"><span class="params">                                post_xml_callback=None,</span></span></span><br><span class="line"><span class="function"><span class="params">                                destroy_disks_on_failure=False)</span>:</span></span><br><span class="line"></span><br><span class="line">    block_device_mapping = driver.block_device_info_get_mapping(</span><br><span class="line">        block_device_info)</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="comment"># Any other error, be sure to clean up</span></span><br><span class="line">        LOG.error(_LE(<span class="string">'Failed to start libvirt guest'</span>),</span><br><span class="line">                    instance=instance)</span><br><span class="line">        <span class="keyword">with</span> excutils.save_and_reraise_exception():</span><br><span class="line">            self._cleanup_failed_start(context, instance, network_info,</span><br><span class="line">                                        block_device_info, guest,</span><br><span class="line">                                        destroy_disks_on_failure)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_cleanup_failed_start</span><span class="params">(self, context, instance, network_info,</span></span></span><br><span class="line"><span class="function"><span class="params">                          block_device_info, guest, destroy_disks)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> guest <span class="keyword">and</span> guest.is_active():</span><br><span class="line">            guest.poweroff()</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        self.cleanup(context, instance, network_info=network_info,</span><br><span class="line">                    block_device_info=block_device_info,</span><br><span class="line">                    destroy_disks=destroy_disks)</span><br></pre></td></tr></table></figure><p>注意<code>spwan</code>调用<code>_create_domain_and_network</code>传递的参数<code>destroy_disks_on_failure=True</code>，如果发生异常则会进行关机以及执行<code>cleanup</code>函数且传递的<code>destroy_disks=True</code>。</p><p>在我们这个场景下，如果在<code>nova.conf</code>设置了内存超分比，而实际内存又不足的情况下，就会导致疏散失败根磁盘被删除的情况。看了一下目前s版的nova依然会存在这个问题。</p><p>后来反思，当找到删除磁盘的操作在<code>cleanup</code>函数中逆向查找调用时，居然鬼使神差的认为其他地方会调用<code>destroy</code>函数，忽略了其他地方调用<code>cleanup</code>函数的可能性，浪费了一定时间，下次调试时还是要一步一步回推才行。</p></div></div><div id="post-footer" class="post-footer main-content-wrap"><div class="post-footer-tags"><span class="text-color-light text-small">标签</span><br><a class="tag tag--primary tag--small t-link" href="/source/all-tags/Nova/">Nova</a></div><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2020/05/20/设计模式-享元模式/" data-tooltip="设计模式-享元模式"><i class="fa fa-angle-left"></i> <span class="hide-xs hide-sm text-small icon-ml">上一篇</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2020/01/08/设计模式-外观模式/" data-tooltip="设计模式-外观模式"><span class="hide-xs hide-sm text-small icon-mr">下一篇</span> <i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions"><i class="fa fa-share-alt"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-facebook-official"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-twitter"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-google-plus"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-weibo"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/&amp;title=OpenStack源码学习笔记5"><i class="fa fa-qq"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-star"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://widget.renren.com/dialog/share?resourceUrl=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-renren"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#"><i class="fa fa-list"></i></a></li></ul></div></div></article><footer id="footer" class="main-content-wrap"><span class="copyrights">Copyrights &copy; 2021 Roy. All Rights Reserved.</span></footer></div><div id="bottom-bar" class="post-bottom-bar" data-behavior="4"><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2020/05/20/设计模式-享元模式/" data-tooltip="设计模式-享元模式"><i class="fa fa-angle-left"></i> <span class="hide-xs hide-sm text-small icon-ml">上一篇</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2020/01/08/设计模式-外观模式/" data-tooltip="设计模式-外观模式"><span class="hide-xs hide-sm text-small icon-mr">下一篇</span> <i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions"><i class="fa fa-share-alt"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-facebook-official"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-twitter"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-google-plus"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-weibo"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/&amp;title=OpenStack源码学习笔记5"><i class="fa fa-qq"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-star"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://widget.renren.com/dialog/share?resourceUrl=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-renren"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#"><i class="fa fa-list"></i></a></li></ul></div></div><div id="share-options-bar" class="share-options-bar" data-behavior="4"><i id="btn-close-shareoptions" class="fa fa-close"></i><ul class="share-options"><li class="share-option"><a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-facebook-official"></i><span>分享到 Facebook</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-twitter"></i><span>分享到 Twitter</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-google-plus"></i><span>分享到 Google+</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://service.weibo.com/share/share.php?&amp;title=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-weibo"></i><span>分享到 Weibo</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/&amp;title=OpenStack源码学习笔记5"><i class="fa fa-qq"></i><span>分享到 QQ</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-star"></i><span>分享到 Qzone</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://widget.renren.com/dialog/share?resourceUrl=http://www.hi-roy.com/2020/03/30/OpenStack源码学习笔记5/"><i class="fa fa-renren"></i><span>分享到 Renren</span></a></li></ul></div></div><div id="about"><div id="about-card"><div id="about-btn-close"><i class="fa fa-remove"></i></div><img id="about-card-picture" src="/assets/images/my.jpg" alt="作者的图片"><h4 id="about-card-name">Roy</h4><div id="about-card-bio"><p>君以国士待我，我必以国士报君。</p></div><div id="about-card-job"><i class="fa fa-briefcase"></i><br><p>野生程序猿</p></div><div id="about-card-location"><i class="fa fa-map-marker"></i><br>China</div></div></div><div id="algolia-search-modal" class="modal-container"><div class="modal"><div class="modal-header"><span class="close-button"><i class="fa fa-close"></i></span> <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled"><span class="searchby-algolia-text text-color-light text-small">by</span> <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg"> </a><i class="search-icon fa fa-search"></i><form id="algolia-search-form"><input type="text" id="algolia-search-input" name="search" class="form-control input--large search-input" placeholder="Search "></form></div><div class="modal-body"><div class="no-result text-color-light text-center">没有找到文章</div><div class="results"><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/02/12/Ubuntu下Gogant的简易破墙术/"><h3 class="media-heading">Ubuntu下Gogant的简易破墙术</h3></a><span class="media-meta"><span class="media-date text-small">2013年2月12日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/10/31/python常用第三方库-转载/"><h3 class="media-heading">Python常用第三方库(转载)</h3></a><span class="media-meta"><span class="media-date text-small">2013年10月31日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/fedora19安装ar8161网卡驱动/"><h3 class="media-heading">fedora19安装ar8161网卡驱动</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/fedora19源，rpmforge，fastestmirror/"><h3 class="media-heading">fedora19源，rpmforge，fastestmirror</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/python中如何自定义解析域名/"><h3 class="media-heading">python中如何自定义解析域名</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/django版本更换/"><h3 class="media-heading">django版本更换</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/django-groundwork个人1-5-3修改版/"><h3 class="media-heading">django-groundwork个人1.5.3修改版</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/fedora19美化/"><h3 class="media-heading">fedora19美化</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/装饰器/"><h3 class="media-heading">装饰器</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/SVN常用操作/"><h3 class="media-heading">SVN常用操作</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div></div></div><div class="modal-footer"><p class="results-count text-medium" data-message-zero="没有找到文章" data-message-one="找到 1 篇文章" data-message-other="找到 {n} 篇文章">找到 234 篇文章</p></div></div></div><div id="cover" style="background-image:url(/assets/images/cover.jpg)"></div><script src="/assets/js/script-ivwiy10zeb8fifc4swnhkwneuk64y53w2scmdmtp8thi9cqfxh31aowtroaz.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment-with-locales.min.js"></script><script src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script><script>var algoliaClient=algoliasearch("51U8PIBLP6","16909d9ce1780cda71113841864e7aa8"),algoliaIndex=algoliaClient.initIndex("my-blog")</script></body></html>