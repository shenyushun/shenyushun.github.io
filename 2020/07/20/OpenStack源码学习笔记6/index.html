<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Hi!Roy!"><title>OpenStack源码学习笔记6 - Hi!Roy!</title><meta name="author" content="Roy"><link rel="icon" href="http://www.hi-roy.com/assets/images/favicon.ico"><link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml"><meta name="description" content="很久之前发现一个现象，在生产环境中配置了保留内存reserved_host_memory_mb以及 没配置 内存超分比ram_allocation_ratio的情况下，虚拟机使用的内存居然已经快将物理内存耗尽了。比如物理机内存300G，方便举例忽略掉一些系统占用，当设置了reserved_host_memory_mb为20G，那么理论上所有虚拟机最大占用内存量为280G，而查看居然已经使用了290"><meta name="keywords" content="Nova"><meta property="og:type" content="blog"><meta property="og:title" content="OpenStack源码学习笔记6"><meta property="og:url" content="http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/index.html"><meta property="og:site_name" content="Hi!Roy!"><meta property="og:description" content="很久之前发现一个现象，在生产环境中配置了保留内存reserved_host_memory_mb以及 没配置 内存超分比ram_allocation_ratio的情况下，虚拟机使用的内存居然已经快将物理内存耗尽了。比如物理机内存300G，方便举例忽略掉一些系统占用，当设置了reserved_host_memory_mb为20G，那么理论上所有虚拟机最大占用内存量为280G，而查看居然已经使用了290"><meta property="og:locale" content="zh-cn"><meta property="og:updated_time" content="2020-07-20T09:16:12.821Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="OpenStack源码学习笔记6"><meta name="twitter:description" content="很久之前发现一个现象，在生产环境中配置了保留内存reserved_host_memory_mb以及 没配置 内存超分比ram_allocation_ratio的情况下，虚拟机使用的内存居然已经快将物理内存耗尽了。比如物理机内存300G，方便举例忽略掉一些系统占用，当设置了reserved_host_memory_mb为20G，那么理论上所有虚拟机最大占用内存量为280G，而查看居然已经使用了290"><meta property="og:image" content="http://www.hi-roy.com/assets/images/my.jpg"><link rel="stylesheet" href="/assets/css/style-sxklfps8ywgfyyjcowvnb4gxdgt0zjts3hsguljmv9uqanxjbnitrovtbrek.min.css"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?21513ec2bcd577b3297a1b16da82fa40";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body><div id="blog"><header id="header" data-behavior="4"><i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i><div class="header-title"><a class="header-title-link" href="/">Hi!Roy!</a></div><a class="header-right-icon" href="#about"><i class="fa fa-lg fa-question"></i></a></header><nav id="sidebar" data-behavior="4"><div class="sidebar-container"><div class="sidebar-profile"><a href="/#about"><img class="sidebar-profile-picture" src="/assets/images/my.jpg" alt="作者的图片"></a><h4 class="sidebar-profile-name">Roy</h4><h5 class="sidebar-profile-bio"><p>君以国士待我，我必以国士报君。</p></h5></div><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/"><i class="sidebar-button-icon fa fa-lg fa-home"></i> <span class="sidebar-button-desc">首页</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-categories"><i class="sidebar-button-icon fa fa-lg fa-bookmark"></i> <span class="sidebar-button-desc">分类</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-tags"><i class="sidebar-button-icon fa fa-lg fa-tags"></i> <span class="sidebar-button-desc">标签</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-archives"><i class="sidebar-button-icon fa fa-lg fa-archive"></i> <span class="sidebar-button-desc">归档</span></a></li><li class="sidebar-button"><a class="sidebar-button-link open-algolia-search" href="#search"><i class="sidebar-button-icon fa fa-lg fa-search"></i> <span class="sidebar-button-desc">搜索</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="#about"><i class="sidebar-button-icon fa fa-lg fa-question"></i> <span class="sidebar-button-desc">关于</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="https://github.com/shenyushun" target="_blank" rel="noopener"><i class="sidebar-button-icon fa fa-lg fa-github"></i> <span class="sidebar-button-desc">GitHub</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="mailto:darkcooking@gmail.com" target="_blank" rel="noopener"><i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i> <span class="sidebar-button-desc">邮箱</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/atom.xml"><i class="sidebar-button-icon fa fa-lg fa-rss"></i> <span class="sidebar-button-desc">RSS</span></a></li></ul></div></nav><div id="main" data-behavior="4" class="hasCoverMetaIn"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><div class="post-header main-content-wrap text-left"><h1 class="post-title" itemprop="headline">OpenStack源码学习笔记6</h1><div class="post-meta"><time itemprop="datePublished" datetime="2020-07-20T17:46:29+08:00">7月 20, 2020 </time><span>发布在 </span><a class="category-link" href="/source/all-categories/Python/">Python</a>, <a class="category-link" href="/source/all-categories/Python/OpenStack/">OpenStack</a></div></div><div class="post-content markdown" itemprop="articleBody"><div class="main-content-wrap"><p>很久之前发现一个现象，在生产环境中配置了保留内存<code>reserved_host_memory_mb</code>以及 <strong>没配置</strong> 内存超分比<code>ram_allocation_ratio</code>的情况下，虚拟机使用的内存居然已经快将物理内存耗尽了。</p><p>比如物理机内存300G，方便举例忽略掉一些系统占用，当设置了<code>reserved_host_memory_mb</code>为20G，那么理论上所有虚拟机最大占用内存量为280G，而查看居然已经使用了290G的内存，还是在虚拟机并没有将各自申请的内存全部使用掉的情况下(比如申请一台4G的虚拟机，但物理机操作系统层面并没有分配4G给对应的进程，除非虚拟机内部把内存占满)。</p><p>单单就nova而言，如果在集群启动时就指定了保留内存大小和超分比为1的话，是不应该出现上述情形的。除非后期对这2个参数进行过修改，但由于年代久远已经没法追溯，这也就成了一桩悬案。</p><p>不过在追踪这个问题的过程中，顺便也学习了下主机热迁移的过程，这里的代码是 <strong><em>N版</em></strong> 。</p><a id="more"></a><p>根据之前文章写过的套路，这里直接定位到<code>api/openstack/compute/migrate_server.py</code>的<code>_migrate_live</code>函数，这个函数很简单就不贴代码了，就是解析请求中的虚拟机ID、目标主机等参数，然后调用<code>compute/api.py</code>中<code>API</code>类的<code>live_migrate</code>函数：</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@check_instance_lock</span></span><br><span class="line"><span class="meta">@check_instance_cell</span></span><br><span class="line"><span class="meta">@check_instance_state(vm_state=[vm_states.ACTIVE, vm_states.PAUSED])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">live_migrate</span><span class="params">(self, context, instance, block_migration,</span></span></span><br><span class="line"><span class="function"><span class="params">                    disk_over_commit, host_name, force=None, async=False)</span>:</span></span><br><span class="line">    <span class="string">"""Migrate a server lively to a new host."""</span></span><br><span class="line"></span><br><span class="line">    instance.task_state = task_states.MIGRATING</span><br><span class="line">    instance.save(expected_task_state=[<span class="literal">None</span>])</span><br><span class="line"></span><br><span class="line">    self._record_action_start(context, instance,</span><br><span class="line">                                instance_actions.LIVE_MIGRATION)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        request_spec = objects.RequestSpec.get_by_instance_uuid(</span><br><span class="line">            context, instance.uuid)</span><br><span class="line">    <span class="keyword">except</span> exception.RequestSpecNotFound:</span><br><span class="line">        request_spec = <span class="literal">None</span></span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        self.compute_task_api.live_migrate_instance(context, instance,</span><br><span class="line">            host_name, block_migration=block_migration,</span><br><span class="line">            disk_over_commit=disk_over_commit,</span><br><span class="line">            request_spec=request_spec, <span class="keyword">async</span>=<span class="keyword">async</span>)</span><br><span class="line">    <span class="keyword">except</span> oslo_exceptions.MessagingTimeout <span class="keyword">as</span> messaging_timeout:</span><br><span class="line">        <span class="keyword">with</span> excutils.save_and_reraise_exception():</span><br><span class="line">            compute_utils.add_instance_fault_from_exc(context,</span><br><span class="line">                                                        instance,</span><br><span class="line">                                                        messaging_timeout)</span><br></pre></td></tr></table></figure><p>这个函数修改了主机状态为migrating，获取虚拟机参数(这里有个细节，request_spec这个东西记录在nova-api库里而非nova库)，创建操作记录，由于我们调用的api版本还不支持force参数这部分代码就不贴了，具体可参考<a href="https://docs.openstack.org/api-ref/compute/?expanded=create-server-detail,migrate-server-migrate-action-detail,live-migrate-server-os-migratelive-action-detail#create-server" target="_blank" rel="noopener">这里</a></p><p>然后调用<code>live_migrate_instance</code>函数位于<code>conductor/api.py</code>中:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">live_migrate_instance</span><span class="params">(self, context, instance, host_name,</span></span></span><br><span class="line"><span class="function"><span class="params">                          block_migration, disk_over_commit,</span></span></span><br><span class="line"><span class="function"><span class="params">                          request_spec=None, async=False)</span>:</span></span><br><span class="line">    scheduler_hint = &#123;<span class="string">'host'</span>: host_name&#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">async</span>:</span><br><span class="line">        self.conductor_compute_rpcapi.live_migrate_instance(</span><br><span class="line">            context, instance, scheduler_hint, block_migration,</span><br><span class="line">            disk_over_commit, request_spec)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.conductor_compute_rpcapi.migrate_server(</span><br><span class="line">            context, instance, scheduler_hint, <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">None</span>,</span><br><span class="line">            block_migration, disk_over_commit, <span class="literal">None</span>,</span><br><span class="line">            request_spec=request_spec)</span><br></pre></td></tr></table></figure><p>注意这里可能由于代码版本原因，这里就是直接固定为传入的主机名称的。然后进入rpc调用，位于<code>conductor/rpcapi.py</code>:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">migrate_server</span><span class="params">(self, context, instance, scheduler_hint, live, rebuild,</span></span></span><br><span class="line"><span class="function"><span class="params">                  flavor, block_migration, disk_over_commit,</span></span></span><br><span class="line"><span class="function"><span class="params">                  reservations=None, clean_shutdown=True, request_spec=None)</span>:</span></span><br><span class="line">    kw = &#123;<span class="string">'instance'</span>: instance, <span class="string">'scheduler_hint'</span>: scheduler_hint,</span><br><span class="line">            <span class="string">'live'</span>: live, <span class="string">'rebuild'</span>: rebuild, <span class="string">'flavor'</span>: flavor,</span><br><span class="line">            <span class="string">'block_migration'</span>: block_migration,</span><br><span class="line">            <span class="string">'disk_over_commit'</span>: disk_over_commit,</span><br><span class="line">            <span class="string">'reservations'</span>: reservations,</span><br><span class="line">            <span class="string">'clean_shutdown'</span>: clean_shutdown,</span><br><span class="line">            <span class="string">'request_spec'</span>: request_spec,</span><br><span class="line">            &#125;</span><br><span class="line">    ......</span><br><span class="line">    cctxt = self.client.prepare(version=version)</span><br><span class="line">    <span class="keyword">return</span> cctxt.call(context, <span class="string">'migrate_server'</span>, **kw)</span><br></pre></td></tr></table></figure><p>这个函数进行了一堆版本兼容性判断，然后进入<code>conductor/manager.py</code>的<code>migrate_server</code>函数:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">migrate_server</span><span class="params">(self, context, instance, scheduler_hint, live, rebuild,</span></span></span><br><span class="line"><span class="function"><span class="params">            flavor, block_migration, disk_over_commit, reservations=None,</span></span></span><br><span class="line"><span class="function"><span class="params">            clean_shutdown=True, request_spec=None)</span>:</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> live <span class="keyword">and</span> <span class="keyword">not</span> rebuild <span class="keyword">and</span> <span class="keyword">not</span> flavor:</span><br><span class="line">        self._live_migrate(context, instance, scheduler_hint,</span><br><span class="line">                            block_migration, disk_over_commit, request_spec)</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p>由于这里我们仅关注热迁移就直接跟进<code>_live_migrate</code>:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_live_migrate</span><span class="params">(self, context, instance, scheduler_hint,</span></span></span><br><span class="line"><span class="function"><span class="params">                      block_migration, disk_over_commit, request_spec)</span>:</span></span><br><span class="line">    destination = scheduler_hint.get(<span class="string">"host"</span>)</span><br><span class="line">    migration = objects.Migration(context=context.elevated())</span><br><span class="line">    ......</span><br><span class="line">    migration.create()</span><br><span class="line">    task = self._build_live_migrate_task(context, instance, destination,</span><br><span class="line">                                        block_migration, disk_over_commit,</span><br><span class="line">                                        migration, request_spec)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        task.execute()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_build_live_migrate_task</span><span class="params">(self, context, instance, destination,</span></span></span><br><span class="line"><span class="function"><span class="params">                            block_migration, disk_over_commit, migration,</span></span></span><br><span class="line"><span class="function"><span class="params">                            request_spec=None)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> live_migrate.LiveMigrationTask(context, instance,</span><br><span class="line">                                            destination, block_migration,</span><br><span class="line">                                            disk_over_commit, migration,</span><br><span class="line">                                            self.compute_rpcapi,</span><br><span class="line">                                            self.servicegroup_api,</span><br><span class="line">                                            self.scheduler_client,</span><br><span class="line">                                            request_spec)</span><br></pre></td></tr></table></figure><p>这个函数就是创建了一条数据库迁移记录，然后继续跟进到<code>conductor/tasks/live_migrate.py</code>:</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LiveMigrationTask</span><span class="params">(base.TaskBase)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, context, instance, destination,</span></span></span><br><span class="line"><span class="function"><span class="params">                 block_migration, disk_over_commit, migration, compute_rpcapi,</span></span></span><br><span class="line"><span class="function"><span class="params">                 servicegroup_api, scheduler_client, request_spec=None)</span>:</span></span><br><span class="line">        super(LiveMigrationTask, self).__init__(context, instance)</span><br><span class="line">        self.destination = destination</span><br><span class="line">        self.block_migration = block_migration</span><br><span class="line">        self.disk_over_commit = disk_over_commit</span><br><span class="line">        self.migration = migration</span><br><span class="line">        self.source = instance.host</span><br><span class="line">        self.migrate_data = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        self.compute_rpcapi = compute_rpcapi</span><br><span class="line">        self.servicegroup_api = servicegroup_api</span><br><span class="line">        self.scheduler_client = scheduler_client</span><br><span class="line">        self.request_spec = request_spec</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_execute</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._check_instance_is_active()</span><br><span class="line">        self._check_host_is_up(self.source)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.destination:</span><br><span class="line">            self.destination = self._find_destination()</span><br><span class="line">            self.migration.dest_compute = self.destination</span><br><span class="line">            self.migration.save()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._check_requested_destination()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.compute_rpcapi.live_migration(self.context,</span><br><span class="line">                host=self.source,</span><br><span class="line">                instance=self.instance,</span><br><span class="line">                dest=self.destination,</span><br><span class="line">                block_migration=self.block_migration,</span><br><span class="line">                migration=self.migration,</span><br><span class="line">                migrate_data=self.migrate_data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_check_requested_destination</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._check_destination_is_not_source()</span><br><span class="line">        self._check_host_is_up(self.destination)</span><br><span class="line">        self._check_destination_has_enough_memory()</span><br><span class="line">        self._check_compatible_with_source_hypervisor(self.destination)</span><br><span class="line">        self._call_livem_checks_on_host(self.destination)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_check_destination_has_enough_memory</span><span class="params">(self)</span>:</span></span><br><span class="line">        compute = self._get_compute_info(self.destination)</span><br><span class="line">        free_ram_mb = compute.free_ram_mb</span><br><span class="line">        total_ram_mb = compute.memory_mb</span><br><span class="line">        mem_inst = self.instance.memory_mb</span><br><span class="line">        <span class="comment"># NOTE(sbauza): Now the ComputeNode object reports an allocation ratio</span></span><br><span class="line">        <span class="comment"># that can be provided by the compute_node if new or by the controller</span></span><br><span class="line">        ram_ratio = compute.ram_allocation_ratio</span><br><span class="line"></span><br><span class="line">        <span class="comment"># NOTE(sbauza): Mimic the RAMFilter logic in order to have the same</span></span><br><span class="line">        <span class="comment"># ram validation</span></span><br><span class="line">        avail = total_ram_mb * ram_ratio - (total_ram_mb - free_ram_mb)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> mem_inst <span class="keyword">or</span> avail &lt;= mem_inst:</span><br><span class="line">            instance_uuid = self.instance.uuid</span><br><span class="line">            dest = self.destination</span><br><span class="line">            reason = _(<span class="string">"Unable to migrate %(instance_uuid)s to %(dest)s: "</span></span><br><span class="line">                       <span class="string">"Lack of memory(host:%(avail)s &lt;= "</span></span><br><span class="line">                       <span class="string">"instance:%(mem_inst)s)"</span>)</span><br><span class="line">            <span class="keyword">raise</span> exception.MigrationPreCheckError(reason=reason % dict(</span><br><span class="line">                    instance_uuid=instance_uuid, dest=dest, avail=avail,</span><br><span class="line">                    mem_inst=mem_inst))</span><br></pre></td></tr></table></figure><p>重点是<code>_execute</code>这个函数，首先进行状态检查，然后判断是否传入了目标计算节点，如果传入了在依次检查源节点和目标节点是否是同一台机器、目标节点是否运行、目标节点内存是否充足、虚拟化类型是否一致、是否准许热迁移；如果没传入则调用<code>scheduler</code>的<code>select_destinations</code>函数来筛选目标节点。</p><p>然后再调用<code>compute/rpcapi.py</code>中<code>ComputeAPI</code>类的<code>live_migrate</code>函数，这个函数又调用了<code>compute/manager.py</code>中<code>ComputeManager</code>类的<code>live_migrate</code>函数，这里设置状态为<code>queued</code>，然后开新线程处理请求：</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">live_migration</span><span class="params">(self, context, dest, instance, block_migration,</span></span></span><br><span class="line"><span class="function"><span class="params">                       migration, migrate_data)</span>:</span></span><br><span class="line">    <span class="string">"""Executing live migration.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    self._set_migration_status(migration, <span class="string">'queued'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch_live_migration</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> self._live_migration_semaphore:</span><br><span class="line">            self._do_live_migration(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># NOTE(danms): We spawn here to return the RPC worker thread back to</span></span><br><span class="line">    <span class="comment"># the pool. Since what follows could take a really long time, we don't</span></span><br><span class="line">    <span class="comment"># want to tie up RPC workers.</span></span><br><span class="line">    utils.spawn_n(dispatch_live_migration,</span><br><span class="line">                    context, dest, instance,</span><br><span class="line">                    block_migration, migration,</span><br><span class="line">                    migrate_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_do_live_migration</span><span class="params">(self, context, dest, instance, block_migration,</span></span></span><br><span class="line"><span class="function"><span class="params">                        migration, migrate_data)</span>:</span></span><br><span class="line">    <span class="comment"># NOTE(danms): We should enhance the RT to account for migrations</span></span><br><span class="line">    <span class="comment"># and use the status field to denote when the accounting has been</span></span><br><span class="line">    <span class="comment"># done on source/destination. For now, this is just here for status</span></span><br><span class="line">    <span class="comment"># reporting</span></span><br><span class="line">    self._set_migration_status(migration, <span class="string">'preparing'</span>)</span><br><span class="line"></span><br><span class="line">    got_migrate_data_object = isinstance(migrate_data,</span><br><span class="line">                                         migrate_data_obj.LiveMigrateData)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> got_migrate_data_object:</span><br><span class="line">        migrate_data = \</span><br><span class="line">            migrate_data_obj.LiveMigrateData.detect_implementation(</span><br><span class="line">                migrate_data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ......</span><br><span class="line">        migrate_data = self.compute_rpcapi.pre_live_migration(context, instance,</span><br><span class="line">                                                              block_migration, disk, dest, migrate_data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">with</span> excutils.save_and_reraise_exception():</span><br><span class="line">            LOG.exception(_LE(<span class="string">'Pre live migration failed at %s'</span>),</span><br><span class="line">                            dest, instance=instance)</span><br><span class="line">            self._set_migration_status(migration, <span class="string">'error'</span>)</span><br><span class="line">            self._rollback_live_migration(context, instance, dest,</span><br><span class="line">                                            block_migration, migrate_data)</span><br><span class="line"></span><br><span class="line">    self._set_migration_status(migration, <span class="string">'running'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> migrate_data:</span><br><span class="line">        migrate_data.migration = migration</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        self.driver.live_migration(context, instance, dest,</span><br><span class="line">                                    self._post_live_migration,</span><br><span class="line">                                    self._rollback_live_migration,</span><br><span class="line">                                    block_migration, migrate_data)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure><p>最终的<code>pre_live_migration</code>函数位于<code>compute/manager.py</code>，代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pre_live_migration</span><span class="params">(self, context, instance, block_migration, disk,</span></span></span><br><span class="line"><span class="function"><span class="params">                           migrate_data)</span>:</span></span><br><span class="line">    <span class="string">"""Preparations for live migration at dest host.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    LOG.debug(<span class="string">'pre_live_migration data is %s'</span>, migrate_data)</span><br><span class="line">    <span class="comment"># TODO(tdurakov): remove dict to object conversion once RPC API version</span></span><br><span class="line">    <span class="comment"># is bumped to 5.x</span></span><br><span class="line">    got_migrate_data_object = isinstance(migrate_data,</span><br><span class="line">                                            migrate_data_obj.LiveMigrateData)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> got_migrate_data_object:</span><br><span class="line">        migrate_data = \</span><br><span class="line">            migrate_data_obj.LiveMigrateData.detect_implementation(</span><br><span class="line">                migrate_data)</span><br><span class="line"></span><br><span class="line">    block_device_info = self._get_instance_block_device_info(</span><br><span class="line">                        context, instance, refresh_conn_info=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    network_info = self.network_api.get_instance_nw_info(context, instance)</span><br><span class="line">    self._notify_about_instance_usage(</span><br><span class="line">                    context, instance, <span class="string">"live_migration.pre.start"</span>,</span><br><span class="line">                    network_info=network_info)</span><br><span class="line"></span><br><span class="line">    migrate_data = self.driver.pre_live_migration(context,</span><br><span class="line">                                    instance,</span><br><span class="line">                                    block_device_info,</span><br><span class="line">                                    network_info,</span><br><span class="line">                                    disk,</span><br><span class="line">                                    migrate_data)</span><br><span class="line">    LOG.debug(<span class="string">'driver pre_live_migration data is %s'</span> % migrate_data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># NOTE(tr3buchet): setup networks on destination host</span></span><br><span class="line">    self.network_api.setup_networks_on_host(context, instance, self.host)</span><br><span class="line"></span><br><span class="line">    self.driver.ensure_filtering_rules_for_instance(instance, network_info)</span><br><span class="line"></span><br><span class="line">    self._notify_about_instance_usage(</span><br><span class="line">                    context, instance, <span class="string">"live_migration.pre.end"</span>,</span><br><span class="line">                    network_info=network_info)</span><br><span class="line">    <span class="comment"># TODO(tdurakov): remove dict to object conversion once RPC API version</span></span><br><span class="line">    <span class="comment"># is bumped to 5.x</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> got_migrate_data_object <span class="keyword">and</span> migrate_data:</span><br><span class="line">        migrate_data = migrate_data.to_legacy_dict(</span><br><span class="line">            pre_migration_result=<span class="literal">True</span>)</span><br><span class="line">        migrate_data = migrate_data[<span class="string">'pre_live_migration_result'</span>]</span><br><span class="line">    LOG.debug(<span class="string">'pre_live_migration result data is %s'</span>, migrate_data)</span><br><span class="line">    <span class="keyword">return</span> migrate_data</span><br></pre></td></tr></table></figure><p>具体的位于<code>virt/libvirt/driver.py</code>的同名函数我这里就不贴了，就是进行磁盘、网络相关操作。最后依次调用<code>virt/libvirt/driver.py</code>的<code>_live_migration</code>、<code>_live_migration_operation</code>，进入<code>virt/libvirt/guest.py</code>中<code>Guest</code>类的<code>migrate</code>函数，最终交给了libvirt处理。</p><p>至此，nova的使命大部分完成，剩下的就是等待迁移状态回写数据库了。</p></div></div><div id="post-footer" class="post-footer main-content-wrap"><div class="post-footer-tags"><span class="text-color-light text-small">标签</span><br><a class="tag tag--primary tag--small t-link" href="/source/all-tags/Nova/">Nova</a></div><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--disabled"><i class="fa fa-angle-left"></i> <span class="hide-xs hide-sm text-small icon-ml">上一篇</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2020/05/20/设计模式-享元模式/" data-tooltip="设计模式-享元模式"><span class="hide-xs hide-sm text-small icon-mr">下一篇</span> <i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions"><i class="fa fa-share-alt"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-facebook-official"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-twitter"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-google-plus"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-weibo"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/&amp;title=OpenStack源码学习笔记6"><i class="fa fa-qq"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-star"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://widget.renren.com/dialog/share?resourceUrl=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-renren"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#"><i class="fa fa-list"></i></a></li></ul></div></div></article><footer id="footer" class="main-content-wrap"><span class="copyrights">Copyrights &copy; 2020 Roy. All Rights Reserved.</span></footer></div><div id="bottom-bar" class="post-bottom-bar" data-behavior="4"><div class="post-actions-wrap"><nav><ul class="post-actions post-action-nav"><li class="post-action"><a class="post-action-btn btn btn--disabled"><i class="fa fa-angle-left"></i> <span class="hide-xs hide-sm text-small icon-ml">上一篇</span></a></li><li class="post-action"><a class="post-action-btn btn btn--default tooltip--top" href="/2020/05/20/设计模式-享元模式/" data-tooltip="设计模式-享元模式"><span class="hide-xs hide-sm text-small icon-mr">下一篇</span> <i class="fa fa-angle-right"></i></a></li></ul></nav><ul class="post-actions post-action-share"><li class="post-action hide-lg hide-md hide-sm"><a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions"><i class="fa fa-share-alt"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-facebook-official"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-twitter"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-google-plus"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://service.weibo.com/share/share.php?&amp;title=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-weibo"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/&amp;title=OpenStack源码学习笔记6"><i class="fa fa-qq"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-star"></i></a></li><li class="post-action hide-xs"><a class="post-action-btn btn btn--default" target="new" href="http://widget.renren.com/dialog/share?resourceUrl=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-renren"></i></a></li><li class="post-action"><a class="post-action-btn btn btn--default" href="#"><i class="fa fa-list"></i></a></li></ul></div></div><div id="share-options-bar" class="share-options-bar" data-behavior="4"><i id="btn-close-shareoptions" class="fa fa-close"></i><ul class="share-options"><li class="share-option"><a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-facebook-official"></i><span>分享到 Facebook</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-twitter"></i><span>分享到 Twitter</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-google-plus"></i><span>分享到 Google+</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://service.weibo.com/share/share.php?&amp;title=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-weibo"></i><span>分享到 Weibo</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/&amp;title=OpenStack源码学习笔记6"><i class="fa fa-qq"></i><span>分享到 QQ</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-star"></i><span>分享到 Qzone</span></a></li><li class="share-option"><a class="share-option-btn" target="new" href="http://widget.renren.com/dialog/share?resourceUrl=http://www.hi-roy.com/2020/07/20/OpenStack源码学习笔记6/"><i class="fa fa-renren"></i><span>分享到 Renren</span></a></li></ul></div></div><div id="about"><div id="about-card"><div id="about-btn-close"><i class="fa fa-remove"></i></div><img id="about-card-picture" src="/assets/images/my.jpg" alt="作者的图片"><h4 id="about-card-name">Roy</h4><div id="about-card-bio"><p>君以国士待我，我必以国士报君。</p></div><div id="about-card-job"><i class="fa fa-briefcase"></i><br><p>野生程序猿</p></div><div id="about-card-location"><i class="fa fa-map-marker"></i><br>China</div></div></div><div id="algolia-search-modal" class="modal-container"><div class="modal"><div class="modal-header"><span class="close-button"><i class="fa fa-close"></i></span> <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled"><span class="searchby-algolia-text text-color-light text-small">by</span> <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg"> </a><i class="search-icon fa fa-search"></i><form id="algolia-search-form"><input type="text" id="algolia-search-input" name="search" class="form-control input--large search-input" placeholder="Search "></form></div><div class="modal-body"><div class="no-result text-color-light text-center">没有找到文章</div><div class="results"><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/02/12/Ubuntu下Gogant的简易破墙术/"><h3 class="media-heading">Ubuntu下Gogant的简易破墙术</h3></a><span class="media-meta"><span class="media-date text-small">2013年2月12日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/10/31/python常用第三方库-转载/"><h3 class="media-heading">Python常用第三方库(转载)</h3></a><span class="media-meta"><span class="media-date text-small">2013年10月31日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/fedora19安装ar8161网卡驱动/"><h3 class="media-heading">fedora19安装ar8161网卡驱动</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/fedora19源，rpmforge，fastestmirror/"><h3 class="media-heading">fedora19源，rpmforge，fastestmirror</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/python中如何自定义解析域名/"><h3 class="media-heading">python中如何自定义解析域名</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/django版本更换/"><h3 class="media-heading">django版本更换</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/django-groundwork个人1-5-3修改版/"><h3 class="media-heading">django-groundwork个人1.5.3修改版</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/fedora19美化/"><h3 class="media-heading">fedora19美化</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/装饰器/"><h3 class="media-heading">装饰器</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/SVN常用操作/"><h3 class="media-heading">SVN常用操作</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div></div></div><div class="modal-footer"><p class="results-count text-medium" data-message-zero="没有找到文章" data-message-one="找到 1 篇文章" data-message-other="找到 {n} 篇文章">找到 231 篇文章</p></div></div></div><div id="cover" style="background-image:url(/assets/images/cover.jpg)"></div><script src="/assets/js/script-ivwiy10zeb8fifc4swnhkwneuk64y53w2scmdmtp8thi9cqfxh31aowtroaz.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment-with-locales.min.js"></script><script src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script><script>var algoliaClient=algoliasearch("51U8PIBLP6","16909d9ce1780cda71113841864e7aa8"),algoliaIndex=algoliaClient.initIndex("my-blog")</script></body></html>