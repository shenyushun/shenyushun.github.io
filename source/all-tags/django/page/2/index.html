<!DOCTYPE html><html lang="zh-cn"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="Hi!Roy!"><title>标签: django - Hi!Roy!</title><meta name="author" content="Roy"><link rel="icon" href="http://www.hi-roy.com/assets/images/favicon.ico"><link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml"><meta property="og:type" content="blog"><meta property="og:title" content="Hi!Roy!"><meta property="og:url" content="http://www.hi-roy.com/source/all-tags/django/page/2/index.html"><meta property="og:site_name" content="Hi!Roy!"><meta property="og:locale" content="zh-cn"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Hi!Roy!"><meta property="og:image" content="http://www.hi-roy.com/assets/images/my.jpg"><link rel="stylesheet" href="/assets/css/style-sxklfps8ywgfyyjcowvnb4gxdgt0zjts3hsguljmv9uqanxjbnitrovtbrek.min.css"><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?21513ec2bcd577b3297a1b16da82fa40";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body><div id="blog"><header id="header" data-behavior="1"><i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i><div class="header-title"><a class="header-title-link" href="/">Hi!Roy!</a></div><a class="header-right-icon" href="#about"><i class="fa fa-lg fa-question"></i></a></header><nav id="sidebar" data-behavior="1"><div class="sidebar-container"><div class="sidebar-profile"><a href="/#about"><img class="sidebar-profile-picture" src="/assets/images/my.jpg" alt="作者的图片"></a><h4 class="sidebar-profile-name">Roy</h4><h5 class="sidebar-profile-bio"><p>君以国士待我，我必以国士报君。</p></h5></div><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/"><i class="sidebar-button-icon fa fa-lg fa-home"></i> <span class="sidebar-button-desc">首页</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-categories"><i class="sidebar-button-icon fa fa-lg fa-bookmark"></i> <span class="sidebar-button-desc">分类</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-tags"><i class="sidebar-button-icon fa fa-lg fa-tags"></i> <span class="sidebar-button-desc">标签</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="/all-archives"><i class="sidebar-button-icon fa fa-lg fa-archive"></i> <span class="sidebar-button-desc">归档</span></a></li><li class="sidebar-button"><a class="sidebar-button-link open-algolia-search" href="#search"><i class="sidebar-button-icon fa fa-lg fa-search"></i> <span class="sidebar-button-desc">搜索</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="#about"><i class="sidebar-button-icon fa fa-lg fa-question"></i> <span class="sidebar-button-desc">关于</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="https://github.com/shenyushun" target="_blank" rel="noopener"><i class="sidebar-button-icon fa fa-lg fa-github"></i> <span class="sidebar-button-desc">GitHub</span></a></li><li class="sidebar-button"><a class="sidebar-button-link" href="mailto:darkcooking@gmail.com" target="_blank" rel="noopener"><i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i> <span class="sidebar-button-desc">邮箱</span></a></li></ul><ul class="sidebar-buttons"><li class="sidebar-button"><a class="sidebar-button-link" href="/atom.xml"><i class="sidebar-button-icon fa fa-lg fa-rss"></i> <span class="sidebar-button-desc">RSS</span></a></li></ul></div></nav><div id="main" data-behavior="1" class="hasCoverMetaIn"><section class="postShorten-group main-content-wrap"><article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemtype="http://schema.org/BlogPosting"><div class="postShorten-wrap"><div class="postShorten-header"><h1 class="postShorten-title" itemprop="headline"><a class="link-unstyled" href="/2016/02/24/解决flower-Substantial-drift-from-may-mean-clocks-are-out-of-sync错误/">解决flower Substantial drift from.. may mean clocks are out of sync错误</a></h1><div class="postShorten-meta"><time itemprop="datePublished" datetime="2016-02-24T14:27:30+08:00">2月 24, 2016 </time><span>发布在 </span><a class="category-link" href="/source/all-categories/Centos/">Centos</a></div></div><div class="postShorten-content" itemprop="articleBody"><p>打开flower的监控页面，发现monitor页的succeeded tasks图表始终为空，打印日志发现有下面的警告：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[2016-02-24 12:00:21,799: WARNING/MainProcess] celery@localhost.localdomain ready.</span><br><span class="line">[2016-02-24 12:00:22,297: WARNING/MainProcess] Substantial drift from celery@centos7-181 may mean clocks are out of sync.  Current drift is</span><br><span class="line">70 seconds.  [orig: 2016-02-24 12:00:22.297798 recv: 2016-02-24 11:59:12.438481]</span><br><span class="line">[2016-02-24 12:00:22,300: WARNING/MainProcess] Substantial drift from celery@centos7-xiaoqiao may mean clocks are out of sync.  Current drift is</span><br><span class="line">764 seconds.  [orig: 2016-02-24 12:00:22.300171 recv: 2016-02-24 11:47:38.863792]</span><br><span class="line">[2016-02-24 12:00:22,302: WARNING/MainProcess] Substantial drift from celery@centos7-186 may mean clocks are out of sync.  Current drift is</span><br><span class="line">65 seconds.  [orig: 2016-02-24 12:00:22.302378 recv: 2016-02-24 11:59:17.157844]</span><br><span class="line">[2016-02-24 12:00:22,303: WARNING/MainProcess] Substantial drift from celery@centos7-182 may mean clocks are out of sync.  Current drift is</span><br><span class="line">70 seconds.  [orig: 2016-02-24 12:00:22.303616 recv: 2016-02-24 11:59:12.633749]</span><br><span class="line">[2016-02-24 12:00:22,306: WARNING/MainProcess] Substantial drift from celery@centos7-189 may mean clocks are out of sync.  Current drift is</span><br><span class="line">64 seconds.  [orig: 2016-02-24 12:00:22.306499 recv: 2016-02-24 11:59:18.100351]</span><br><span class="line">[2016-02-24 12:00:22,307: WARNING/MainProcess] Substantial drift from celery@centos7-188 may mean clocks are out of sync.  Current drift is</span><br><span class="line">65 seconds.  [orig: 2016-02-24 12:00:22.307066 recv: 2016-02-24 11:59:17.197479]</span><br><span class="line">[2016-02-24 12:00:22,310: WARNING/MainProcess] Substantial drift from celery@centos7-184 may mean clocks are out of sync.  Current drift is</span><br><span class="line">64 seconds.  [orig: 2016-02-24 12:00:22.309941 recv: 2016-02-24 11:59:18.490792]</span><br><span class="line">[2016-02-24 12:00:22,524: WARNING/MainProcess] Substantial drift from celery@centos7-183 may mean clocks are out of sync.  Current drift is</span><br><span class="line">64 seconds.  [orig: 2016-02-24 12:00:22.524618 recv: 2016-02-24 11:59:18.005931]</span><br><span class="line">[2016-02-24 12:00:22,525: WARNING/MainProcess] Substantial drift from celery@centos7-187 may mean clocks are out of sync.  Current drift is</span><br><span class="line">70 seconds.  [orig: 2016-02-24 12:00:22.525161 recv: 2016-02-24 11:59:12.294425]</span><br><span class="line">[2016-02-24 12:00:22,525: WARNING/MainProcess] Substantial drift from celery@centos7-185 may mean clocks are out of sync.  Current drift is</span><br><span class="line">65 seconds.  [orig: 2016-02-24 12:00:22.525489 recv: 2016-02-24 11:59:17.309409]</span><br></pre></td></tr></table></figure><p></p><p>字面看是由于时间不同步造成的，可是在settings里已经设置了<code>USE_TZ = True</code>以及相应的时区选项，经过一番费力的寻找发现造成这个问题的原因居然是每台机器的时间不同！至于为什么机器设置为同一时区却有时间差就不探究了，解决起来就是把各个机器的时间同步就可以了：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install ntpdate -y</span><br><span class="line">ntpdate 0.asia.pool.ntp.org</span><br></pre></td></tr></table></figure><p></p><p>网上很多Ntp服务器都失效了，可以使用下面的：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0.asia.pool.ntp.org</span><br><span class="line">1.asia.pool.ntp.org</span><br><span class="line">2.asia.pool.ntp.org</span><br><span class="line">3.asia.pool.ntp.org</span><br></pre></td></tr></table></figure><p></p><p>另外最好设置个计划任务定时去同步。</p><p><a href="/2016/02/24/解决flower-Substantial-drift-from-may-mean-clocks-are-out-of-sync错误/#post-footer" class="postShorten-excerpt_link link">评论和分享</a></p></div></div></article><article class="postShorten postShorten--thumbnailimg-right" itemscope itemtype="http://schema.org/BlogPosting"><div class="postShorten-wrap"><div class="postShorten-header"><h1 class="postShorten-title" itemprop="headline"><a class="link-unstyled" href="/2016/02/23/django-Celery-Rabbitmq-Flower使用小记/">Django+Celery+Rabbitmq+Flower使用小记</a></h1><div class="postShorten-meta"><time itemprop="datePublished" datetime="2016-02-23T15:30:02+08:00">2月 23, 2016 </time><span>发布在 </span><a class="category-link" href="/source/all-categories/Django/">Django</a></div></div><div class="postShorten-excerpt" itemprop="articleBody"><p>之前的博客中简单的介绍了celery的安装配置以及如何在python程序中使用，这里记录一下我使用django结合celery以及rabbitmq提供web服务，同时使用flower进行监控的过程。至于这几样东西是什么、怎么安装这里就不再细说了。</p><a href="/2016/02/23/django-Celery-Rabbitmq-Flower使用小记/" class="postShorten-excerpt_link link">阅读全文</a></div></div></article><article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemtype="http://schema.org/BlogPosting"><div class="postShorten-wrap"><div class="postShorten-header"><h1 class="postShorten-title" itemprop="headline"><a class="link-unstyled" href="/2015/11/20/django性能分析/">django性能分析</a></h1><div class="postShorten-meta"><time itemprop="datePublished" datetime="2015-11-20T18:13:57+08:00">11月 20, 2015 </time><span>发布在 </span><a class="category-link" href="/source/all-categories/Django/">Django</a></div></div><div class="postShorten-content" itemprop="articleBody"><p>一般情况我们使用django-debug-toolbar就能够看到每个步骤的耗时等信息，不过如果需要调试某个接口就不那么直观了，这种情况下我们可以使用下面的中间件来解决问题：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Orignal version taken from http://www.djangosnippets.org/snippets/186/</span></span><br><span class="line"><span class="comment"># Original author: udfalkso</span></span><br><span class="line"><span class="comment"># Modified by: Shwagroo Team and Gun.io</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> hotshot, hotshot.stats</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> StringIO</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line">words_re = re.compile( <span class="string">r'\s+'</span> )</span><br><span class="line">group_prefix_re = [</span><br><span class="line">    re.compile( <span class="string">"^.*/django/[^/]+"</span> ),</span><br><span class="line">    re.compile( <span class="string">"^(.*)/[^/]+$"</span> ), <span class="comment"># extract module path</span></span><br><span class="line">    re.compile( <span class="string">".*"</span> ),           <span class="comment"># catch strange entries</span></span><br><span class="line">]</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProfileMiddleware</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Displays hotshot profiling for any view.</span></span><br><span class="line"><span class="string">    http://yoursite.com/yourview/?prof</span></span><br><span class="line"><span class="string">    Add the "prof" key to query string by appending ?prof (or &amp;prof=)</span></span><br><span class="line"><span class="string">    and you'll see the profiling results in your browser.</span></span><br><span class="line"><span class="string">    It's set up to only be available in django's debug mode, is available for superuser otherwise,</span></span><br><span class="line"><span class="string">    but you really shouldn't add this middleware to any production configuration.</span></span><br><span class="line"><span class="string">    WARNING: It uses hotshot profiler which is not thread safe.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (settings.DEBUG <span class="keyword">or</span> request.user.is_superuser) <span class="keyword">and</span> <span class="string">'prof'</span> <span class="keyword">in</span> request.GET:</span><br><span class="line">            self.tmpfile = tempfile.mktemp()</span><br><span class="line">            self.prof = hotshot.Profile(self.tmpfile)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span><span class="params">(self, request, callback, callback_args, callback_kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (settings.DEBUG <span class="keyword">or</span> request.user.is_superuser) <span class="keyword">and</span> <span class="string">'prof'</span> <span class="keyword">in</span> request.GET:</span><br><span class="line">            <span class="keyword">return</span> self.prof.runcall(callback, request, *callback_args, **callback_kwargs)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_group</span><span class="params">(self, file)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> g <span class="keyword">in</span> group_prefix_re:</span><br><span class="line">            name = g.findall( file )</span><br><span class="line">            <span class="keyword">if</span> name:</span><br><span class="line">                <span class="keyword">return</span> name[<span class="number">0</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_summary</span><span class="params">(self, results_dict, sum)</span>:</span></span><br><span class="line">        list = [ (item[<span class="number">1</span>], item[<span class="number">0</span>]) <span class="keyword">for</span> item <span class="keyword">in</span> results_dict.items() ]</span><br><span class="line">        list.sort( reverse = <span class="literal">True</span> )</span><br><span class="line">        list = list[:<span class="number">40</span>]</span><br><span class="line">        res = <span class="string">"      tottime\n"</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> list:</span><br><span class="line">            res += <span class="string">"%4.1f%% %7.3f %s\n"</span> % ( <span class="number">100</span>*item[<span class="number">0</span>]/sum <span class="keyword">if</span> sum <span class="keyword">else</span> <span class="number">0</span>, item[<span class="number">0</span>], item[<span class="number">1</span>] )</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">summary_for_files</span><span class="params">(self, stats_str)</span>:</span></span><br><span class="line">        stats_str = stats_str.split(<span class="string">"\n"</span>)[<span class="number">5</span>:]</span><br><span class="line">        mystats = &#123;&#125;</span><br><span class="line">        mygroups = &#123;&#125;</span><br><span class="line">        sum = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> stats_str:</span><br><span class="line">            fields = words_re.split(s);</span><br><span class="line">            <span class="keyword">if</span> len(fields) == <span class="number">7</span>:</span><br><span class="line">                time = float(fields[<span class="number">2</span>])</span><br><span class="line">                sum += time</span><br><span class="line">                file = fields[<span class="number">6</span>].split(<span class="string">":"</span>)[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> file <span class="keyword">in</span> mystats:</span><br><span class="line">                    mystats[file] = <span class="number">0</span></span><br><span class="line">                mystats[file] += time</span><br><span class="line">                group = self.get_group(file)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> group <span class="keyword">in</span> mygroups:</span><br><span class="line">                    mygroups[ group ] = <span class="number">0</span></span><br><span class="line">                mygroups[ group ] += time</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;pre&gt;"</span> + \</span><br><span class="line">               <span class="string">" ---- By file ----\n\n"</span> + self.get_summary(mystats,sum) + <span class="string">"\n"</span> + \</span><br><span class="line">               <span class="string">" ---- By group ---\n\n"</span> + self.get_summary(mygroups,sum) + \</span><br><span class="line">               <span class="string">"&lt;/pre&gt;"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (settings.DEBUG <span class="keyword">or</span> request.user.is_superuser) <span class="keyword">and</span> <span class="string">'prof'</span> <span class="keyword">in</span> request.GET:</span><br><span class="line">            self.prof.close()</span><br><span class="line">            out = StringIO.StringIO()</span><br><span class="line">            old_stdout = sys.stdout</span><br><span class="line">            sys.stdout = out</span><br><span class="line">            stats = hotshot.stats.load(self.tmpfile)</span><br><span class="line">            stats.sort_stats(<span class="string">'time'</span>, <span class="string">'calls'</span>)</span><br><span class="line">            stats.print_stats()</span><br><span class="line">            sys.stdout = old_stdout</span><br><span class="line">            stats_str = out.getvalue()</span><br><span class="line">            <span class="keyword">if</span> response <span class="keyword">and</span> response.content <span class="keyword">and</span> stats_str:</span><br><span class="line">                response.content = <span class="string">"&lt;pre&gt;"</span> + stats_str + <span class="string">"&lt;/pre&gt;"</span></span><br><span class="line">            response.content = <span class="string">"\n"</span>.join(response.content.split(<span class="string">"\n"</span>)[:<span class="number">40</span>])</span><br><span class="line">            response.content += self.summary_for_files(stats_str)</span><br><span class="line">            os.unlink(self.tmpfile)</span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure><p>把这个文件保存为middleware.py，然后在settings.py中的MIDDLEWARE_CLASSES添加刚才写好的中间件<br><code>&#39;yourproject.yourapp.middleware.ProfileMiddleware&#39;</code>,<br>添加完成后，在原本要访问的url后添加’?prof’就可以看到性能分析结果了：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;pre&gt;         202188 function calls (182154 primitive calls) in 2.948 seconds</span><br><span class="line">   Ordered by: internal time, call count</span><br><span class="line">   ncalls  tottime  percall  cumtime  percall filename:lineno(function)</span><br><span class="line">      302    2.444    0.008    2.454    0.008 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/MySQLdb/cursors.py:277(_do_query)</span><br><span class="line">        2    0.086    0.043    0.104    0.052 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/MySQLdb/connections.py:62(__init__)</span><br><span class="line">        2    0.017    0.009    0.017    0.009 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/MySQLdb/connections.py:287(set_character_set)</span><br><span class="line">        2    0.016    0.008    0.016    0.008 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/django/db/backends/mysql/base.py:299(_set_autocommit)</span><br><span class="line">      302    0.008    0.000    2.488    0.008 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/django/db/backends/utils.py:76(execute)</span><br><span class="line">    19410    0.008    0.000    0.008    0.000 /usr/lib64/python2.7/copy.py:267(_keep_alive)</span><br><span class="line">    10237    0.008    0.000    0.008    0.000 /usr/lib64/python2.7/json/encoder.py:33(encode_basestring)</span><br><span class="line">      600    0.008    0.000    0.012    0.000 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/django/db/models/sql/query.py:246(clone)</span><br><span class="line">        6    0.007    0.001    0.007    0.001 /usr/lib64/python2.7/urlparse.py:336(unquote)</span><br><span class="line">      500    0.007    0.000    2.712    0.005 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/django/db/models/query.py:229(iterator)</span><br><span class="line">     1152    0.005    0.000    0.029    0.000 /usr/lib64/python2.7/copy.py:253(_deepcopy_dict)</span><br><span class="line">        1    0.005    0.005    0.014    0.014 /usr/lib64/python2.7/json/encoder.py:212(iterencode)</span><br><span class="line">      302    0.005    0.000    0.010    0.000 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/MySQLdb/cursors.py:117(_do_get_result)</span><br><span class="line">      300    0.005    0.000    0.121    0.000 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/django/db/models/sql/compiler.py:351(as_sql)</span><br><span class="line">      300    0.004    0.000    0.033    0.000 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/django/db/models/sql/query.py:1114(build_filter)</span><br><span class="line">      302    0.004    0.000    0.004    0.000 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/MySQLdb/cursors.py:313(_get_result)</span><br><span class="line">        1    0.003    0.003    0.017    0.017 /usr/lib64/python2.7/json/encoder.py:186(encode)</span><br><span class="line">     1300    0.003    0.000    0.004    0.000 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/django/db/backends/mysql/operations.py:176(get_db_converters)</span><br><span class="line">      600    0.003    0.000    0.006    0.000 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/django/db/models/sql/query.py:1334(names_to_path)</span><br><span class="line">      300    0.003    0.000    0.004    0.000 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/django/db/models/sql/query.py:110(__init__)</span><br><span class="line">      302    0.003    0.000    0.003    0.000 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/MySQLdb/cursors.py:82(_warning_check)</span><br><span class="line">      200    0.003    0.000    0.004    0.000 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/django/db/models/base.py:388(__init__)</span><br><span class="line">      302    0.003    0.000    2.469    0.008 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/MySQLdb/cursors.py:139(execute)</span><br><span class="line">      300    0.003    0.000    0.022    0.000 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/django/db/models/sql/compiler.py:155(get_select)</span><br><span class="line">      300    0.003    0.000    0.007    0.000 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/django/db/models/sql/compiler.py:472(get_default_columns)</span><br><span class="line">      908    0.003    0.000    0.003    0.000 /home/xsy/.virtualenvs/calc/lib64/python2.7/encodings/utf_8.py:15(decode)</span><br><span class="line">     3500    0.003    0.000    0.005    0.000 /home/xsy/.virtualenvs/calc/lib/python2.7/site-packages/django/db/models/sql/compiler.py:325(quote_name_unless_alias)</span><br><span class="line">&lt;pre&gt; ---- By file ----</span><br></pre></td></tr></table></figure><p></p><p>简单解释下主要的信息，ncalls是函数调用的次数，percall指调用一次所需时间，cumtime是运行时占用的总时间。比如percall时间很短而cumtime时间很长，则代表循环次数过多了，试着从算法角度进行优化;如果从输出中看到大量时间消耗和“sql”有关的，则试着从数据库相关代码优化;如果看见大量时间消耗和”template”有关，则尝试从模板渲染处着手优化。</p><p><a href="/2015/11/20/django性能分析/#post-footer" class="postShorten-excerpt_link link">评论和分享</a></p></div></div></article><article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemtype="http://schema.org/BlogPosting"><div class="postShorten-wrap"><div class="postShorten-header"><h1 class="postShorten-title" itemprop="headline"><a class="link-unstyled" href="/2015/04/09/django-userena使用记录/">django-userena使用记录</a></h1><div class="postShorten-meta"><time itemprop="datePublished" datetime="2015-04-09T17:31:47+08:00">4月 09, 2015 </time><span>发布在 </span><a class="category-link" href="/source/all-categories/Django/">Django</a></div></div><div class="postShorten-content" itemprop="articleBody"><p><a href="http://docs.django-userena.org/en/latest/installation.html" target="_blank" rel="noopener">django-userena</a>扩展了django原生的用户系统，提供了注册、登录、修改密码、邮件验证等一系列常用功能。直接使用pip安装即可：<code>pip install django-userena</code></p><p>会自动安装其所需的依赖包，不过个人建议为了更好的定制模板或相关功能，把这个包放到项目目录下当作一个app更方便一些。安装完成后修改settings.py，首先来创建一个app用于扩展用户系统<br><code>python manage.py startapp accounts</code><br>然后修改Models.py来扩展原生用户字段，我这里以添加用户等级为例：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> django.utils.translation <span class="keyword">import</span> ugettext <span class="keyword">as</span> _</span><br><span class="line"><span class="keyword">from</span> userena.models <span class="keyword">import</span> UserenaBaseProfile</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomerProfile</span><span class="params">(UserenaBaseProfile)</span>:</span></span><br><span class="line">    user = models.OneToOneField(User,</span><br><span class="line">                                unique=<span class="literal">True</span>,</span><br><span class="line">                                verbose_name=_(<span class="string">'user'</span>),</span><br><span class="line">                                related_name=<span class="string">'customer_profile'</span>)</span><br><span class="line">    level = models.IntegerField(_(<span class="string">u"用户等级"</span>), default=<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p></p><p>接下来修改settings.py，首先把<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;django.contrib.sites&quot;,</span><br><span class="line">&quot;accounts&quot;,</span><br><span class="line">&apos;userena&apos;,</span><br><span class="line">&apos;guardian&apos;,</span><br><span class="line">&apos;easy_thumbnails&apos;</span><br></pre></td></tr></table></figure><p></p><p>添加到INSTALLED_APPS中，然后把<code>&#39;django.contrib.sites.middleware.CurrentSiteMiddleware&#39;,</code><br>添加到MIDDLEWARE_CLASSES中，在django1.7.7中如果不添加和site有关的东西时，userena注册用户会抛出”Site matching query does not exist“异常。最后添加下面的配置：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">AUTHENTICATION_BACKENDS = (</span><br><span class="line">    <span class="string">'userena.backends.UserenaAuthenticationBackend'</span>,</span><br><span class="line">    <span class="string">'guardian.backends.ObjectPermissionBackend'</span>,</span><br><span class="line">    <span class="string">'django.contrib.auth.backends.ModelBackend'</span>,</span><br><span class="line">)</span><br><span class="line">EMAIL_HOST = <span class="string">'xxxx'</span></span><br><span class="line">EMAIL_HOST_USER = <span class="string">'xxxx@xxxx'</span></span><br><span class="line">EMAIL_HOST_PASSWORD = <span class="string">'xxxx'</span></span><br><span class="line">EMAIL_PORT = <span class="number">25</span></span><br><span class="line">DEFAULT_FROM_EMAIL = <span class="string">'xxxx@xxxx'</span></span><br><span class="line">ANONYMOUS_USER_ID = <span class="number">-1</span></span><br><span class="line">AUTH_PROFILE_MODULE = <span class="string">'accounts.CustomerProfile'</span></span><br><span class="line">USERENA_SIGNIN_REDIRECT_URL = <span class="string">'/accounts/%(username)s/'</span></span><br><span class="line">LOGIN_URL = <span class="string">'/accounts/signin/'</span></span><br><span class="line">LOGOUT_URL = <span class="string">'/accounts/signout/'</span></span><br></pre></td></tr></table></figure><p></p><p>xxxx根据实际情况修改，和发送验证邮件有关。这些都添加完毕后，执行<br><code>./manage.py migrate</code><br>创建数据库，接下来执行<br><code>./manage.py check_permissions</code><br>否则报错”Permission matching query does not exist“。最后记得添加url<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(<span class="string">r'^accounts/'</span>, include(<span class="string">'userena.urls'</span>)),</span><br></pre></td></tr></table></figure><p></p><p>都完成后，运行程序，访问<code>http://127.0.0.1:8000/accounts/signup/</code>就可以看见注册页面了。</p><p>所有html文件以及email模板都在<code>userena/templates/userena</code>路径下，进行相应定制即可。</p><p><a href="/2015/04/09/django-userena使用记录/#post-footer" class="postShorten-excerpt_link link">评论和分享</a></p></div></div></article><article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemtype="http://schema.org/BlogPosting"><div class="postShorten-wrap"><div class="postShorten-header"><h1 class="postShorten-title" itemprop="headline"><a class="link-unstyled" href="/2015/02/28/重写model的save方法实现同时写2个数据库/">重写model的save方法实现同时写2个数据库</a></h1><div class="postShorten-meta"><time itemprop="datePublished" datetime="2015-02-28T11:10:28+08:00">2月 28, 2015 </time><span>发布在 </span><a class="category-link" href="/source/all-categories/Django/">Django</a></div></div><div class="postShorten-content" itemprop="articleBody"><p>最近有个需求就是当执行save时需要把数据写入2个数据库，查看文档后发现直接重写save方法比较简单。</p><p>首先建立2个测试数据库testa和testb，然后在settings中配置数据库：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'testa'</span>,</span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'root'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'asdasd'</span>,</span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">'192.168.0.17'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'testdb'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'testb'</span>,</span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'root'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'asdasd'</span>,</span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">'192.168.0.18'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>接下来定义model：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ABCD</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">200</span>, unique=<span class="literal">False</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__unicode__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"%s"</span> % (self.name)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"save testa"</span></span><br><span class="line">        super(ABCD, self).save(*args, **kwargs)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"save testb"</span></span><br><span class="line">        super(ABCD, self).save(using=<span class="string">"testdb"</span>, *args, **kwargs)</span><br></pre></td></tr></table></figure><p></p><p>注意最后一行的using指定了写入哪个库中，接下来执行syncdb命令创建表，这里只会在default中创建，所以我们手动在testdb中创建表。</p><p>然后进入shell中测试一下：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">% python manage.py shell</span><br><span class="line">Python <span class="number">2.7</span><span class="number">.8</span> (default, Nov <span class="number">10</span> <span class="number">2014</span>, <span class="number">08</span>:<span class="number">19</span>:<span class="number">18</span>)</span><br><span class="line">Type <span class="string">"copyright"</span>, <span class="string">"credits"</span> <span class="keyword">or</span> <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">IPython <span class="number">2.3</span><span class="number">.0</span> -- An enhanced Interactive Python.</span><br><span class="line">?         -&gt; Introduction and overview of IPython's features.</span><br><span class="line">%quickref -&gt; Quick reference.</span><br><span class="line">help      -&gt; Python's own help system.</span><br><span class="line">object?   -&gt; Details about 'object', use 'object??' for extra details.</span><br><span class="line">In [<span class="number">1</span>]: <span class="keyword">from</span> abcd.models <span class="keyword">import</span> ABCD</span><br><span class="line">In [<span class="number">2</span>]: c = ABCD(name=<span class="string">"testc"</span>)</span><br><span class="line">In [<span class="number">3</span>]: c.save()</span><br><span class="line">save testa</span><br><span class="line">save testb</span><br></pre></td></tr></table></figure><p></p><p>再看数据库中，插入都成功了。这里可能产生的问题就是大量并发请求时造成主键的不一致，但对于写操作不频繁的情况下也是一种可以接受的选择。</p><p><a href="/2015/02/28/重写model的save方法实现同时写2个数据库/#post-footer" class="postShorten-excerpt_link link">评论和分享</a></p></div></div></article><article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemtype="http://schema.org/BlogPosting"><div class="postShorten-wrap"><div class="postShorten-header"><h1 class="postShorten-title" itemprop="headline"><a class="link-unstyled" href="/2014/09/27/Nginx-Uwsgi部署Django程序/">Nginx+Uwsgi部署Django程序</a></h1><div class="postShorten-meta"><time itemprop="datePublished" datetime="2014-09-27T17:44:03+08:00">9月 27, 2014 </time><span>发布在 </span><a class="category-link" href="/source/all-categories/Linux/">Linux</a></div></div><div class="postShorten-content" itemprop="articleBody"><p>原来使用apache进行部署，感觉内存占用大以及速度比较慢就换成了nginx+uwsgi的方式，结果完爆apache啊！</p><p>首先安装nginx以及uwsgi：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install nginx</span><br><span class="line">pip install uwsgi</span><br></pre></td></tr></table></figure><p></p><p>然后编辑uwsgi的配置文件，这里我使用ini文件格式，示例如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line">socket = 127.0.0.1:9000</span><br><span class="line">chdir = /var/www/html/test</span><br><span class="line">pidfile = /var/run/db_uwsgi.pid</span><br><span class="line">daemonize = /var/log/db_uwsgi.log</span><br><span class="line">wsgi-file = /var/www/html/test/wsgi.py</span><br><span class="line">processes = 4</span><br><span class="line">threads = 2</span><br><span class="line">stats = 127.0.0.1:9191</span><br></pre></td></tr></table></figure><p></p><p>根据实际情况修改程序目录、进程、线程，还有更高级的配置选项细节看uwsgi的文档。</p><p>启动：uwsgi ini路径</p><p>停止：uwsgi –stop pidfile路径</p><p>重起：uwsgi –reload pidfile路径</p><p>nginx配置示例如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen  800;</span><br><span class="line">        server_name     192.168.2.42 ;</span><br><span class="line">        access_log      /var/log/nginx-dc-access_log;</span><br><span class="line">        error_log       /var/log/nginx-dc-error.log;</span><br><span class="line">        charset         utf-8;</span><br><span class="line">        default_type    text/html;</span><br><span class="line">        proxy_set_header  Host      $host;</span><br><span class="line">        proxy_set_header  X-Real-IP  $remote_addr;</span><br><span class="line">        proxy_set_header  X-Forwarded-For $remote_addr;</span><br><span class="line">        set_real_ip_from   192.168.2.0/24;</span><br><span class="line">        set_real_ip_from   192.168.2.42;</span><br><span class="line">        real_ip_header     X-Real-IP;</span><br><span class="line">        location / &#123;</span><br><span class="line">                uwsgi_pass 127.0.0.1:9000;</span><br><span class="line">                include uwsgi_params;</span><br><span class="line">        &#125;</span><br><span class="line">        location /static &#123;</span><br><span class="line">                root /var/www/html/test;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p></p><p>更多高级配置请看nginx文档。</p><p>配置完成后启动nginx以及uwsgi即可：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service nginx start</span><br><span class="line">uwsgi test.ini</span><br><span class="line">[uWSGI] getting INI configuration from test.ini</span><br></pre></td></tr></table></figure><p></p><p>如果你需要使用脚本方式进行uwsgi的重启，记得stop后sleep3秒钟左右再启动，否则重启不一定成功。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;stop uwsgi&quot;</span><br><span class="line">uwsgi --stop /var/run/db_uwsgi.pid</span><br><span class="line">echo &quot;wait 5&apos;s&quot;</span><br><span class="line">sleep 5</span><br><span class="line">uwsgi /var/www/html/test/test.ini</span><br><span class="line">echo &quot;start uwsgi&quot;</span><br></pre></td></tr></table></figure><p></p><p><a href="/2014/09/27/Nginx-Uwsgi部署Django程序/#post-footer" class="postShorten-excerpt_link link">评论和分享</a></p></div></div></article><article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemtype="http://schema.org/BlogPosting"><div class="postShorten-wrap"><div class="postShorten-header"><h1 class="postShorten-title" itemprop="headline"><a class="link-unstyled" href="/2014/04/04/django自带的评论模块/">django自带的评论模块</a></h1><div class="postShorten-meta"><time itemprop="datePublished" datetime="2014-04-04T11:01:59+08:00">4月 04, 2014 </time><span>发布在 </span><a class="category-link" href="/source/all-categories/Django/">Django</a></div></div><div class="postShorten-content" itemprop="articleBody"><p>某个设计本来采用了一个比较不错的在线评论模块，不过答辩的时候丫居然不给网！！想偷个懒还是挺难啊….</p><p>那就用自带的评论模块吧，django版本是1.5.3。</p><p>首先把<code>&#39;django.contrib.comments&#39;</code>添加到INSTALLED_APPS中，然后添加url:<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = patterns(<span class="string">''</span>,</span><br><span class="line">......</span><br><span class="line">url(<span class="string">r'^comments/'</span>, include(<span class="string">'django.contrib.comments.urls'</span>)),</span><br><span class="line">......</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p></p><p>在需要显示评论的HTML中：<br></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load comments %&#125;</span><br><span class="line">&#123;% render_comment_list for post %&#125; &lt;!--显示所有属于这个文章的评论--&gt;</span><br><span class="line">&#123;% render_comment_form for post %&#125; &lt;!--显示自带的添加评论的form--&gt;</span><br></pre></td></tr></table></figure><p></p><p>不过自带的添加评论实在太丑了，我们可以自己改造一下：<br></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;% get_comment_form for post as form %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">'&#123;%comment_form_target%&#125;'</span> <span class="attr">method</span>=<span class="string">'post'</span>&gt;</span></span><br><span class="line">    &#123;% csrf_token %&#125;</span><br><span class="line">    &#123;&#123;form.object_pk&#125;&#125;</span><br><span class="line">    &#123;&#123;form.content_type&#125;&#125;</span><br><span class="line">    &#123;&#123;form.timestamp&#125;&#125;</span><br><span class="line">    &#123;&#123;form.security_hash&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"id_name"</span>&gt;</span>姓名（必填）：<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">id</span>=<span class="string">"id_name"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"id_email"</span>&gt;</span>邮箱（必填）：<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"email"</span> <span class="attr">id</span>=<span class="string">"id_email"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"id_url"</span>&gt;</span>网站（可选）：<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">id</span>=<span class="string">"id_url"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"id_comment"</span>&gt;</span>评论（必填）：<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">"id_comment"</span> <span class="attr">rows</span>=<span class="string">"10"</span> <span class="attr">cols</span>=<span class="string">"40"</span> <span class="attr">name</span>=<span class="string">"comment"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">"display:none;"</span>&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"id_honeypot"</span>&gt;</span>垃圾评论。<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"honeypot"</span> <span class="attr">id</span>=<span class="string">"id_honeypot"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"post"</span> <span class="attr">value</span>=<span class="string">"发表"</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'hidden'</span> <span class="attr">name</span>=<span class="string">'next'</span> <span class="attr">value</span>=<span class="string">"/blog/post/&#123;&#123;post.id&#125;&#125;"</span>/&gt;</span> <span class="comment">&lt;!--这个是提交后的重定向，使用软编码总报错...--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p></p><p>然后再进行CSS或者JS一类的特效美化就OK了。</p><p><a href="/2014/04/04/django自带的评论模块/#post-footer" class="postShorten-excerpt_link link">评论和分享</a></p></div></div></article><article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemtype="http://schema.org/BlogPosting"><div class="postShorten-wrap"><div class="postShorten-header"><h1 class="postShorten-title" itemprop="headline"><a class="link-unstyled" href="/2014/04/01/django中由类实例引起的小坑/">django中由类实例引起的小坑</a></h1><div class="postShorten-meta"><time itemprop="datePublished" datetime="2014-04-01T11:38:13+08:00">4月 01, 2014 </time><span>发布在 </span><a class="category-link" href="/source/all-categories/Django/">Django</a></div></div><div class="postShorten-content" itemprop="articleBody"><p>自己封装了一个logging在django中使用，结果发现输出的时候总是重复输出，比如：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">DEBUG---- 2014/03/31 10:38:13:</span><br><span class="line">!!</span><br><span class="line">DEBUG---- 2014/03/31 10:38:13:</span><br><span class="line">!!</span><br><span class="line">DEBUG---- 2014/03/31 10:38:13:</span><br><span class="line">!!</span><br><span class="line">DEBUG---- 2014/03/31 10:38:13:</span><br><span class="line">!!</span><br><span class="line">DEBUG---- 2014/03/31 10:38:13:</span><br><span class="line">140091903388560</span><br><span class="line">DEBUG---- 2014/03/31 10:38:13:</span><br><span class="line">140091903388560</span><br><span class="line">DEBUG---- 2014/03/31 10:38:13:</span><br><span class="line">140091903388560</span><br><span class="line">DEBUG---- 2014/03/31 10:38:13:</span><br><span class="line">140091903388560</span><br></pre></td></tr></table></figure><p></p><p>可以看出，id都是一样的。而且我查了一下，正好4个地方引入了mylog。mylog的完整代码见以前日志，这里给出导致错误的原因：<br><code>self.logger = logging.getLogger(__name__)</code></p><p>简单测试：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mlog = MyLog()</span><br><span class="line"><span class="keyword">print</span> id(mlog)</span><br><span class="line"><span class="keyword">print</span> id(mlog.logger)</span><br><span class="line">xmlog = MyLog()</span><br><span class="line"><span class="keyword">print</span> id(xmlog)</span><br><span class="line"><span class="keyword">print</span> id(xmlog.logger)</span><br></pre></td></tr></table></figure><p></p><p>结果如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">123456666</span><br><span class="line">123456789</span><br><span class="line">123457777</span><br><span class="line">123456789</span><br></pre></td></tr></table></figure><p></p><p>可以看出虽然类id不同，不过核心的logger却是一个。因为我们执行runserver后，<code>__name__</code>就确定为mylog了，所以不管我们引用的时候如何写，<code>__name__</code>不变则都指向了同一个logger。更简单的例子如下：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: x = <span class="number">1</span></span><br><span class="line">In [<span class="number">2</span>]: y = <span class="number">1</span></span><br><span class="line">In [<span class="number">3</span>]: id(x)</span><br><span class="line">Out[<span class="number">3</span>]: <span class="number">11279464</span></span><br><span class="line">In [<span class="number">4</span>]: id(y)</span><br><span class="line">Out[<span class="number">4</span>]: <span class="number">11279464</span></span><br></pre></td></tr></table></figure><p></p><p>更细节的原因可以看《python源码分析》。</p><p>改起来就让<code>__name__</code>不一样就解决了。比如：</p><p><code>self.logger = logging.getLogger(str(uuid.uuid4()))</code></p><p><a href="/2014/04/01/django中由类实例引起的小坑/#post-footer" class="postShorten-excerpt_link link">评论和分享</a></p></div></div></article><article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemtype="http://schema.org/BlogPosting"><div class="postShorten-wrap"><div class="postShorten-header"><h1 class="postShorten-title" itemprop="headline"><a class="link-unstyled" href="/2014/03/27/mysql-python-not-all-arguments-converted-during-string-formatting/">mysql-python:not all arguments converted during string formatting</a></h1><div class="postShorten-meta"><time itemprop="datePublished" datetime="2014-03-27T18:07:49+08:00">3月 27, 2014 </time><span>发布在 </span><a class="category-link" href="/source/all-categories/Python/">Python</a></div></div><div class="postShorten-content" itemprop="articleBody"><p>今天把django从1.5.5升级到了1.6.2，结果使用mysql-python查询数据库时候就报了这个错误：“not all arguments converted during string formatting”</p><p>貌似这个问题应该和django没什么关系，正好今天就看看mysql-python的源码吧。想看如何解决的请直接跳到最后。</p><p>查询部分简化后如下：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">posistion = "top"</span><br><span class="line">order = r"<span class="keyword">select</span> <span class="keyword">id</span>,p_name,p_explain,p_href <span class="keyword">from</span> pictures <span class="keyword">where</span> p_position = %s <span class="keyword">and</span> p_show = <span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> -<span class="keyword">id</span><span class="string">"</span></span><br><span class="line"><span class="string">self.cur.execute(order, position)</span></span><br></pre></td></tr></table></figure><p></p><p>mysql-python中execute函数：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(self, query, args=None)</span>:</span></span><br><span class="line">        <span class="string">"""Execute a query.</span></span><br><span class="line"><span class="string">        query -- string, query to execute on server</span></span><br><span class="line"><span class="string">        args -- optional sequence or mapping, parameters to use with query.</span></span><br><span class="line"><span class="string">        Note: If args is a sequence, then %s must be used as the</span></span><br><span class="line"><span class="string">        parameter placeholder in the query. If a mapping is used,</span></span><br><span class="line"><span class="string">        %(key)s must be used as the placeholder.</span></span><br><span class="line"><span class="string">        Returns long integer rows affected, if any</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">del</span> self.messages[:]</span><br><span class="line">        db = self._get_db()</span><br><span class="line">        <span class="keyword">if</span> isinstance(query, unicode):</span><br><span class="line">            query = query.encode(db.unicode_literal.charset)</span><br><span class="line">        <span class="keyword">if</span> args <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> isinstance(args, dict):</span><br><span class="line">                query = query % dict((key, db.literal(item))</span><br><span class="line">                                     <span class="keyword">for</span> key, item <span class="keyword">in</span> args.iteritems())</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                query = query % tuple([db.literal(item) <span class="keyword">for</span> item <span class="keyword">in</span> args]) <span class="comment">##########################这里！！</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = <span class="literal">None</span></span><br><span class="line">            r = self._query(query)</span><br><span class="line">        <span class="keyword">except</span> TypeError, m:</span><br><span class="line">            <span class="keyword">if</span> m.args[<span class="number">0</span>] <span class="keyword">in</span> (<span class="string">"not enough arguments for format string"</span>,</span><br><span class="line">                             <span class="string">"not all arguments converted"</span>):</span><br><span class="line">                self.messages.append((ProgrammingError, m.args[<span class="number">0</span>]))</span><br><span class="line">                self.errorhandler(self, ProgrammingError, m.args[<span class="number">0</span>])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.messages.append((TypeError, m))</span><br><span class="line">                self.errorhandler(self, TypeError, m)</span><br><span class="line">        <span class="keyword">except</span> (SystemExit, KeyboardInterrupt):</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            exc, value, tb = sys.exc_info()</span><br><span class="line">            <span class="keyword">del</span> tb</span><br><span class="line">            self.messages.append((exc, value))</span><br><span class="line">            self.errorhandler(self, exc, value)</span><br><span class="line">        self._executed = query</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self._defer_warnings: self._warning_check()</span><br><span class="line">        <span class="keyword">return</span> r</span><br></pre></td></tr></table></figure><p></p><p>错误地方就是后面加了#的语句。</p><p>可以看到，因为字符串也是可序列化的，所以一个字符串被拆分成了单个的字符进行db.literal()处理。这个db是什么呢？</p><p>往上找：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, connection)</span>:</span></span><br><span class="line">        <span class="keyword">from</span> weakref <span class="keyword">import</span> proxy</span><br><span class="line">        self.connection = proxy(connection)</span><br><span class="line">        self.description = <span class="literal">None</span></span><br><span class="line">        self.description_flags = <span class="literal">None</span></span><br><span class="line">        self.rowcount = <span class="number">-1</span></span><br><span class="line">        self.arraysize = <span class="number">1</span></span><br><span class="line">        self._executed = <span class="literal">None</span></span><br><span class="line">        self.lastrowid = <span class="literal">None</span></span><br><span class="line">        self.messages = []</span><br><span class="line">        self.errorhandler = connection.errorhandler</span><br><span class="line">        self._result = <span class="literal">None</span></span><br><span class="line">        self._warnings = <span class="number">0</span></span><br><span class="line">        self._info = <span class="literal">None</span></span><br><span class="line">        self.rownumber = <span class="literal">None</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_db</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.connection:</span><br><span class="line">            self.errorhandler(self, ProgrammingError, <span class="string">"cursor closed"</span>)</span><br><span class="line">        <span class="keyword">return</span> self.connection</span><br><span class="line">```        </span><br><span class="line">可以看出，这个db就是connection的一个弱引用。再进一步，这个connnection哪来的呢？</span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">open</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">""" 返回一个默认的数据库连接游标 """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        self.conn = MySQLdb.Connection(</span><br><span class="line">            self.db_ip,</span><br><span class="line">            self.db_un,</span><br><span class="line">            self.db_pd,</span><br><span class="line">            self.db_db,</span><br><span class="line">            charset=self.db_ch)</span><br><span class="line">        self.cur = self.conn.cursor()</span><br><span class="line">    <span class="keyword">except</span> MySQLdb.Error <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">print</span> e</span><br><span class="line">`</span><br></pre></td></tr></table></figure><p></p><p>mysqldb-python的connection.py中:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span><span class="params">(_mysql.connection)</span>:</span></span><br><span class="line">    <span class="string">"""MySQL Database Connection Object"""</span></span><br><span class="line">    default_cursor = cursors.Cursor</span><br></pre></td></tr></table></figure><p>那这个Cursor又是什么呢？</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cursor</span><span class="params">(CursorStoreResultMixIn, CursorTupleRowsMixIn,</span></span></span><br><span class="line"><span class="class"><span class="params">             BaseCursor)</span>:</span></span><br><span class="line">    <span class="string">"""This is the standard Cursor class that returns rows as tuples</span></span><br><span class="line"><span class="string">    and stores the result set in the client."""</span></span><br></pre></td></tr></table></figure><p>这个Cursor这些类的子类，其中最上面出错函数就是BaseCursor的一个方法。</p><p>有点跑偏，先看看那literal函数吧：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">literal</span><span class="params">(self, o)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> o,type(o)</span><br><span class="line">        <span class="keyword">print</span> self.encoders</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        If o is a single object, returns an SQL literal as a string.</span></span><br><span class="line"><span class="string">        If o is a non-string sequence, the items of the sequence are</span></span><br><span class="line"><span class="string">        converted and returned as a sequence.</span></span><br><span class="line"><span class="string">        Non-standard. For internal use; do not use this in your</span></span><br><span class="line"><span class="string">        applications.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> self.escape(o, self.encoders)</span><br></pre></td></tr></table></figure><p></p><p>print是我添加的，输出如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">t &lt;type &apos;str&apos;&gt;</span><br><span class="line">&#123;&lt;type &apos;instance&apos;&gt;: &lt;function Instance2Str at 0x17b3aa0&gt;, &lt;type &apos;set&apos;&gt;: &lt;function Set2Str at 0x17b3cf8&gt;, &lt;type &apos;long&apos;&gt;: &lt;function Thing2Str at 0x17b3de8&gt;, &lt;type &apos;bool&apos;&gt;: &lt;function Bool2Str at 0x17b3ed8&gt;, &lt;type &apos;unicode&apos;&gt;: &lt;function unicode_literal at 0x7f12e42c4230&gt;, &lt;type &apos;str&apos;&gt;: &lt;function string_literal at 0x7f12e42be2a8&gt;, &lt;type &apos;float&apos;&gt;: &lt;function Float2Str at 0x17b3c08&gt;, &lt;type &apos;list&apos;&gt;: &lt;function quote_tuple at 0x17b3938&gt;, &lt;type &apos;tuple&apos;&gt;: &lt;function quote_tuple at 0x17b3938&gt;, &lt;type &apos;array.array&apos;&gt;: &lt;function array2Str at 0x17b39b0&gt;, &lt;type &apos;NoneType&apos;&gt;: &lt;function None2NULL at 0x17b3b90&gt;, &lt;type &apos;datetime.datetime&apos;&gt;: &lt;function DateTime2literal at 0x17b30c8&gt;, &lt;type &apos;dict&apos;&gt;: &lt;built-in function escape_dict&gt;, &lt;type &apos;object&apos;&gt;: &lt;function Instance2Str at 0x17b3aa0&gt;, &lt;type &apos;int&apos;&gt;: &lt;function Thing2Str at 0x17b3de8&gt;, &lt;type &apos;datetime.timedelta&apos;&gt;: &lt;function DateTimeDelta2literal at 0x17b3140&gt;&#125;</span><br><span class="line">o &lt;type &apos;str&apos;&gt;</span><br><span class="line">&#123;&lt;type &apos;instance&apos;&gt;: &lt;function Instance2Str at 0x17b3aa0&gt;, &lt;type &apos;set&apos;&gt;: &lt;function Set2Str at 0x17b3cf8&gt;, &lt;type &apos;long&apos;&gt;: &lt;function Thing2Str at 0x17b3de8&gt;, &lt;type &apos;bool&apos;&gt;: &lt;function Bool2Str at 0x17b3ed8&gt;, &lt;type &apos;unicode&apos;&gt;: &lt;function unicode_literal at 0x7f12e42c4230&gt;, &lt;type &apos;str&apos;&gt;: &lt;function string_literal at 0x7f12e42be2a8&gt;, &lt;type &apos;float&apos;&gt;: &lt;function Float2Str at 0x17b3c08&gt;, &lt;type &apos;list&apos;&gt;: &lt;function quote_tuple at 0x17b3938&gt;, &lt;type &apos;tuple&apos;&gt;: &lt;function quote_tuple at 0x17b3938&gt;, &lt;type &apos;array.array&apos;&gt;: &lt;function array2Str at 0x17b39b0&gt;, &lt;type &apos;NoneType&apos;&gt;: &lt;function None2NULL at 0x17b3b90&gt;, &lt;type &apos;datetime.datetime&apos;&gt;: &lt;function DateTime2literal at 0x17b30c8&gt;, &lt;type &apos;dict&apos;&gt;: &lt;built-in function escape_dict&gt;, &lt;type &apos;object&apos;&gt;: &lt;function Instance2Str at 0x17b3aa0&gt;, &lt;type &apos;int&apos;&gt;: &lt;function Thing2Str at 0x17b3de8&gt;, &lt;type &apos;datetime.timedelta&apos;&gt;: &lt;function DateTimeDelta2literal at 0x17b3140&gt;&#125;</span><br><span class="line">p &lt;type &apos;str&apos;&gt;</span><br><span class="line">&#123;&lt;type &apos;instance&apos;&gt;: &lt;function Instance2Str at 0x17b3aa0&gt;, &lt;type &apos;set&apos;&gt;: &lt;function Set2Str at 0x17b3cf8&gt;, &lt;type &apos;long&apos;&gt;: &lt;function Thing2Str at 0x17b3de8&gt;, &lt;type &apos;bool&apos;&gt;: &lt;function Bool2Str at 0x17b3ed8&gt;, &lt;type &apos;unicode&apos;&gt;: &lt;function unicode_literal at 0x7f12e42c4230&gt;, &lt;type &apos;str&apos;&gt;: &lt;function string_literal at 0x7f12e42be2a8&gt;, &lt;type &apos;float&apos;&gt;: &lt;function Float2Str at 0x17b3c08&gt;, &lt;type &apos;list&apos;&gt;: &lt;function quote_tuple at 0x17b3938&gt;, &lt;type &apos;tuple&apos;&gt;: &lt;function quote_tuple at 0x17b3938&gt;, &lt;type &apos;array.array&apos;&gt;: &lt;function array2Str at 0x17b39b0&gt;, &lt;type &apos;NoneType&apos;&gt;: &lt;function None2NULL at 0x17b3b90&gt;, &lt;type &apos;datetime.datetime&apos;&gt;: &lt;function DateTime2literal at 0x17b30c8&gt;, &lt;type &apos;dict&apos;&gt;: &lt;built-in function escape_dict&gt;, &lt;type &apos;object&apos;&gt;: &lt;function Instance2Str at 0x17b3aa0&gt;, &lt;type &apos;int&apos;&gt;: &lt;function Thing2Str at 0x17b3de8&gt;, &lt;type &apos;datetime.timedelta&apos;&gt;: &lt;function DateTimeDelta2literal at 0x17b3140&gt;&#125;</span><br></pre></td></tr></table></figure><p></p><p>就像上面说的，”top”被拆分成了3个，可是我们语句中的占位符%s只有一个！所以报错 not all arguments converted during string formatting。最初这里我理解成了是哪里转化出了错误，最后醒悟这意思是因为占位符个数和传入参数个数不一样导致！英语不过关阿～不过以前怎么没报错呢？？奇怪……</p><p>解决办法有2个，简单的方法就是执行语句修改如下：<code>self.cur.execute(order, (position,)) #注意逗号。</code></p><p>更推荐的方法就是使用字典传值：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> show:</span><br><span class="line">    order = <span class="string">r"select id,p_name,p_explain,p_href from pictures where p_position = %(position)s and p_show = 1 order by -id"</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    order = <span class="string">r"select id,p_name,p_explain,p_href,p_uploaddate,p_show from pictures where p_position = %(position)s"</span></span><br><span class="line">self.cur.execute(order, &#123;<span class="string">'position'</span>: position&#125;)</span><br></pre></td></tr></table></figure><p></p><p>这样虽然多打了几个字母，不过却是一种最稳妥的方式，不用担心由于参数顺序造成错误了。</p><p>mysql-python源码写的狠帅阿!</p><p><a href="/2014/03/27/mysql-python-not-all-arguments-converted-during-string-formatting/#post-footer" class="postShorten-excerpt_link link">评论和分享</a></p></div></div></article><article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemtype="http://schema.org/BlogPosting"><div class="postShorten-wrap"><div class="postShorten-header"><h1 class="postShorten-title" itemprop="headline"><a class="link-unstyled" href="/2014/02/11/django数据库分库/">django数据库分库</a></h1><div class="postShorten-meta"><time itemprop="datePublished" datetime="2014-02-11T09:34:25+08:00">2月 11, 2014 </time><span>发布在 </span><a class="category-link" href="/source/all-categories/Django/">Django</a></div></div><div class="postShorten-content" itemprop="articleBody"><p>有些时候我们需要项目中的app访问不同的数据库，这时就要进行分库操作。</p><p>首先建立一个db_router.py，内容示例：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>, <span class="comment"># Add 'postgresql_psycopg2', 'postgresql', 'mysql', 'sqlite3' or 'oracle'.</span></span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'xxxx'</span>,                      <span class="comment"># Or path to database file if using sqlite3.</span></span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'root'</span>,                      <span class="comment"># Not used with sqlite3.</span></span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'123456'</span>,                  <span class="comment"># Not used with sqlite3.</span></span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">''</span>,                      <span class="comment"># Set to empty string for localhost. Not used with sqlite3.</span></span><br><span class="line">        <span class="string">'PORT'</span>: <span class="string">'3306'</span>,                      <span class="comment"># Set to empty string for default. Not used with sqlite3.</span></span><br><span class="line">        <span class="string">'OPTIONS'</span>: &#123;  </span><br><span class="line">                    <span class="string">'init_command'</span>: <span class="string">'SET storage_engine=MyISAM'</span>,  </span><br><span class="line">        &#125;,         </span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'analysis_db'</span>:&#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'analysis_qq'</span>,                      <span class="comment">#分析相关的操作用这个库</span></span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'root'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'123456'</span>,</span><br><span class="line">        <span class="string">'PORT'</span>:<span class="string">'3306'</span>,</span><br><span class="line">        <span class="string">'OPTIONS'</span>:&#123;</span><br><span class="line">                    <span class="string">'init_command'</span>: <span class="string">'SET storage_engine=MyISAM'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MasterSlaveRouter</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">db_for_read</span><span class="params">(self, model, **hints)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> model._meta.app_label == <span class="string">'analysisqq'</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'analysis_db'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'default'</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">db_for_write</span><span class="params">(self, model, **hints)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> model._meta.app_label == <span class="string">'analysisqq'</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'analysis_db'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'default'</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_relation</span><span class="params">(self, obj1, obj2, **hints)</span>:</span></span><br><span class="line">        db_list = (<span class="string">'default'</span>,<span class="string">'analysis_db'</span>,)</span><br><span class="line">        <span class="keyword">if</span> obj1._state.db <span class="keyword">in</span> db_list <span class="keyword">and</span> obj2._state.db <span class="keyword">in</span> db_list:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_syncdb</span><span class="params">(self, db, model)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> db == <span class="string">'analysis_db'</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">" in analysis db"</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">elif</span> db == <span class="string">'default'</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">DATABASE_ROUTERS = [<span class="string">'db_router.MasterSlaveRouter'</span>]</span><br></pre></td></tr></table></figure><p></p><p>然后在settings.py中删除和数据库相关的代码，添加<code>from db_router import *</code>,这样之后指定的app就会使用特定的库了。</p><p>注意，这里分库是针对于读写操作，以及default已经存在后的syncdb，如果说你想执行syncdb同时就在不同数据库建表，这样操作是无效的。知道怎么做的请告知!</p><p><a href="/2014/02/11/django数据库分库/#post-footer" class="postShorten-excerpt_link link">评论和分享</a></p></div></div></article><div class="pagination-bar"><ul class="pagination"><li class="pagination-prev"><a class="btn btn--default btn--small" href="/"><i class="fa fa-angle-left text-base icon-mr"></i> <span>上一页</span></a></li><li class="pagination-next"><a class="btn btn--default btn--small" href="/source/all-tags/django/page/3/"><span>下一页</span> <i class="fa fa-angle-right text-base icon-ml"></i></a></li><li class="pagination-number">第 2 页 共 3 页</li></ul></div></section><footer id="footer" class="main-content-wrap"><span class="copyrights">Copyrights &copy; 2019 Roy. All Rights Reserved.</span></footer></div></div><div id="about"><div id="about-card"><div id="about-btn-close"><i class="fa fa-remove"></i></div><img id="about-card-picture" src="/assets/images/my.jpg" alt="作者的图片"><h4 id="about-card-name">Roy</h4><div id="about-card-bio"><p>君以国士待我，我必以国士报君。</p></div><div id="about-card-job"><i class="fa fa-briefcase"></i><br><p>野生程序猿</p></div><div id="about-card-location"><i class="fa fa-map-marker"></i><br>China</div></div></div><div id="algolia-search-modal" class="modal-container"><div class="modal"><div class="modal-header"><span class="close-button"><i class="fa fa-close"></i></span> <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled"><span class="searchby-algolia-text text-color-light text-small">by</span> <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg"> </a><i class="search-icon fa fa-search"></i><form id="algolia-search-form"><input type="text" id="algolia-search-input" name="search" class="form-control input--large search-input" placeholder="Search "></form></div><div class="modal-body"><div class="no-result text-color-light text-center">没有找到文章</div><div class="results"><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/02/12/Ubuntu下Gogant的简易破墙术/"><h3 class="media-heading">Ubuntu下Gogant的简易破墙术</h3></a><span class="media-meta"><span class="media-date text-small">2013年2月12日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/10/31/python常用第三方库-转载/"><h3 class="media-heading">Python常用第三方库(转载)</h3></a><span class="media-meta"><span class="media-date text-small">2013年10月31日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/fedora19安装ar8161网卡驱动/"><h3 class="media-heading">fedora19安装ar8161网卡驱动</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/fedora19源，rpmforge，fastestmirror/"><h3 class="media-heading">fedora19源，rpmforge，fastestmirror</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/python中如何自定义解析域名/"><h3 class="media-heading">python中如何自定义解析域名</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/django版本更换/"><h3 class="media-heading">django版本更换</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/django-groundwork个人1-5-3修改版/"><h3 class="media-heading">django-groundwork个人1.5.3修改版</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/fedora19美化/"><h3 class="media-heading">fedora19美化</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/装饰器/"><h3 class="media-heading">装饰器</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div><div class="media"><div class="media-body"><a class="link-unstyled" href="http://www.hi-roy.com/2013/11/01/SVN常用操作/"><h3 class="media-heading">SVN常用操作</h3></a><span class="media-meta"><span class="media-date text-small">2013年11月1日</span></span><div class="media-content hide-xs font-merryweather"></div></div><div style="clear:both"></div><hr></div></div></div><div class="modal-footer"><p class="results-count text-medium" data-message-zero="没有找到文章" data-message-one="找到 1 篇文章" data-message-other="找到 {n} 篇文章">找到 226 篇文章</p></div></div></div><div id="cover" style="background-image:url(/assets/images/cover.jpg)"></div><script src="/assets/js/script-ivwiy10zeb8fifc4swnhkwneuk64y53w2scmdmtp8thi9cqfxh31aowtroaz.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment-with-locales.min.js"></script><script src="//cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script><script>var algoliaClient=algoliasearch("51U8PIBLP6","16909d9ce1780cda71113841864e7aa8"),algoliaIndex=algoliaClient.initIndex("my-blog")</script></body></html>