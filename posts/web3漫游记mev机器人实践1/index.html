<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Web3漫游记——MEV机器人实践1 - Hi~Roy!</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Web3漫游记——MEV机器人实践1" />
<meta property="og:description" content="今天开始进入技术同学最喜欢的代码环节，虽然前一篇文章《Web3漫游记——MEV套利技能树》主推Rust作为首选，但后续文章会以Golang为主。主要因为个人技术栈是Golang&#43;Python，用熟悉的语言可以更专注于MEV相关逻辑实现。而使用Golang而非Python则是为了顺便熟悉一下Geth这个库，为了后面做私有节点优化提前做一些准备。有其他语言编程基础的小伙伴看懂应该都不是问题，只不过用到的库以及语法可能略有差别而已。
另外提醒一下Python技术栈的小伙伴，截止到发文日期，Python3.11、web3.py-v6.9和web3-flashbots-v1.1.1的SDK目前有兼容性问题，使用python3.8可正常测试。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/web3%E6%BC%AB%E6%B8%B8%E8%AE%B0mev%E6%9C%BA%E5%99%A8%E4%BA%BA%E5%AE%9E%E8%B7%B51/" />
<meta property="article:published_time" content="2023-09-11T03:15:03+08:00" />
<meta property="article:modified_time" content="2023-09-11T03:15:03+08:00" />

		<meta itemprop="name" content="Web3漫游记——MEV机器人实践1">
<meta itemprop="description" content="今天开始进入技术同学最喜欢的代码环节，虽然前一篇文章《Web3漫游记——MEV套利技能树》主推Rust作为首选，但后续文章会以Golang为主。主要因为个人技术栈是Golang&#43;Python，用熟悉的语言可以更专注于MEV相关逻辑实现。而使用Golang而非Python则是为了顺便熟悉一下Geth这个库，为了后面做私有节点优化提前做一些准备。有其他语言编程基础的小伙伴看懂应该都不是问题，只不过用到的库以及语法可能略有差别而已。
另外提醒一下Python技术栈的小伙伴，截止到发文日期，Python3.11、web3.py-v6.9和web3-flashbots-v1.1.1的SDK目前有兼容性问题，使用python3.8可正常测试。">
<meta itemprop="datePublished" content="2023-09-11T03:15:03&#43;08:00" />
<meta itemprop="dateModified" content="2023-09-11T03:15:03&#43;08:00" />
<meta itemprop="wordCount" content="790">



<meta itemprop="keywords" content="web3,mev," />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/roy.css">

	<link rel="shortcut icon" href="/favicon.ico">
		
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-81207387-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="Roy&#39;s Blog" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/images/logo.png">
				</div><div class="logo__item logo__text">
					<div class="logo__title">Roy&#39;s Blog</div>
					<div class="logo__tagline">From the moment I first saw you, All the darkness turned to light.</div>
				</div>
		</a>
	</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/">
				
				<span class="menu__text">Home</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Web3漫游记——MEV机器人实践1</h1>
			<div class="post__meta meta"><div class="meta__item-author meta__item">
	<svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2 0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class="meta__text">Roy</span>
</div>
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2023-09-11T03:15:03&#43;08:00">2023-09-11</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/web3/" rel="category">Web3</a>, <a class="meta__link" href="/categories/mev/" rel="category">MEV</a>
	</span>
</div></div>
		</header><div class="content post__content clearfix">
			<p>今天开始进入技术同学最喜欢的代码环节，虽然前一篇文章<a href="https://www.hi-roy.com/posts/web3%E6%BC%AB%E6%B8%B8%E8%AE%B0mev%E5%A5%97%E5%88%A9%E6%8A%80%E8%83%BD%E6%A0%91/">《Web3漫游记——MEV套利技能树》</a>主推Rust作为首选，但后续文章会以Golang为主。主要因为个人技术栈是Golang+Python，用熟悉的语言可以更专注于MEV相关逻辑实现。而使用Golang而非Python则是为了顺便熟悉一下Geth这个库，为了后面做私有节点优化提前做一些准备。有其他语言编程基础的小伙伴看懂应该都不是问题，只不过用到的库以及语法可能略有差别而已。</p>
<p>另外提醒一下Python技术栈的小伙伴，截止到发文日期，<code>Python3.11</code>、<code>web3.py-v6.9</code>和<code>web3-flashbots-v1.1.1</code>的SDK目前有兼容性问题，使用python3.8可正常测试。</p>
<p>首先简单看一下目录结构：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">
├── README.md
├── .env
├── abi
│   ├── ERC20.json
│   ├── UniswapV2Factory.json
│   ├── UniswapV2Pair.json
│   ├── V2ArbBot.json
│   ├── WETH.json
│   └── erc20.go
├── go.mod
├── go.sum
└── main.go
</code></pre></div><p>这里为了简(tou)单(lan)就都写到<code>main.go</code>里了，并且没考虑各种异常情况和优化，大家真正写工程级别代码时注意一下细节。</p>
<h2 id="如何建立链接">如何建立链接</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#a6e22e">erc20</span> <span style="color:#e6db74">&#34;gevm/abi&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;math/big&#34;</span>
	<span style="color:#e6db74">&#34;math/rand&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
	<span style="color:#e6db74">&#34;strings&#34;</span>

	<span style="color:#e6db74">&#34;github.com/ethereum/go-ethereum&#34;</span>
	<span style="color:#e6db74">&#34;github.com/ethereum/go-ethereum/accounts/abi&#34;</span>
	<span style="color:#e6db74">&#34;github.com/ethereum/go-ethereum/common&#34;</span>
	<span style="color:#e6db74">&#34;github.com/ethereum/go-ethereum/core/types&#34;</span>
	<span style="color:#e6db74">&#34;github.com/ethereum/go-ethereum/crypto&#34;</span>
	<span style="color:#e6db74">&#34;github.com/ethereum/go-ethereum/ethclient&#34;</span>
	<span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/joho/godotenv/autoload&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ethclient</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;WSS_URL&#34;</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;connected!&#34;</span>)
}
</code></pre></div><p>其中<code>autoload</code>库会自动加载当前目录下<code>.env</code>文件到环境变量中，<code>.env</code>内容就是节点服务的http和ws连接地址，比如：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">HTTP_URL<span style="color:#f92672">=</span>https://eth-mainnet.g.alchemy.com/v2/<span style="color:#f92672">{</span>APIKEY<span style="color:#f92672">}</span>
WSS_URL<span style="color:#f92672">=</span>wss://eth-mainnet.g.alchemy.com/v2/<span style="color:#f92672">{</span>APIKEY<span style="color:#f92672">}</span>
</code></pre></div><p><strong>不要把任何APIKEY、私钥相关的硬编码到程序中，是一个非常重要的习惯。</strong></p>
<h2 id="如何监控最新的区块">如何监控最新的区块</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">subcribeNewBlock</span>(<span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ethclient</span>.<span style="color:#a6e22e">Client</span>) {
	<span style="color:#a6e22e">headers</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">Header</span>)
	<span style="color:#a6e22e">sub</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">SubscribeNewHead</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">headers</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">sub</span>.<span style="color:#a6e22e">Err</span>():
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">header</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">headers</span>:
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">header</span>.<span style="color:#a6e22e">Hash</span>())
			<span style="color:#a6e22e">calcNextBlockBaseFee</span>(<span style="color:#a6e22e">header</span>.<span style="color:#a6e22e">GasUsed</span>, <span style="color:#a6e22e">header</span>.<span style="color:#a6e22e">GasLimit</span>, <span style="color:#a6e22e">header</span>.<span style="color:#a6e22e">BaseFee</span>.<span style="color:#a6e22e">Uint64</span>())
		}
	}
}
</code></pre></div><p>由于我们的client使用的是ws连接，所以当有新的区块生成，<code>headers</code>这个channel就会收到数据，其定义如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Header represents a block header in the Ethereum blockchain.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Header</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ParentHash</span>  <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Hash</span>    <span style="color:#e6db74">`json:&#34;parentHash&#34;       gencodec:&#34;required&#34;`</span>
	<span style="color:#a6e22e">UncleHash</span>   <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Hash</span>    <span style="color:#e6db74">`json:&#34;sha3Uncles&#34;       gencodec:&#34;required&#34;`</span>
	<span style="color:#a6e22e">Coinbase</span>    <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Address</span> <span style="color:#e6db74">`json:&#34;miner&#34;`</span>
	<span style="color:#a6e22e">Root</span>        <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Hash</span>    <span style="color:#e6db74">`json:&#34;stateRoot&#34;        gencodec:&#34;required&#34;`</span>
	<span style="color:#a6e22e">TxHash</span>      <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Hash</span>    <span style="color:#e6db74">`json:&#34;transactionsRoot&#34; gencodec:&#34;required&#34;`</span>
	<span style="color:#a6e22e">ReceiptHash</span> <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Hash</span>    <span style="color:#e6db74">`json:&#34;receiptsRoot&#34;     gencodec:&#34;required&#34;`</span>
	<span style="color:#a6e22e">Bloom</span>       <span style="color:#a6e22e">Bloom</span>          <span style="color:#e6db74">`json:&#34;logsBloom&#34;        gencodec:&#34;required&#34;`</span>
	<span style="color:#a6e22e">Difficulty</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">big</span>.<span style="color:#a6e22e">Int</span>       <span style="color:#e6db74">`json:&#34;difficulty&#34;       gencodec:&#34;required&#34;`</span>
	<span style="color:#a6e22e">Number</span>      <span style="color:#f92672">*</span><span style="color:#a6e22e">big</span>.<span style="color:#a6e22e">Int</span>       <span style="color:#e6db74">`json:&#34;number&#34;           gencodec:&#34;required&#34;`</span>
	<span style="color:#a6e22e">GasLimit</span>    <span style="color:#66d9ef">uint64</span>         <span style="color:#e6db74">`json:&#34;gasLimit&#34;         gencodec:&#34;required&#34;`</span>
	<span style="color:#a6e22e">GasUsed</span>     <span style="color:#66d9ef">uint64</span>         <span style="color:#e6db74">`json:&#34;gasUsed&#34;          gencodec:&#34;required&#34;`</span>
	<span style="color:#a6e22e">Time</span>        <span style="color:#66d9ef">uint64</span>         <span style="color:#e6db74">`json:&#34;timestamp&#34;        gencodec:&#34;required&#34;`</span>
	<span style="color:#a6e22e">Extra</span>       []<span style="color:#66d9ef">byte</span>         <span style="color:#e6db74">`json:&#34;extraData&#34;        gencodec:&#34;required&#34;`</span>
	<span style="color:#a6e22e">MixDigest</span>   <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Hash</span>    <span style="color:#e6db74">`json:&#34;mixHash&#34;`</span>
	<span style="color:#a6e22e">Nonce</span>       <span style="color:#a6e22e">BlockNonce</span>     <span style="color:#e6db74">`json:&#34;nonce&#34;`</span>

	<span style="color:#75715e">// BaseFee was added by EIP-1559 and is ignored in legacy headers.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">BaseFee</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">big</span>.<span style="color:#a6e22e">Int</span> <span style="color:#e6db74">`json:&#34;baseFeePerGas&#34; rlp:&#34;optional&#34;`</span>

	<span style="color:#75715e">// WithdrawalsHash was added by EIP-4895 and is ignored in legacy headers.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">WithdrawalsHash</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Hash</span> <span style="color:#e6db74">`json:&#34;withdrawalsRoot&#34; rlp:&#34;optional&#34;`</span>

	<span style="color:#75715e">// BlobGasUsed was added by EIP-4844 and is ignored in legacy headers.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">BlobGasUsed</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">uint64</span> <span style="color:#e6db74">`json:&#34;blobGasUsed&#34; rlp:&#34;optional&#34;`</span>

	<span style="color:#75715e">// ExcessBlobGas was added by EIP-4844 and is ignored in legacy headers.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExcessBlobGas</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">uint64</span> <span style="color:#e6db74">`json:&#34;excessBlobGas&#34; rlp:&#34;optional&#34;`</span>
}
</code></pre></div><p>上面代码中我们简单的输出了一下区块的哈希值，然后去预估下一个区块的BaseGasFee。如果需要当前区块的所有交易信息，可以调用<code>client.BlockByHash(context.Background(), header.Hash())</code>函数，这里就不展开了。</p>
<h2 id="如何估算下一个区块的基础gasfee">如何估算下一个区块的基础GasFee</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">const</span> (
	<span style="color:#a6e22e">EIP1559_ELASTICITY_MULTIPLIER</span> = <span style="color:#ae81ff">2</span>
	<span style="color:#a6e22e">BASE_FEE_CHANGE_DENOMINATOR</span>   = <span style="color:#ae81ff">8</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">calcNextBlockBaseFee</span>(<span style="color:#a6e22e">gasUsed</span>, <span style="color:#a6e22e">gasLimit</span>, <span style="color:#a6e22e">baseFee</span> <span style="color:#66d9ef">uint64</span>) (<span style="color:#a6e22e">newBaseFee</span> <span style="color:#66d9ef">uint64</span>) {
	<span style="color:#75715e">// https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1559.md
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// https://github.com/foundry-rs/foundry/blob/master/crates/anvil/src/eth/fees.rs#L141
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">targetGasUsed</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gasLimit</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">EIP1559_ELASTICITY_MULTIPLIER</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">targetGasUsed</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">gasUsed</span> {
		<span style="color:#a6e22e">newBaseFee</span> = <span style="color:#a6e22e">baseFee</span>
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">gasUsed</span> &gt; <span style="color:#a6e22e">targetGasUsed</span> {
		<span style="color:#a6e22e">newBaseFee</span> = <span style="color:#a6e22e">baseFee</span> <span style="color:#f92672">+</span> ((<span style="color:#a6e22e">baseFee</span><span style="color:#f92672">*</span>(<span style="color:#a6e22e">gasUsed</span><span style="color:#f92672">-</span><span style="color:#a6e22e">targetGasUsed</span>))<span style="color:#f92672">/</span><span style="color:#a6e22e">targetGasUsed</span>)<span style="color:#f92672">/</span><span style="color:#a6e22e">BASE_FEE_CHANGE_DENOMINATOR</span>
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">newBaseFee</span> = <span style="color:#a6e22e">baseFee</span> <span style="color:#f92672">-</span> ((<span style="color:#a6e22e">baseFee</span><span style="color:#f92672">*</span>(<span style="color:#a6e22e">targetGasUsed</span><span style="color:#f92672">-</span><span style="color:#a6e22e">gasUsed</span>))<span style="color:#f92672">/</span><span style="color:#a6e22e">targetGasUsed</span>)<span style="color:#f92672">/</span><span style="color:#a6e22e">BASE_FEE_CHANGE_DENOMINATOR</span>
	}
	<span style="color:#a6e22e">newBaseFee</span> <span style="color:#f92672">+=</span> uint64(<span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Int63n</span>(<span style="color:#ae81ff">9</span>))
	<span style="color:#66d9ef">return</span>
}
</code></pre></div><p>还记得我们前面文章说的，面对同一个套利机会往往会有很多竞争者。给的Gas费越高，胜率越大。计算BaseFee的方法我这里参考了anvil库的算法，至于好奇那2个常量的可以去看看EIP1559协议，链接在注释里自取。</p>
<p>计算出来基础费用其实还是不够的，还需要加上优先费(PriorityFee，贿赂矿工的)，不过这个优先费我问了大佬说是调用三方接口获取的，可能是要基于历史数据+机器学习+神经网络进行预测吧，暂时先不考虑。</p>
<h2 id="如何监控内存池中pending的交易">如何监控内存池中Pending的交易</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">subcribePendingTransaction</span>(<span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ethclient</span>.<span style="color:#a6e22e">Client</span>) {
	<span style="color:#a6e22e">transactionsHash</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">string</span>)
	<span style="color:#a6e22e">sub</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Client</span>().<span style="color:#a6e22e">EthSubscribe</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">transactionsHash</span>, <span style="color:#e6db74">&#34;newPendingTransactions&#34;</span>)
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">sub</span>.<span style="color:#a6e22e">Err</span>():
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">txHash</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">transactionsHash</span>:
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">txHash</span>)
		}
	}
}
</code></pre></div><p>这里的逻辑和订阅最新的区块逻辑差不多，这里想多说一句的就是对于使用其他语言的小伙伴，获取Pending交易本质上就是一个特定参数的网络请求，比如：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">// initiate websocket stream first
wscat -c wss://eth-mainnet.g.alchemy.com/v2/demo

// <span style="color:#66d9ef">then</span> call subscription
<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;jsonrpc&#34;</span>:<span style="color:#e6db74">&#34;2.0&#34;</span>,<span style="color:#e6db74">&#34;id&#34;</span>: 2, <span style="color:#e6db74">&#34;method&#34;</span>: <span style="color:#e6db74">&#34;eth_subscribe&#34;</span>, <span style="color:#e6db74">&#34;params&#34;</span>: <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;newPendingTransactions&#34;</span><span style="color:#f92672">]}</span>
</code></pre></div><p>如果没有对应的轮子自己造一个也不是很难。</p>
<h2 id="如何解析交易中data字段">如何解析交易中Data字段</h2>
<p>当我们拿到一个请求的哈希之后，怎么知道这个交易在做什么呢？此时就需要ABI登场了，对于大多数开源合约来说，在对应链的区块链浏览器上都可以直接看到合约对应的ABI，通常是JSON格式，比如：
<img src="https://ata2-img.oss-cn-zhangjiakou.aliyuncs.com/neweditor/b3732d19-8468-47bb-b47b-8c0fd86fcc43.png" alt="abi"></p>
<p>此外，还可以将开源合约代码下载到本地自行编译生成。</p>
<p>这里以<code>ERC20</code>为例来解析:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">parseERC20Transaction</span>(<span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ethclient</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">txHash</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#e6db74">&#34;./abi/ERC20.json&#34;</span>)
	<span style="color:#a6e22e">erc20Abi</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">abi</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">NewReader</span>(string(<span style="color:#a6e22e">ctx</span>)))
	<span style="color:#a6e22e">tx</span>, <span style="color:#a6e22e">isPending</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">TransactionByHash</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">HexToHash</span>(<span style="color:#a6e22e">txHash</span>))
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">Data</span>()) &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#75715e">// 使用前4字节去找对应的函数名字
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">method</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">erc20Abi</span>.<span style="color:#a6e22e">MethodById</span>(<span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">Data</span>()[:<span style="color:#ae81ff">4</span>])
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Tx is not erc20 protocol&#34;</span>)
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">method</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">isPending</span>)
			<span style="color:#75715e">// 后面的字节就是对应函数的参数
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">input</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">method</span>.<span style="color:#a6e22e">Inputs</span>.<span style="color:#a6e22e">Unpack</span>(<span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">Data</span>()[<span style="color:#ae81ff">4</span>:])
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">input</span>, <span style="color:#a6e22e">err</span>)
		}
	}
}
</code></pre></div><p>代码也很清晰，首先根据json内容生成abi对象，然后获取交易内容并根据data字段进行解析，获取函数名和inputData参数——也就是区块链浏览器上显示的inputData字段：
<img src="https://ata2-img.oss-cn-zhangjiakou.aliyuncs.com/neweditor/f521f7c2-6ed1-4743-a8fd-7a453fc54735.png" alt="inputdata"></p>
<h2 id="如何监控pair创建">如何监控Pair创建</h2>
<p>其实这里应该分2个部分，首先是同步历史已经创建的Pair：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">syncPairCreate</span>(<span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ethclient</span>.<span style="color:#a6e22e">Client</span>) {
	<span style="color:#75715e">// 以太坊UniswapV2-FactoryContrace地址
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">address</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">HexToAddress</span>(<span style="color:#e6db74">&#34;0x5c69bee701ef814a2b6a3edd4b1652cb9cc5aa6f&#34;</span>)
	<span style="color:#a6e22e">filter</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ethereum</span>.<span style="color:#a6e22e">FilterQuery</span>{
		<span style="color:#a6e22e">FromBlock</span>: <span style="color:#a6e22e">big</span>.<span style="color:#a6e22e">NewInt</span>(<span style="color:#ae81ff">10000835</span>),      <span style="color:#75715e">// 合约在这个区块部署
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">ToBlock</span>:   <span style="color:#a6e22e">big</span>.<span style="color:#a6e22e">NewInt</span>(<span style="color:#ae81ff">10091985</span>),      <span style="color:#75715e">// 数据过多会报错，这里限制一下
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Addresses</span>: []<span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Address</span>{<span style="color:#a6e22e">address</span>}, <span style="color:#75715e">// 过滤只要这个合约地址的数据
</span><span style="color:#75715e"></span>	}
	<span style="color:#a6e22e">logs</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">FilterLogs</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">filter</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#e6db74">&#34;./abi/UniswapV2Factory.json&#34;</span>)
	<span style="color:#a6e22e">factoryAbi</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">abi</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">NewReader</span>(string(<span style="color:#a6e22e">ctx</span>)))
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">logs</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Data</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">TxHash</span>)
		<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">factoryAbi</span>.<span style="color:#a6e22e">Unpack</span>(<span style="color:#e6db74">&#34;PairCreated&#34;</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Data</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
		}
		<span style="color:#a6e22e">token0</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">HexToAddress</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Topics</span>[<span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">Hex</span>())
		<span style="color:#a6e22e">token1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">HexToAddress</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Topics</span>[<span style="color:#ae81ff">2</span>].<span style="color:#a6e22e">Hex</span>())
		<span style="color:#a6e22e">pairAddrss</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">data</span>[<span style="color:#ae81ff">0</span>]
		<span style="color:#a6e22e">pairNum</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">data</span>[<span style="color:#ae81ff">1</span>]
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">token0</span>, <span style="color:#a6e22e">token1</span>, <span style="color:#a6e22e">pairAddrss</span>, <span style="color:#a6e22e">pairNum</span>)
	}
}
</code></pre></div><p>简单说，首先我们需要找到链上的合约地址以及对应的ABI，然后根据实际需求构造<code>FilterQuery</code>结构，最后调用接口获取日志。在实际使用中有个需要注意的地方就是<code>ToBlock</code>的值，由于这个合约已经部署很久了，如果不进行限制的话日志量过大会报错，所以真正使用时候要切分并行获取。</p>
<p>关于数据解析部分，这里我们获取的是事件日志，和上面解析交易的数据不同。</p>
<p>还是以上面的为例，<code>UniswapV2factory</code>合约对应的<code>PairCreated</code>事件ABI如下(注意这里是<code>PairCreated</code>事件，不是<code>createPair</code>函数)：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
	<span style="color:#f92672">&#34;anonymous&#34;</span>: <span style="color:#66d9ef">false</span>,
	<span style="color:#f92672">&#34;inputs&#34;</span>: [
		{
			<span style="color:#f92672">&#34;indexed&#34;</span>: <span style="color:#66d9ef">true</span>,
			<span style="color:#f92672">&#34;internalType&#34;</span>: <span style="color:#e6db74">&#34;address&#34;</span>,
			<span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;token0&#34;</span>,
			<span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;address&#34;</span>
		},
		{
			<span style="color:#f92672">&#34;indexed&#34;</span>: <span style="color:#66d9ef">true</span>,
			<span style="color:#f92672">&#34;internalType&#34;</span>: <span style="color:#e6db74">&#34;address&#34;</span>,
			<span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;token1&#34;</span>,
			<span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;address&#34;</span>
		},
		{
			<span style="color:#f92672">&#34;indexed&#34;</span>: <span style="color:#66d9ef">false</span>,
			<span style="color:#f92672">&#34;internalType&#34;</span>: <span style="color:#e6db74">&#34;address&#34;</span>,
			<span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;pair&#34;</span>,
			<span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;address&#34;</span>
		},
		{
			<span style="color:#f92672">&#34;indexed&#34;</span>: <span style="color:#66d9ef">false</span>,
			<span style="color:#f92672">&#34;internalType&#34;</span>: <span style="color:#e6db74">&#34;uint256&#34;</span>,
			<span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
			<span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;uint256&#34;</span>
		}
	],
	<span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;PairCreated&#34;</span>,
	<span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;event&#34;</span>
}
</code></pre></div><p>首先<code>Topics</code>中第0个元素永远是名字+参数经过keccak计算后的值，然后<code>indexed=true</code>的字段会按照顺序依次存在<code>Topics</code>字段里，而值为<code>false</code>的数据则会存储在<code>Data</code>字段，需要使用对应的ABI进行解析。</p>
<p>当同步完历史数据，一般会记录在数据库或者文件里，然后开是监听新Pair创建事件：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">subcribeNewPairCreated</span>(<span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ethclient</span>.<span style="color:#a6e22e">Client</span>) {
	<span style="color:#a6e22e">nameHash</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">crypto</span>.<span style="color:#a6e22e">Keccak256Hash</span>([]byte(<span style="color:#e6db74">&#34;PairCreated(address,address,address,uint256)&#34;</span>))
	<span style="color:#a6e22e">filters</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ethereum</span>.<span style="color:#a6e22e">FilterQuery</span>{
		<span style="color:#a6e22e">FromBlock</span>: <span style="color:#a6e22e">big</span>.<span style="color:#a6e22e">NewInt</span>(<span style="color:#ae81ff">18069579</span>), <span style="color:#75715e">// 示例，以实际运行是获取的最新区块为准，怎么获得见上面
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Topics</span>: [][]<span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Hash</span>{
			{<span style="color:#a6e22e">nameHash</span>},
		},
	}
	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#e6db74">&#34;./abi/UniswapV2Factory.json&#34;</span>)
	<span style="color:#a6e22e">factoryAbi</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">abi</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">NewReader</span>(string(<span style="color:#a6e22e">ctx</span>)))
	<span style="color:#a6e22e">logs</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">Log</span>)
	<span style="color:#a6e22e">sub</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">SubscribeFilterLogs</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">filters</span>, <span style="color:#a6e22e">logs</span>)
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">sub</span>.<span style="color:#a6e22e">Err</span>():
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">logs</span>:
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">TxHash</span>)
			<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">factoryAbi</span>.<span style="color:#a6e22e">Unpack</span>(<span style="color:#e6db74">&#34;PairCreated&#34;</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Data</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
			}
			<span style="color:#a6e22e">token0</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">HexToAddress</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Topics</span>[<span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">Hex</span>())
			<span style="color:#a6e22e">token1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">HexToAddress</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Topics</span>[<span style="color:#ae81ff">2</span>].<span style="color:#a6e22e">Hex</span>())
			<span style="color:#a6e22e">pairAddrss</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">data</span>[<span style="color:#ae81ff">0</span>]
			<span style="color:#a6e22e">pairNum</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">data</span>[<span style="color:#ae81ff">1</span>]
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">token0</span>, <span style="color:#a6e22e">token1</span>, <span style="color:#a6e22e">pairAddrss</span>, <span style="color:#a6e22e">pairNum</span>)
		}
	}
}
</code></pre></div><p>这里我们之所以能够使用<code>Topics</code>作为过滤条件，就是因为上面说的所有事件日志的<code>Topics[0]</code>都是函数名+参数的keccak哈希值，这样就能过滤出所有新创建的Pair了。其实使用上面基于合约地址的条件进行过滤也可以，这里主要想给出另一种过滤方式，毕竟技多不压身。</p>
<p>说到这，喜欢冲土狗的小伙伴是不是脑海中出现了什么想法？懂的都懂，但还是注意别有个新池子就冲，记得结合其他数据分析一下，比如下面的Reserves。</p>
<h2 id="如何监控reserves">如何监控Reserves</h2>
<p>有了上面的基础，监控Reservers就是换个事件日志和ABI的事。根据<a href="https://docs.uniswap.org/contracts/v2/reference/smart-contracts/pair">UniswapV2文档</a>，监控<code>UniswapV2Pair</code>合约中<code>Sync</code>事件即可：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">subcribeSyncEvent</span>(<span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ethclient</span>.<span style="color:#a6e22e">Client</span>) {
	<span style="color:#a6e22e">nameHash</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">crypto</span>.<span style="color:#a6e22e">Keccak256Hash</span>([]byte(<span style="color:#e6db74">&#34;Sync(uint112,uint112)&#34;</span>))
	<span style="color:#a6e22e">filters</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ethereum</span>.<span style="color:#a6e22e">FilterQuery</span>{
		<span style="color:#a6e22e">FromBlock</span>: <span style="color:#a6e22e">big</span>.<span style="color:#a6e22e">NewInt</span>(<span style="color:#ae81ff">18069579</span>), <span style="color:#75715e">// 示例，以实际运行是获取的最新区块为准，怎么获得见上面
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">Topics</span>: [][]<span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">Hash</span>{
			{<span style="color:#a6e22e">nameHash</span>},
		},
	}
	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">ReadFile</span>(<span style="color:#e6db74">&#34;./abi/UniswapV2Pair.json&#34;</span>)
	<span style="color:#a6e22e">pairAbi</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">abi</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">NewReader</span>(string(<span style="color:#a6e22e">ctx</span>)))
	<span style="color:#a6e22e">logs</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">Log</span>)
	<span style="color:#a6e22e">sub</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">SubscribeFilterLogs</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">filters</span>, <span style="color:#a6e22e">logs</span>)
	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">select</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">sub</span>.<span style="color:#a6e22e">Err</span>():
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">l</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">logs</span>:
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">TxHash</span>)
			<span style="color:#a6e22e">data</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pairAbi</span>.<span style="color:#a6e22e">Unpack</span>(<span style="color:#e6db74">&#34;Sync&#34;</span>, <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Data</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalln</span>(<span style="color:#a6e22e">err</span>)
			}
			<span style="color:#a6e22e">pairAddr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Address</span>.<span style="color:#a6e22e">Hex</span>()
			<span style="color:#a6e22e">reserves0</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">data</span>[<span style="color:#ae81ff">0</span>]
			<span style="color:#a6e22e">reserves1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">data</span>[<span style="color:#ae81ff">1</span>]
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">pairAddr</span>, <span style="color:#a6e22e">reserves0</span>, <span style="color:#a6e22e">reserves1</span>)
		}
	}
}
</code></pre></div><p>不多解释了，这里如果想针对于某个Pair来监控，添加<code>Addresses</code>过滤条件即可。不过这里建议有兴趣的去看看<code>ethereum.FilterQuery</code>支持的条件，后面可以高效的进行组合过滤。</p>
<h2 id="如何调用合约">如何调用合约</h2>
<p>最后说说如何与合约进行交互，Python直接有ABI的JSON文件进行反序列化就可以了，而在Golang里则需要使用<code>abigen</code>来生成对应的go文件。首先要找到<code>go-ethereum</code>源码包的位置或者从github下载，然后进入<code>cmd/abigen</code>目录去自己<code>go build</code>，然后到<code>abi</code>目录执行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">abigen --abi<span style="color:#f92672">=</span>ERC20.json  --pkg<span style="color:#f92672">=</span>abi --out<span style="color:#f92672">=</span>erc20.go --alias _totalSupply<span style="color:#f92672">=</span>totalSupply1
</code></pre></div><p>注意这里的<code>--alias</code>参数，由于这个程序不能自动处理下划线，不加这个参数会报错。另外不同的JSON文件生成go代码时，<code>pkg</code>参数也不能一样，否则会报函数已存在一类的错误，这点真是比Python差远了。</p>
<p>生成go文件后就当普通的包使用，如果报错无法import一类的，执行<code>go mod tidy</code>即可。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// import erc20 &#34;gevm/abi&#34;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getTokenDecimals</span>(<span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ethclient</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">tokenAddr</span> <span style="color:#66d9ef">string</span>) {
	<span style="color:#a6e22e">tokenAddr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">common</span>.<span style="color:#a6e22e">HexToAddress</span>(<span style="color:#a6e22e">tokenAddr</span>)
	<span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">erc20</span>.<span style="color:#a6e22e">NewErc20</span>(<span style="color:#a6e22e">tokenAddr</span>, <span style="color:#a6e22e">client</span>)
	<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Decimals</span>(<span style="color:#66d9ef">nil</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">i</span>)
}
</code></pre></div><p>上面的例子就是传入一个token的合约地址，然后调用<code>Decimals()</code>获取精度，其他的用法都差不多不多说了。</p>
<h2 id="参考文档">参考文档</h2>
<ul>
<li><a href="https://geth.ethereum.org/docs">go-ethereum</a></li>
<li><a href="https://github.com/Uniswap/v2-core">uniswap-v2core</a></li>
<li><a href="https://github.com/Uniswap/v2-periphery">uniswap-v2periphery</a></li>
</ul>
<hr>


<p align="center">
  <img src="/images/wechat.jpg" alt='wechat'/>
</p>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/web3/" rel="tag">web3</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/mev/" rel="tag">mev</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Roy avatar" src="/images/my.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Roy</span>
	</div>
	<div class="authorbox__description">
		野生程序猿，略懂Python，略懂Golang，略懂云计算，略懂大数据，略懂拳击游泳钓鱼，略懂钢琴吉他摄影。
	</div>
</div>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/web3%E6%BC%AB%E6%B8%B8%E8%AE%B0mev%E5%A5%97%E5%88%A9%E6%8A%80%E8%83%BD%E6%A0%91/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Web3漫游记——MEV套利技能树</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/tg%E6%B8%B8%E6%88%8F%E8%87%AA%E5%8A%A8%E5%8C%96%E7%9A%84%E4%B8%80%E7%A7%8D%E6%80%9D%E8%B7%AF/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">TG游戏自动化的一种思路</p>
		</a>
	</div>
</nav>

<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "www-hi-roy-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
<div class="footer__links">
	<a class="footer__link" href="/about/">About</a>
</div>
		<div class="footer__copyright">
			&copy; 2024 Roy.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>